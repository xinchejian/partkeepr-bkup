
Ext.namespace('PartKeepr');PartKeepr.application=null;Ext.application({name:'PartKeepr',launch:function(){Ext.get("loading").hide();Ext.setLocale('en_US');this.createLayout();PartKeepr.application=this;PartKeepr.setMaxUploadSize(window.parameters.maxUploadSize);PartKeepr.setAvailableImageFormats(window.parameters.availableImageFormats);this.sessionManager=new PartKeepr.SessionManager();if(window.parameters.auto_start_session){this.getSessionManager().setSession(window.parameters.auto_start_session);this.getStatusbar().connectionButton.hide();this.onLogin();}else{this.sessionManager.on("login",this.onLogin,this);if(window.parameters.autoLoginUsername){this.sessionManager.login(window.parameters.autoLoginUsername,window.parameters.autoLoginPassword);}else{this.sessionManager.login();}}
Ext.fly(document.body).on('contextmenu',this.onContextMenu,this);},getPartManager:function(){return this.partManager;},onContextMenu:function(e,target){if(!e.ctrlKey){e.preventDefault();}},onLogin:function(){this.createGlobalStores();if(window.parameters.userPreferences){PartKeepr.getApplication().setInitialUserPreferences(window.parameters.userPreferences);}
if(PartKeepr.initialUserPreferences){var records=this.getUserPreferenceStore().getProxy().getReader().read(PartKeepr.initialUserPreferences);this.getUserPreferenceStore().loadRecords(records.records);}
this.reloadStores();this.createPartManager();this.menuBar.enable();this.doSystemStatusCheck();this.doUnacknowledgedNoticesCheck();this.displayTipWindowTask=new Ext.util.DelayedTask(this.displayTipOfTheDayWindow,this);this.displayTipWindowTask.delay(100);this.setSession(this.getSessionManager().getSession());this.getStatusbar().getConnectionButton().setConnected();},recreatePartManager:function(){this.centerPanel.remove(this.partManager);this.getPartManager().destroy();this.createPartManager();},createPartManager:function(){this.partManager=Ext.create("PartKeepr.PartManager",{title:i18n("Part Manager"),compactLayout:PartKeepr.getApplication().getUserPreference("partkeepr.partmanager.compactlayout",false),iconCls:'icon-brick',closable:false});this.centerPanel.insert(0,this.partManager);},setInitialUserPreferences:function(obj){PartKeepr.initialUserPreferences=obj;},displayTipOfTheDayWindow:function(){if(!this.tipOfTheDayStore._loaded){this.displayTipWindowTask.delay(100);return;}
if(PartKeepr.getApplication().getUserPreference("partkeepr.tipoftheday.showtips")!==false){var j=Ext.create("PartKeepr.TipOfTheDayWindow");if(j.getLastUnreadTip()!==null){j.show();}}},doSystemStatusCheck:function(){var call=new PartKeepr.ServiceCall("System","getSystemStatus");call.setHandler(Ext.bind(this.onSystemStatusCheck,this));call.doCall();},onSystemStatusCheck:function(data){if(data.data.schemaStatus!=="complete"){alert(i18n("Your database schema is not up-to-date! Please re-run setup immediately!"));}
if(data.data.inactiveCronjobCount>0){alert(i18n("The following cronjobs aren't running:")+"\n\n"+data.data.inactiveCronjobs.join("\n"));}},getSessionManager:function(){return this.sessionManager;},doUnacknowledgedNoticesCheck:function(){if(this.getSessionManager().getSession()!==null){var call=new PartKeepr.ServiceCall("SystemNotice","hasUnacknowledgedNotices");call.setHandler(Ext.bind(this.onUnacknowledgedNoticesCheck,this));call.doCall();}},onUnacknowledgedNoticesCheck:function(data){if(data.data.unacknowledgedNotices===true){this.statusBar.systemNoticeButton.show();}else{this.statusBar.systemNoticeButton.hide();}
Ext.defer(this.doUnacknowledgedNoticesCheck,10000,this);},logout:function(){this.menuBar.disable();this.centerPanel.removeAll(true);this.getSessionManager().logout();},raiseRuntimeError:function(error){var exception={message:i18n("Runtime Error"),detail:error};PartKeepr.ExceptionWindow.showException(exception);},createGlobalStores:function(){this.footprintStore=Ext.create("Ext.data.Store",{model:'PartKeepr.Footprint',pageSize:-1,autoLoad:false});this.siPrefixStore=Ext.create("Ext.data.Store",{model:'PartKeepr.SiPrefix',pageSize:-1,autoLoad:true});this.distributorStore=Ext.create("Ext.data.Store",{model:'PartKeepr.Distributor',pageSize:-1,autoLoad:false});this.manufacturerStore=Ext.create("Ext.data.Store",{model:'PartKeepr.Manufacturer',pageSize:-1,autoLoad:false});this.partUnitStore=Ext.create("Ext.data.Store",{model:'PartKeepr.PartUnit',pageSize:-1,autoLoad:false});this.unitStore=Ext.create("Ext.data.Store",{model:'PartKeepr.Unit',pageSize:-1,autoLoad:false});this.userStore=Ext.create("Ext.data.Store",{model:'PartKeepr.User',pageSize:-1,autoLoad:false});this.tipOfTheDayStore=Ext.create("Ext.data.Store",{model:'PartKeepr.TipOfTheDay',pageSize:-1,autoLoad:true,listeners:{scope:this,load:this.storeLoaded}});this.userPreferenceStore=Ext.create("Ext.data.Store",{model:'PartKeepr.UserPreference',pageSize:-1,autoLoad:false,listeners:{scope:this,load:this.storeLoaded}});},storeLoaded:function(store){store._loaded=true;},setAdmin:function(admin){this.admin=admin;},isAdmin:function(){return this.admin;},getTipOfTheDayStore:function(){return this.tipOfTheDayStore;},getUserPreference:function(key,defaultValue){var record=this.userPreferenceStore.findRecord("key",key);if(record){return record.get("value");}else{return(typeof defaultValue=="undefined")?null:defaultValue;}},setUserPreference:function(key,value){var record=this.userPreferenceStore.findRecord("key",key);if(record){record.set("value",value);}else{var j=new PartKeepr.UserPreference();j.set("key",key);j.set("value",value);this.userPreferenceStore.add(j);}
this.userPreferenceStore.sync();},getUserPreferenceStore:function(){return this.userPreferenceStore;},getUnitStore:function(){return this.unitStore;},getPartUnitStore:function(){return this.partUnitStore;},getFootprintStore:function(){return this.footprintStore;},getManufacturerStore:function(){return this.manufacturerStore;},getDistributorStore:function(){return this.distributorStore;},getDefaultPartUnit:function(){return this.partUnitStore.findRecord("default",true);},getUserStore:function(){return this.userStore;},getSiPrefixStore:function(){return this.siPrefixStore;},convertMicroToMu:function(value){return str_replace("µ","μ",value);},reloadStores:function(){if(this.getSessionManager().getSession()){this.footprintStore.load();this.manufacturerStore.load();this.distributorStore.load();this.partUnitStore.load();this.unitStore.load();this.userStore.load();Ext.defer(PartKeepr.getApplication().reloadStores,100000,this);}},createLayout:function(){this.statusBar=Ext.create("PartKeepr.Statusbar");this.messageLog=this.createMessageLog();this.centerPanel=Ext.create("Ext.tab.Panel",{xtype:'tabpanel',border:false,region:'center',bodyStyle:'background:#DBDBDB',plugins:Ext.create('Ext.ux.TabCloseMenu')});this.menuBar=Ext.create("PartKeepr.MenuBar");this.menuBar.disable();Ext.create('Ext.container.Viewport',{layout:'fit',items:[{xtype:'panel',border:false,layout:'border',items:[this.centerPanel,this.messageLog],bbar:this.statusBar,tbar:this.menuBar}]});},addItem:function(item){this.centerPanel.add(item);},createMessageLog:function(){return Ext.create("PartKeepr.MessageLog",{height:200,hidden:true,split:true,title:i18n("Message Log"),titleCollapse:true,collapsible:true,region:'south',listeners:{beforecollapse:Ext.bind(function(obj){this.hideMessageLog();return false;},this)}});},log:function(message){this.logMessage(message,"none");},logMessage:function(message,severity){if(message!=i18n("Ready.")){var r=Ext.ModelManager.create({message:message,severity:severity,date:new Date()},'PartKeepr.Message');this.messageLog.getStore().add(r);}},hideMessageLog:function(){this.messageLog.hide();},showMessageLog:function(){this.messageLog.show();},toggleMessageLog:function(){if(this.messageLog.isHidden()){this.showMessageLog();}else{this.hideMessageLog();}},getStatusbar:function(){return this.statusBar;},getSession:function(){return this.getSessionManager().getSession();},setSession:function(session){if(session){this.getStatusbar().getConnectionButton().setConnected();}else{this.getStatusbar().getConnectionButton().setDisconnected();this.setUsername("");}},setUsername:function(username){this.username=username;this.getStatusbar().setCurrentUser(username);},getUsername:function(){return this.username;},formatCurrency:function(value){var format=Ext.util.Format;format.currencyPrecision=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.numdecimals",2);format.currencySign=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.symbol","€");format.currencyAtEnd=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.currencySymbolAtEnd",true);if(PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.thousandsSeparator",true)===true){format.thousandSeparator=",";}else{format.thousandSeparator="";}
return format.currency(value);}});PartKeepr.getRESTProxy=function(service){var request,requestData={};var obj={batchActions:false,url:PartKeepr.getBasePath()+'/'+service,listeners:{exception:function(proxy,response,operation){try{var data=Ext.decode(response.responseText);requestData.method=operation.request.method;requestData.headers=operation.request.headers;requestData.jsonData=operation.request.jsonData;request={request:Ext.encode(requestData),response:response.responseText};PartKeepr.ExceptionWindow.showException(data.exception,request);}catch(ex){var exception={message:i18n("Critical Error"),detail:i18n("The server returned a response which we were not able to interpret.")};requestData.method=operation.request.method;requestData.headers=operation.request.headers;requestData.jsonData=operation.request.jsonData;request={request:Ext.encode(requestData),response:response.responseText};PartKeepr.ExceptionWindow.showException(exception,request);}}},reader:{type:'json',root:'response.data',successProperty:"success",messageProperty:'message',totalProperty:'response.totalCount'},writer:{type:'jsonwithassociations'}};return new Ext.data.proxy.Rest(obj);};PartKeepr.getSession=function(){alert("This should not be called.");return"hli2ong0ktnise68p9f5nu6nk1";};PartKeepr.log=function(message){PartKeepr.getApplication().log(message);};PartKeepr.getApplication=function(){return PartKeepr.application;};PartKeepr.getBasePath=function(){return"rest.php";};PartKeepr.getImagePath=function(){return"image.php";};PartKeepr.setMaxUploadSize=function(size){PartKeepr.maxUploadSize=size;};PartKeepr.getMaxUploadSize=function(){return PartKeepr.maxUploadSize;};PartKeepr.bytesToSize=function(bytes){var sizes=['Bytes','KB','MB','GB','TB'];if(bytes===0)return'n/a';var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)),10);return Math.round(bytes/Math.pow(1024,i),2)+' '+sizes[i];};PartKeepr.setAvailableImageFormats=function(formats){PartKeepr.imageFormats=formats;};PartKeepr.getAvailableImageFormats=function(){return PartKeepr.imageFormats;};PartKeepr.serializeRecords=function(records){var finalData=[];for(var i=0;i<records.length;i++){finalData.push(records[i].data);}
return finalData;};
Ext.define("PartKeepr.JsonWithAssociations",{extend:'Ext.data.writer.Json',alias:'writer.jsonwithassociations',associations:[],getRecordData:function(record){var me=this,i,key,subStore,data=me.callParent(arguments);var storeName;Ext.apply(data,record.getAssociatedData());return data;}});
function i18n(string){return string;}
Ext.define('Ext.ux.TabCloseMenu',{alias:'plugin.tabclosemenu',mixins:{observable:'Ext.util.Observable'},closeTabText:'Close Tab',showCloseOthers:true,closeOthersTabsText:'Close Other Tabs',showCloseAll:true,closeAllTabsText:'Close All Tabs',extraItemsHead:null,extraItemsTail:null,constructor:function(config){this.addEvents('aftermenu','beforemenu');this.mixins.observable.constructor.call(this,config);},init:function(tabpanel){this.tabPanel=tabpanel;this.tabBar=tabpanel.down("tabbar");this.mon(this.tabPanel,{scope:this,afterlayout:this.onAfterLayout,single:true});},onAfterLayout:function(){this.mon(this.tabBar.el,{scope:this,contextmenu:this.onContextMenu,delegate:'div.x-tab'});},onBeforeDestroy:function(){Ext.destroy(this.menu);this.callParent(arguments);},onContextMenu:function(event,target){var me=this,menu=me.createMenu(),disableAll=true,disableOthers=true,tab=me.tabBar.getChildByElement(target),index=me.tabBar.items.indexOf(tab);me.item=me.tabPanel.getComponent(index);menu.child('*[text="'+me.closeTabText+'"]').setDisabled(!me.item.closable);if(me.showCloseAll||me.showCloseOthers){me.tabPanel.items.each(function(item){if(item.closable){disableAll=false;if(item!=me.item){disableOthers=false;return false;}}
return true;});if(me.showCloseAll){menu.child('*[text="'+me.closeAllTabsText+'"]').setDisabled(disableAll);}
if(me.showCloseOthers){menu.child('*[text="'+me.closeOthersTabsText+'"]').setDisabled(disableOthers);}}
event.preventDefault();me.fireEvent('beforemenu',menu,me.item,me);menu.showAt(event.getXY());},createMenu:function(){var me=this;if(!me.menu){var items=[{text:me.closeTabText,scope:me,handler:me.onClose}];if(me.showCloseAll||me.showCloseOthers){items.push('-');}
if(me.showCloseOthers){items.push({text:me.closeOthersTabsText,scope:me,handler:me.onCloseOthers});}
if(me.showCloseAll){items.push({text:me.closeAllTabsText,scope:me,handler:me.onCloseAll});}
if(me.extraItemsHead){items=me.extraItemsHead.concat(items);}
if(me.extraItemsTail){items=items.concat(me.extraItemsTail);}
me.menu=Ext.create('Ext.menu.Menu',{items:items,listeners:{hide:me.onHideMenu,scope:me}});}
return me.menu;},onHideMenu:function(){var me=this;me.item=null;me.fireEvent('aftermenu',me.menu,me);},onClose:function(){this.tabPanel.remove(this.item);},onCloseOthers:function(){this.doClose(true);},onCloseAll:function(){this.doClose(false);},doClose:function(excludeActive){var items=[];this.tabPanel.items.each(function(item){if(item.closable){if(!excludeActive||item!=this.item){items.push(item);}}},this);Ext.each(items,function(item){this.tabPanel.remove(item);},this);}});
Ext.define('PartKeepr.FileUploadDialog',{extend:'Ext.window.Window',title:i18n("File Upload"),fileFieldLabel:i18n("File"),uploadButtonText:i18n('Select File...'),uploadURL:PartKeepr.getBasePath()+"/TempFile",layout:'fit',resizable:false,modal:true,iconCls:'icon-drive-upload',initComponent:function(){if(this.imageUpload){this.uploadURL=PartKeepr.getBasePath()+"/TempImage";}
this.addEvents("fileUploaded");this.uploadButton=Ext.create("Ext.button.Button",{text:i18n('Upload'),iconCls:'icon-drive-upload',width:120,handler:Ext.bind(function(){var form=this.form.getForm();if(this.fileField.getValue()===""&&this.urlField.getValue()===""){Ext.Msg.alert(i18n("Error"),i18n("Please select a file to upload or enter an URL"));return;}
if(form.isValid()){form.submit({url:this.uploadURL,params:{call:"upload",session:PartKeepr.getApplication().getSession()},success:Ext.bind(function(fp,o){this.fireEvent("fileUploaded",o.result.response);this.close();},this),failure:function(form,action){var data=Ext.decode(action.response.responseText);request={response:action.response.responseText};PartKeepr.ExceptionWindow.showException(data.exception,request);}});}},this)});this.urlField=Ext.create("Ext.form.field.Text",{fieldLabel:i18n("URL"),labelWidth:50,name:"url",anchor:'100%'});this.tbButtons=[this.uploadButton];if(this.imageUpload){this.title=i18n("Image Upload");this.fileFieldLabel=i18n("Image");this.uploadButtonText=i18n("Select Image...");this.fileFormatButton=Ext.create("Ext.button.Button",{text:i18n("Available Formats"),width:120,iconCls:'icon-infocard',handler:this.showAvailableFormats,scope:this});this.tbButtons.push(this.fileFormatButton);}
this.fileField=Ext.create("Ext.form.field.File",{xtype:'filefield',name:'userfile',fieldLabel:this.fileFieldLabel,labelWidth:50,msgTarget:'side',anchor:'100%',buttonText:this.uploadButtonText});this.uploadSizeButton=Ext.create("Ext.button.Button",{xtype:'button',icon:'resources/fugue-icons/icons/information-frame.png',handler:this.showUploadSizeInformation,scope:this});this.form=Ext.create('Ext.form.Panel',{width:400,bodyPadding:10,border:false,items:[{html:i18n("Select a file to upload or enter an URL to load the file from"),border:false,style:"margin-bottom: 20px;"},this.fileField,{border:false,style:'margin-bottom: 20px;margin-left: 55px;',layout:{type:'hbox',pack:'start',align:'middle'},items:[{html:sprintf(i18n("Maximum upload size: %s"),PartKeepr.bytesToSize(PartKeepr.getMaxUploadSize())),style:'margin-right: 10px;',border:false},this.uploadSizeButton]},this.urlField],buttons:this.tbButtons});this.on("beforedestroy",this.onBeforeDestroy,this);this.items=this.form;this.callParent();},showUploadSizeInformation:function(){if(!this.uploadSizeTip){this.uploadSizeTip=Ext.create("Ext.tip.ToolTip",{title:i18n("Upload Size Information"),anchor:'left',width:350,height:132,autoScroll:true,target:this.uploadSizeButton.getEl(),closable:true,html:i18n("The maximum upload size can be configured in your php.ini file. There are two separate options:<br/>- post_max_size<br/>- upload_max_filesize<br/><br/>You need to set both values high enough.")+'<br/><br/><a target="_blank" href="http://de2.php.net/manual/en/ini.core.php#ini.post-max-size">'+i18n("More Information")+'</a>',autoHide:false});}
this.uploadSizeTip.show();},showAvailableFormats:function(){if(!this.imageFormatsTip){this.imageFormatsTip=Ext.create("Ext.tip.ToolTip",{title:i18n("Available Image Formats"),anchor:'left',width:200,height:300,autoScroll:true,target:this.fileFormatButton.getEl(),closable:true,html:implode("<br>",PartKeepr.getAvailableImageFormats()),autoHide:false});}
this.imageFormatsTip.show();},onBeforeDestroy:function(){if(this.imageFormatsTip){this.imageFormatsTip.destroy();}
if(this.uploadSizeTip){this.uploadSizeTip.destroy();}}});
Ext.define('PartKeepr.ExceptionWindow',{extend:'Ext.window.Window',resizable:true,layout:'fit',width:500,autoHeight:true,maxHeight:800,cls:Ext.baseCSSPrefix+'message-box',initComponent:function(){this.iconComponent=Ext.create('Ext.Component',{cls:'ext-mb-icon',width:40,height:35,style:{'float':'left'}});this.messageDiv=Ext.create('Ext.Component',{autoEl:{tag:'div'},cls:'ext-mb-text',style:'margin-left: 40px;'});this.detailDiv=Ext.create('Ext.Component',{autoEl:{tag:'div'},cls:'ext-mb-text',style:'margin-left: 40px; margin-top: 20px;'});this.exceptionDetails=Ext.create('Ext.form.field.TextArea',{fieldLabel:i18n("Exception Details"),flex:1,minHeight:65,readOnly:true});this.backtraceDetails=Ext.create('Ext.form.field.TextArea',{fieldLabel:i18n("Backtrace"),flex:1,minHeight:65,readOnly:true});this.requestDetails=Ext.create('Ext.form.field.TextArea',{fieldLabel:i18n("Request"),flex:1,minHeight:65,readOnly:true});this.responseDetails=Ext.create('Ext.form.field.TextArea',{fieldLabel:i18n("Response"),flex:1,minHeight:65,readOnly:true});this.basicTab=Ext.create("Ext.panel.Panel",{style:'padding: 10px',layout:'anchor',anchor:'100% 100%',title:i18n("Basic"),items:[this.iconComponent,this.messageDiv,this.detailDiv]});this.detailTab=Ext.create("Ext.form.Panel",{style:'padding: 10px',layout:'anchor',autoScroll:true,title:i18n("Detail"),items:[{xtype:'panel',height:300,border:false,layout:{type:'vbox',align:'stretch',pack:'start'},items:[this.exceptionDetails,this.backtraceDetails,this.requestDetails,this.responseDetails]}]});this.fullReport=Ext.create("Ext.form.field.TextArea",{readOnly:true,height:300});this.backtraceTab=Ext.create("Ext.panel.Panel",{style:'padding: 10px',layout:'fit',anchor:'100% 100%',title:i18n("Full Report"),items:[this.fullReport]});this.topContainer=Ext.create("Ext.tab.Panel",{items:[this.basicTab,this.detailTab,this.backtraceTab]});this.items=this.topContainer;this.dockedItems=[{xtype:'toolbar',dock:'bottom',ui:'footer',defaults:{minWidth:80},layout:{pack:'center'},items:[{xtype:'button',text:'OK',handler:Ext.bind(function(){this.hide();},this)}]}];this.callParent();},setIcon:function(icon){this.iconComponent.removeCls(this.iconCls);if(icon){this.iconComponent.show();this.iconComponent.addCls(Ext.baseCSSPrefix+'dlg-icon');this.iconComponent.addCls(icon);}else{this.iconComponent.removeCls(Ext.baseCSSPrefix+'dlg-icon');this.iconComponent.hide();}},_showException:function(exception,requestData){var separator="==================================";if(!requestData){requestData={};}
this.setIcon(Ext.MessageBox.ERROR);this.messageDiv.update(exception.message);this.setTitle(exception.message);var fullDetails=exception.message;if(exception.detail){fullDetails+="\n\n"+i18n("Details")+"\n"+separator+"\n";fullDetails+=exception.detail;this.detailDiv.update(exception.detail);}else{this.detailDiv.update("");}
if(exception.exception){fullDetails+="\n\n"+i18n("Exception")+"\n"+separator+"\n";fullDetails+=exception.exception;this.exceptionDetails.setValue(exception.exception);}else{this.exceptionDetails.setValue("No information available");}
if(exception.backtrace){fullDetails+="\n\n"+i18n("Backtrace")+"\n"+separator+"\n";fullDetails+=exception.exception;this.backtraceDetails.setValue(nl2br(exception.backtrace));}else{this.backtraceDetails.setValue("No backtrace available");}
if(requestData.request){fullDetails+="\n\n"+i18n("Request")+"\n"+separator+"\n";fullDetails+=requestData.request;this.requestDetails.setValue(nl2br(requestData.request));}else{this.requestDetails.setValue("No server request information available");}
if(requestData.response){fullDetails+="\n\n"+i18n("Response")+"\n"+separator+"\n";fullDetails+=requestData.response;this.responseDetails.setValue(nl2br(requestData.response));}else{this.responseDetails.setValue("No server response information available");}
fullDetails+="\n\n"+i18n("Server Configuration")+"\n"+separator+"\n";for(var j in window.parameters){fullDetails+=j+": "+window.parameters[j]+"\n";}
this.fullReport.setValue(fullDetails);this.show();this.topContainer.layout.setActiveItem(0);this.doLayout();var keyMap=this.getKeyMap();keyMap.on(Ext.EventObject.ENTER,function(){this.hide();},this);},statics:{showException:function(exception,requestData){if(!PartKeepr.ExceptionWindow.activeInstance){PartKeepr.ExceptionWindow.activeInstance=new PartKeepr.ExceptionWindow();}
PartKeepr.ExceptionWindow.activeInstance._showException(exception,requestData);}}});
Ext.define('PartKeepr.RememberChoiceMessageBox',{extend:'Ext.window.MessageBox',escButtonAction:null,initComponent:function(){this.callParent();this.rememberChoiceCheckbox=Ext.create("Ext.form.field.Checkbox",{margin:{top:"10px"},boxLabel:i18n("Don't ask again")});this.promptContainer.add(this.rememberChoiceCheckbox);},onEsc:function(){if(this.escButtonAction!==null){var btnIdx;switch(this.escButtonAction){case"ok":btnIdx=0;break;case"yes":btnIdx=1;break;case"no":btnIdx=2;break;case"cancel":btnIdx=3;break;default:btnIdx=3;break;}
this.btnCallback(this.msgButtons[btnIdx]);}else{this.callParent();}}});
Ext.define('PartKeepr.CategoryEditorWindow',{extend:'Ext.window.Window',border:false,width:400,categoryModel:null,initComponent:function(){this.form=Ext.create("PartKeepr.CategoryEditorForm");this.keys=[{key:Ext.EventObject.ENTER,handler:this.onEnter,scope:this}];this.buttons=[{text:i18n("Save"),handler:Ext.bind(this.onSave,this)},{text:i18n("Cancel"),handler:Ext.bind(this.onCancel,this)}];this.items=this.form;this.addEvents("save");this.callParent();this.proxyRecord=Ext.create(this.categoryModel);if(this.record){this.proxyRecord.set("name",this.record.get("name"));this.proxyRecord.set("description",this.record.get("description"));this.proxyRecord.set("id",this.record.get("id"));this.proxyRecord.phantom=false;this.setTitle(i18n("Edit Category"));}else{this.proxyRecord.set("parent",this.parent);this.setTitle(i18n("Add Category"));}
this.form.getForm().loadRecord(this.proxyRecord);this.on("show",Ext.bind(this.onShow,this));},onEnter:function(){this.onSave();},onShow:function(){this.form.items.first().focus();},onSave:function(){this.form.getForm().updateRecord(this.proxyRecord);this.proxyRecord.save({success:Ext.bind(function(response){this.fireEvent("save",response);this.destroy();},this)});},onCancel:function(){this.destroy();}});
Ext.define('PartKeepr.CategoryEditorForm',{extend:'Ext.form.Panel',layout:'anchor',border:false,frame:false,bodyStyle:'background:#DBDBDB;padding: 10px;',items:[{xtype:'textfield',name:'name',anchor:'100%',fieldLabel:i18n("Name")},{xtype:'textarea',name:'description',anchor:'100%',fieldLabel:i18n("Description")}]});
Ext.define('PartKeepr.StatisticsChart',{extend:'Ext.chart.Chart',animate:true,shadow:true,style:'border: 1px solid #AAA;background-color: white;box-shadow: 5px 5px 0px #aaa',legend:{position:'right'},theme:'Base',series:[{type:'line',highlight:{size:7,radius:7},axis:'left',xField:'start',yField:'parts',tips:{trackMouse:true,width:170,height:28,renderer:function(storeItem,item){this.setTitle(Ext.Date.format(storeItem.get('start'),"Y-m-d")+": "+storeItem.get("parts")+" "+i18n("Parts"));}},title:i18n("Parts"),markerConfig:{type:'cross',size:4,radius:4,'stroke-width':0}},{type:'line',highlight:{size:7,radius:7},tips:{trackMouse:true,width:170,height:28,renderer:function(storeItem,item){this.setTitle(Ext.Date.format(storeItem.get('start'),"Y-m-d")+": "+storeItem.get("categories")+" "+i18n("Categories"));}},axis:'left',title:i18n("Categories"),smooth:true,xField:'start',yField:'categories',markerConfig:{type:'circle',size:4,radius:4,'stroke-width':0}}],initComponent:function(){this.axis1={type:'Numeric',minimum:0,position:'left',fields:['parts','categories'],title:i18n("Count"),minorTickSteps:1,grid:{odd:{opacity:1,fill:'#eee',stroke:'#bbb','stroke-width':0.5},even:{opacity:1,stroke:'#bbb','stroke-width':0.5}}};this.axis2={type:'Time',dateFormat:'Y-m-d',position:'bottom',aggregateOp:"avg",fields:['start'],title:i18n("Date"),grid:true};this.axes=[this.axis1,this.axis2];this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.StatisticSample',proxy:{type:'ajax',reader:{type:'json',root:'response.data'},url:'service.php',extraParams:{"service":"Statistic","call":"getSampledStatistics","startDateTime":"2011-01-01 00:00:00","endDateTime":"2011-12-01 23:59:59"},headers:{session:PartKeepr.getApplication().getSession()}},autoLoad:false});this.callParent();},setStart:function(date){if(!(date instanceof Date)){return;}
this.store.getProxy().extraParams.startDateTime=Ext.Date.format(date,"Y-m-d H:i:s");},setEnd:function(date){if(!(date instanceof Date)){return;}
date.setHours(23);date.setMinutes(59);date.setSeconds(59);this.store.getProxy().extraParams.endDateTime=Ext.Date.format(date,"Y-m-d H:i:s");}});
Ext.define('PartKeepr.CurrentStatisticsPanel',{extend:'Ext.panel.Panel',width:400,height:250,title:i18n("Current Statistics"),bodyStyle:{padding:"5px"},layout:'fit',initComponent:function(){this.tpl=new Ext.XTemplate('<h1>'+i18n("Current Statistics")+'</h1>','<table>','<tr>','<td style="width: 200px;" class="o">'+i18n("Different Parts")+':</td>','<td style="width: 200px;" class="o">{partCount}</td>','</tr>','<tr>','<td style="width: 200px;" class="e">'+i18n("Total Part Value")+':</td>','<td style="width: 200px;" class="e">{[PartKeepr.getApplication().formatCurrency(values.totalPrice)]}</td>','</tr>','<tr>','<td style="width: 200px;" class="o">'+i18n("Average Part Value")+':</td>','<td style="width: 200px;" class="o">{[PartKeepr.getApplication().formatCurrency(values.averagePrice)]}</td>','</tr>','<tr>','<td style="width: 200px;" class="e">'+i18n("Parts with price")+':</td>','<td style="width: 200px;" class="e">{partsWithPrice}</td>','</tr>','<tr>','<td style="width: 200px;" class="o">'+i18n("Parts without price")+':</td>','<td style="width: 200px;" class="o">{partsWithoutPrice}</td>','</tr>','<tr>','<td class="e">'+i18n("Categories")+':</td>','<td class="e">{categoryCount}</td>','</tr>','</table>','<h1>'+i18n("Counts per Unit")+'</h1>','<table>','<tpl for="units">','<tr>','<td style="width: 200px;" class="{[xindex % 2 === 0 ? "e" : "o"]}">{name}</td>','<td style="width: 200px;" class="{[xindex % 2 === 0 ? "e" : "o"]}">{stockLevel}</td>','</tr>','</tpl>','</table>');this.tbButtons=[{text:i18n("Refresh"),handler:this.loadStats,scope:this},{text:i18n("Close"),handler:this.close,scope:this}];this.dockedItems=[{xtype:'toolbar',dock:'bottom',ui:'footer',items:this.tbButtons}];this.view=Ext.create("Ext.panel.Panel",{autoScroll:true});this.items=this.view;this.callParent();this.loadStats();},loadStats:function(){var call=new PartKeepr.ServiceCall("Statistic","getCurrentStats");call.setHandler(Ext.bind(this.onStatsLoaded,this));call.doCall();},onStatsLoaded:function(data){this.tpl.overwrite(this.view.getTargetEl(),data);}});
Ext.define('PartKeepr.StatisticsChartPanel',{extend:'Ext.form.Panel',title:i18n("Statistics Chart"),layout:'anchor',bodyStyle:'background:#DBDBDB;padding: 15px;',initComponent:function(){this.chart=Ext.create("PartKeepr.StatisticsChart",{anchor:'100% -60'});this.dateSelector1=Ext.create("Ext.form.field.Date",{style:'margin-top: 10px',fieldLabel:i18n("From"),listeners:{change:Ext.bind(this.onDateChanged,this)}});this.dateSelector2=Ext.create("Ext.form.field.Date",{fieldLabel:i18n("To"),listeners:{change:Ext.bind(this.onDateChanged,this)}});this.items=[this.chart,this.dateSelector1,this.dateSelector2];this.reloadDates();this.callParent();},onDateChanged:function(){this.chart.setStart(this.dateSelector1.getValue());this.chart.setEnd(this.dateSelector2.getValue());this.chart.store.load();},reloadDates:function(){var call=new PartKeepr.ServiceCall("Statistic","getStatisticRange");call.setHandler(Ext.bind(this.onReloadDates,this));call.doCall();},onReloadDates:function(data){if(data.data.start===null||data.data.end===null){Ext.Msg.alert(i18n("Unable to retrieve the statistic data"),i18n("The system was unable to retrieve the statistic data. The most probable cause is that the CreateStatisticSnapshot.php cronjob is not running."));return;}
var start=Ext.Date.parse(data.data.start,"Y-m-d H:i:s");var end=Ext.Date.parse(data.data.end,"Y-m-d H:i:s");this.dateSelector1.setMinValue(start);this.dateSelector1.setMaxValue(end);this.dateSelector1.suspendEvents();this.dateSelector1.setValue(start);this.dateSelector1.resumeEvents();this.dateSelector2.setMinValue(start);this.dateSelector2.setMaxValue(end);this.dateSelector2.suspendEvents();this.dateSelector2.setValue(end);this.dateSelector2.resumeEvents();this.chart.setStart(start);this.chart.setEnd(end);this.chart.store.load();}});
Ext.define('PartKeepr.PartDisplay',{extend:'Ext.panel.Panel',bodyCls:'partdisplay',autoScroll:true,initComponent:function(){this.tpl=new Ext.XTemplate('<h1>{name}</h1>','<h2>{description}</h2>','<table>','<tr>','<td class="o">'+i18n("Category")+':</td>','<td style="width: 100%;" class="o">{categoryName}</td>','</tr>','<tr>','<td class="e">'+i18n("Stock Level")+':</td>','<td class="e">{stockLevel}</td>','</tr>','<tr>','<td class="o">'+i18n("Minimum Stock Level")+':</td>','<td class="o">{minStockLevel}</td>','</tr>','<tr>','<td class="e">'+i18n("Footprint")+':</td>','<td class="e">{footprintName}</td>','</tr>','<tr>','<td style="white-space: nowrap;" class="o">'+i18n("Storage Location")+':</td>','<td class="o">{storageLocationName}</td>','</tr>','<tr>','<td class="e">'+i18n("Comment")+':</td>','<td class="e">{comment}</td>','</tr>','<tr>','<td class="o">'+i18n("Create Date")+':</td>','<td class="o">{createDate}</td>','</tr>','<tr>','<td class="e">'+i18n("Status")+':</td>','<td class="e">{status}</td>','</tr>','<tr>','<td class="o">'+i18n("Needs Review")+':</td>','<td class="o">{needsReview}</td>','</tr>','<tr>','<td class="e">'+i18n("Used in projects")+':</td>','<td class="e">{[ (values.projects == "") ? "'+i18n("none")+'" : values.projects ]}</td>','</tr>','</table>');this.addButton=new Ext.Button({text:i18n("Add Stock"),icon:'resources/silkicons/brick_add.png',handler:Ext.bind(this.addPartPrompt,this)});this.deleteButton=new Ext.Button({text:i18n("Remove Stock"),icon:'resources/silkicons/brick_delete.png',handler:Ext.bind(this.deletePartPrompt,this)});this.editButton=new Ext.Button({text:i18n("Edit Part"),icon:'resources/silkicons/brick_edit.png',handler:Ext.bind(function(){this.fireEvent("editPart",this.record.get("id"));},this)});this.tbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,items:[this.addButton,this.deleteButton,this.editButton]});this.addEvents("editPart");this.imageDisplay=Ext.create("PartKeepr.PartImageDisplay");this.infoContainer=Ext.create("Ext.container.Container");this.items=[this.infoContainer,this.imageDisplay];this.callParent();},setValues:function(r){this.record=r;var values={};for(var i in r.data){if(r.data[i]!==null){values[i]=htmlentities(r.data[i]);}else{values[i]=r.data[i];}}
this.tpl.overwrite(this.infoContainer.getEl(),values);this.imageDisplay.setStore(this.record.attachments());this.doLayout();this.getTargetEl().scrollTo("top",0);},addPartPrompt:function(){var j=new PartKeepr.PartStockWindow({partUnitName:this.record.get("partUnitName")});j.addStock(this.addPartHandler,this);},addPartHandler:function(quantity,price,comment){var call=new PartKeepr.ServiceCall("Part","addStock");call.setParameter("stock",quantity);call.setParameter("price",price);call.setParameter("comment",comment);call.setParameter("part",this.record.get("id"));call.setHandler(Ext.bind(this.reloadPart,this));call.doCall();},deletePartPrompt:function(){var j=new PartKeepr.PartStockWindow({partUnitName:this.record.get("partUnitName")});j.removeStock(this.deletePartHandler,this);},deletePartHandler:function(quantity){var call=new PartKeepr.ServiceCall("Part","deleteStock");call.setParameter("stock",quantity);call.setParameter("part",this.record.get("id"));call.setHandler(Ext.bind(this.reloadPart,this));call.doCall();},reloadPart:function(){this.loadPart(this.record.get("id"));},loadPart:function(id){PartKeepr.Part.load(id,{scope:this,success:this.onPartLoaded});},onPartLoaded:function(record){this.record=record;this.setValues(this.record);this.record.commit();}});
Ext.define('PartKeepr.PartStockWindow',{extend:'Ext.window.Window',constrainHeader:true,width:305,height:180,resizable:false,title:"",removePartText:i18n("Remove Part(s)"),addPartText:i18n("Add Part(s)"),layout:'anchor',bodyStyle:{padding:"5px"},initComponent:function(){this.quantityField=Ext.create("Ext.form.field.Number",{value:0,minValue:1,width:100,listeners:{specialkey:{fn:function(field,e){if(e.getKey()==e.ENTER){this.onOKClick();}},scope:this}}});this.priceField=Ext.create("PartKeepr.CurrencyField",{anchor:'100%',value:0,fieldLabel:i18n("Price"),listeners:{specialkey:{fn:function(field,e){if(e.getKey()==e.ENTER){this.onOKClick();}},scope:this}}});this.priceCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Price per item"),hideEmptyLabel:false,checked:true});this.commentField=Ext.create("Ext.form.field.Text",{anchor:'100%',fieldLabel:i18n("Comment"),maxLength:255,enforceMaxLength:true,listeners:{specialkey:{fn:function(field,e){if(e.getKey()==e.ENTER){this.onOKClick();}},scope:this}}});this.form=Ext.create("Ext.form.Panel",{bodyStyle:'background:#DBDBDB;',border:false,items:[{xtype:'fieldcontainer',fieldLabel:i18n("Quantity"),layout:'hbox',items:[this.quantityField,{width:75,xtype:'displayfield',margin:"0 0 0 5",value:this.partUnitName}]},this.priceField,this.priceCheckbox,this.commentField]});this.items=this.form;this.okButton=Ext.create("Ext.button.Button",{text:i18n("OK"),handler:this.onOKClick,scope:this});this.buttons=[{text:i18n("Close"),handler:this.onCloseClick,icon:"resources/silkicons/cancel.png",scope:this},this.okButton];this.on("show",function(){this.quantityField.focus();this.quantityField.selectText(0);},this,{delay:100});this.callParent();},onCloseClick:function(){this.close();},onOKClick:function(){if(this.form.getForm().isValid()){var price;if(this.priceCheckbox.getValue()){price=this.priceField.getValue();}else{price=this.priceField.getValue()/this.quantityField.getValue();}
Ext.callback(this.callbackFn,this.callbackScope,[this.quantityField.getValue(),price,this.commentField.getValue()]);this.close();}},addStock:function(fn,scope){this.callbackFn=fn;this.callbackScope=scope;this.setTitle(this.addPartText);this.okButton.setIcon("resources/silkicons/brick_add.png");this.show();},removeStock:function(fn,scope){this.callbackFn=fn;this.callbackScope=scope;this.setTitle(this.removePartText);this.priceField.hide();this.priceCheckbox.hide();this.commentField.hide();this.setHeight(105);this.okButton.setIcon("resources/silkicons/brick_delete.png");this.show();}});
Ext.define('PartKeepr.PartFilterPanel',{extend:'Ext.form.Panel',alias:'widget.PartFilterPanel',bodyPadding:'10px',layout:'column',autoScroll:true,bodyStyle:'background:#DBDBDB;',initComponent:function(){this.createFilterFields();this.leftColumn={xtype:'container',anchor:'100%',layout:'anchor',minWidth:340,style:'margin-right: 10px',columnWidth:0.5,items:[this.storageLocationContainer,this.categoryFilter,this.partsWithoutPrice,this.createDateFilter,this.partsWithoutStockRemovals]};this.rightColumn={xtype:'container',anchor:'100%',minWidth:340,columnWidth:0.5,layout:'anchor',items:[this.stockFilter,this.distributorOrderNumberFilter,this.distributorFilter,this.manufacturerFilter]};this.items=[this.leftColumn,this.rightColumn];this.resetButton=Ext.create("Ext.button.Button",{text:i18n("Reset"),handler:this.onReset,icon:'resources/diagona-icons/icons/16/101.png',scope:this});this.applyButton=Ext.create("Ext.button.Button",{text:i18n("Apply"),icon:'resources/diagona-icons/icons/16/102.png',handler:this.onApply,scope:this});this.dockedItems=[{xtype:'toolbar',enableOverflow:true,dock:'bottom',defaults:{minWidth:100},items:[this.applyButton,this.resetButton]}];this.callParent();},onApply:function(){if(!this.store){PartKeepr.getApplication().raiseRuntimeError("PartFilterPanel.store is not set");return;}
this.applyFilterParameters(this.store.getProxy().extraParams);this.store.currentPage=1;this.store.load({start:0});},onReset:function(){this.storageLocationFilter.setValue("");this.storageLocationFilterCheckbox.setValue(false);this.categoryFilter.setValue({category:'all'});this.stockFilter.setValue({stock:'any'});this.distributorOrderNumberFilter.setValue("");this.createDateFilterSelect.setValue("");this.createDateField.setValue("");this.partsWithoutStockRemovals.setValue(false);this.partsWithoutPrice.setValue(false);this.distributorFilterCombo.setValue("");this.distributorFilterCheckbox.setValue(false);this.manufacturerFilterCombo.setValue("");this.manufacturerFilterCheckbox.setValue(false);this.onApply();},createFilterFields:function(){this.storageLocationFilter=Ext.create("PartKeepr.StorageLocationComboBox",{flex:1,forceSelection:true,listeners:{select:function(){this.storageLocationFilterCheckbox.setValue(true);},scope:this}});this.storageLocationFilterCheckbox=Ext.create("Ext.form.field.Checkbox",{style:'margin-right: 5px',listeners:{change:function(obj,value){if(!value){this.storageLocationFilter.setValue("");}},scope:this}});this.storageLocationContainer=Ext.create("Ext.form.FieldContainer",{layout:'hbox',items:[this.storageLocationFilterCheckbox,this.storageLocationFilter],anchor:'100%',minWidth:300,fieldLabel:i18n("Storage Location")});this.categoryFilter=Ext.create("Ext.form.RadioGroup",{fieldLabel:i18n("Category Scope"),columns:1,items:[{boxLabel:i18n("All Subcategories"),name:'category',inputValue:"all",checked:true},{boxLabel:i18n("Selected Category"),name:'category',inputValue:"selected"}]});this.stockFilter=Ext.create("Ext.form.RadioGroup",{fieldLabel:i18n("Stock Mode"),columns:1,items:[{boxLabel:i18n("Any Stock Level"),name:'stock',inputValue:"any",checked:true},{boxLabel:i18n("Stock Level = 0"),name:'stock',inputValue:"zero"},{boxLabel:i18n("Stock Level > 0"),name:'stock',inputValue:"nonzero"},{boxLabel:i18n("Stock Level < Minimum Stock Level"),name:'stock',inputValue:"below"}]});this.partsWithoutPrice=Ext.create("Ext.form.field.Checkbox",{fieldLabel:i18n("Item Price"),boxLabel:i18n("Show Parts without Price only")});this.distributorOrderNumberFilter=Ext.create("Ext.form.field.Text",{fieldLabel:i18n("Order Number"),anchor:'100%'});this.createDateField=Ext.create("Ext.form.field.Date",{flex:1});var filter=Ext.create('Ext.data.Store',{fields:['type','name'],data:[{"type":"<","name":"before"},{"type":">","name":"after"},{"type":"=","name":"on"},{"type":"","name":"- none -"}]});this.createDateFilterSelect=Ext.create('Ext.form.ComboBox',{store:filter,queryMode:'local',forceSelection:true,editable:false,width:60,value:'',triggerAction:'all',displayField:'name',valueField:'type'});this.createDateFilter={xtype:'fieldcontainer',anchor:'100%',fieldLabel:i18n("Create date"),layout:'hbox',border:false,items:[this.createDateFilterSelect,this.createDateField]};this.partsWithoutStockRemovals=Ext.create("Ext.form.field.Checkbox",{fieldLabel:i18n("Stock Settings"),boxLabel:i18n("Show Parts without stock removals only")});this.manufacturerFilterCheckbox=Ext.create("Ext.form.field.Checkbox",{style:'margin-right: 5px',listeners:{change:function(obj,value){if(!value){this.manufacturerFilterCombo.setValue("");}},scope:this}});this.manufacturerFilterCombo=Ext.create("PartKeepr.ManufacturerComboBox",{flex:1,listeners:{select:function(){this.manufacturerFilterCheckbox.setValue(true);},scope:this}});this.manufacturerFilter=Ext.create("Ext.form.FieldContainer",{layout:'hbox',items:[this.manufacturerFilterCheckbox,this.manufacturerFilterCombo],fieldLabel:i18n("Manufacturer")});this.distributorFilterCheckbox=Ext.create("Ext.form.field.Checkbox",{style:'margin-right: 5px',listeners:{change:function(obj,value){if(!value){this.distributorFilterCombo.setValue("");}},scope:this}});this.distributorFilterCombo=Ext.create("PartKeepr.DistributorComboBox",{flex:1,listeners:{select:function(){this.distributorFilterCheckbox.setValue(true);},scope:this}});this.distributorFilter=Ext.create("Ext.form.FieldContainer",{layout:'hbox',items:[this.distributorFilterCheckbox,this.distributorFilterCombo],fieldLabel:i18n("Distributor")});},applyFilterParameters:function(extraParams){extraParams.withoutPrice=this.partsWithoutPrice.getValue();extraParams.categoryScope=this.categoryFilter.getValue().category;extraParams.stockMode=this.stockFilter.getValue().stock;extraParams.distributorOrderNumber=this.distributorOrderNumberFilter.getValue();if(this.storageLocationFilter.getRawValue()!==""){extraParams.storageLocation=this.storageLocationFilter.getValue();}else{delete extraParams.storageLocation;}
if(this.manufacturerFilterCombo.getRawValue()!==""){extraParams.manufacturer=this.manufacturerFilterCombo.getValue();}else{delete extraParams.manufacturer;}
if(this.distributorFilterCombo.getRawValue()!==""){extraParams.distributor=this.distributorFilterCombo.getValue();}else{delete extraParams.distributor;}
extraParams.createDateRestriction=this.createDateFilterSelect.getValue();var createDate=Ext.util.Format.date(this.createDateField.getValue(),"Y-m-d H:i:s");if(createDate!==""){extraParams.createDate=createDate;}else{delete extraParams.createDate;}
extraParams.withoutStockRemovals=this.partsWithoutStockRemovals.getValue();}});
Ext.define('PartKeepr.PartManager',{extend:'Ext.panel.Panel',alias:'widget.PartManager',layout:'border',id:'partkeepr-partmanager',border:false,padding:5,compactLayout:false,initComponent:function(){this.createStore({model:'PartKeepr.Part',proxy:PartKeepr.getRESTProxy("Part"),groupField:'categoryPath',sorters:[{property:'name',direction:'ASC'}]});var treeConfig={region:'west',categoryModel:'PartKeepr.PartCategory',categoryService:'PartCategory',ddGroup:'CategoryTree'};if(this.compactLayout){treeConfig.region='center';}else{treeConfig.floatable=false;treeConfig.split=true;treeConfig.width=300;treeConfig.title=i18n("Categories");treeConfig.collapsible=true;}
this.tree=Ext.create("PartKeepr.PartCategoryTree",treeConfig);this.tree.on("selectionchange",Ext.bind(function(t,s){if(s.length>0){this.grid.setCategory(s[0].get("id"));}},this));this.detail=Ext.create("PartKeepr.PartDisplay",{title:i18n("Part Details")});this.detail.on("editPart",this.onEditPart,this);this.grid=Ext.create("PartKeepr.PartsGrid",{title:i18n("Parts List"),region:'center',layout:'fit',store:this.getStore()});this.grid.on("editPart",this.onEditPart,this);this.grid.on("itemSelect",this.onItemSelect,this);this.grid.on("itemDeselect",this.onItemSelect,this);this.grid.on("itemAdd",this.onItemAdd,this);this.grid.on("itemDelete",this.onItemDelete,this);this.grid.on("duplicateItemWithBasicData",this.onDuplicateItemWithBasicData,this);this.grid.on("duplicateItemWithAllData",this.onDuplicateItemWithAllData,this);this.tree.on("syncCategory",this.onSyncCategory,this);this.detail.on("partChanged",function(){this.grid.getStore().load();},this);this.stockLevel=Ext.create("PartKeepr.PartStockHistory",{title:"Stock History"});var detailPanelConfig={title:i18n("Part Details"),collapsed:true,collapsible:true,region:'east',floatable:false,titleCollapse:true,split:true,animCollapse:false,items:[this.detail,this.stockLevel]};if(this.compactLayout){detailPanelConfig.height=300;detailPanelConfig.region='south';}else{detailPanelConfig.width=300;}
this.detailPanel=Ext.create("Ext.tab.Panel",detailPanelConfig);this.filterPanel=Ext.create("PartKeepr.PartFilterPanel",{title:i18n("Filter"),region:'south',height:225,animCollapse:false,floatable:false,titleCollapse:true,split:true,collapsed:true,collapsible:true,store:this.store});if(this.compactLayout){this.items=[{layout:'border',border:false,region:'west',animCollapse:false,width:300,split:true,title:i18n("Categories / Part Details"),titleCollapse:true,collapsed:false,collapsible:true,items:[this.tree,this.detailPanel]},{layout:'border',border:false,region:'center',items:[this.grid,this.filterPanel]}];}else{this.items=[this.tree,{layout:'border',border:false,region:'center',items:[this.grid,this.filterPanel]},this.detailPanel];}
this.callParent();},onSyncCategory:function(){var r=this.grid.getSelectionModel().getLastSelected();var rootNode=this.tree.getRootNode();var cat=r.get("category");var node=rootNode.findChild("id",cat,true);this.tree.getView().ensureVisible(node);this.tree.getView().scrollIntoView(node);var htmlNode=new Ext.Element(this.tree.getView().getNode(node));htmlNode.first().highlight("2aaad3");},onItemDelete:function(){var r=this.grid.getSelectionModel().getLastSelected();Ext.Msg.confirm(i18n("Delete Part"),sprintf(i18n("Do you really wish to delete the part %s?"),r.get("name")),this.deletePart,this);},onDuplicateItemWithBasicData:function(){var r=this.grid.getSelectionModel().getLastSelected();this.loadPart(r.get("id"),Ext.bind(this.createPartDuplicate,this));},onDuplicateItemWithAllData:function(){var r=this.grid.getSelectionModel().getLastSelected();this.loadPart(r.get("id"),Ext.bind(this.createFullPartDuplicate,this));},createPartDuplicate:function(rec){var copy=rec.copy();Ext.data.Model.id(copy);copy.set("id",null);var j=Ext.create("PartKeepr.PartEditorWindow",{partMode:'create'});j.editor.on("partSaved",this.onPartSaved,this);j.editor.editItem(copy);j.show();},createFullPartDuplicate:function(rec){var data=rec.getData(true);data.id=null;newItem=Ext.create("PartKeepr.Part");newItem.setDataWithAssociations(data);var j=Ext.create("PartKeepr.PartEditorWindow",{partMode:'create'});j.editor.on("partSaved",this.onPartSaved,this);j.editor.editItem(newItem);j.show();},deletePart:function(btn){var r=this.grid.getSelectionModel().getLastSelected();if(btn=="yes"){var call=new PartKeepr.ServiceCall("Part","deletePart");call.setLoadMessage(sprintf(i18n("Deleting part %s"),r.get("name")));call.setParameter("part",r.get("id"));call.setHandler(Ext.bind(function(){this.store.load();},this));call.doCall();}},onItemAdd:function(){var j=Ext.create("PartKeepr.PartEditorWindow",{partMode:'create'});var defaults={};var defaultPartUnit=PartKeepr.getApplication().getPartUnitStore().findRecord("default",true);defaults.partUnit=defaultPartUnit.get("id");defaults.category=this.grid.currentCategory;record=Ext.create("PartKeepr.Part",defaults);j.editor.partDefaults=defaults;j.editor.editItem(record);j.show();return j;},onEditPart:function(id){this.loadPart(id,Ext.bind(this.onPartLoaded,this));},onPartLoaded:function(f,g){var j=Ext.create("PartKeepr.PartEditorWindow");j.editor.on("partSaved",this.onPartSaved,this);j.editor.editItem(f);j.show();},onPartSaved:function(record){var idx=this.grid.store.find("id",record.get("id"));if(idx!==-1){this.grid.store.load();}
this.detail.setValues(record);},onItemSelect:function(){if(this.grid.getSelectionModel().getCount()>1){this.detailPanel.collapse();this.tree.syncButton.disable();}else if(this.grid.getSelectionModel().getCount()==1){var r=this.grid.getSelectionModel().getLastSelected();this.detailPanel.setActiveTab(this.detail);this.detailPanel.expand();this.detail.setValues(r);this.stockLevel.part=r.get("id");this.tree.syncButton.enable();}else{this.tree.syncButton.disable();}},loadPart:function(id,handler){var model=Ext.ModelManager.getModel("PartKeepr.Part");model.load(id,{scope:this,success:handler});},createStore:function(config){Ext.Object.merge(config,{autoLoad:true,autoSync:false,remoteFilter:true,remoteSort:true,pageSize:50});this.store=Ext.create('Ext.data.Store',config);this.store.on('write',function(store,operation){var success=operation.wasSuccessful();if(success){Ext.each(operation.records,function(record){if(record.dirty){record.commit();}});}});},getStore:function(){return this.store;}});
Ext.define('PartKeepr.PartImageDisplay',{extend:'Ext.panel.Panel',displayedImageId:0,maxImageWidth:200,maxImageHeight:150,layout:'hbox',border:false,initComponent:function(){this.prevButton=Ext.create("Ext.button.Button",{text:'<',width:20,height:this.maxImageHeight,handler:this.onPreviousClick,scope:this});this.nextButton=Ext.create("Ext.button.Button",{text:'>',width:20,height:this.maxImageHeight,handler:this.onNextClick,scope:this});this.imageDisplay=Ext.create("Ext.container.Container",{height:this.maxImageHeight,width:this.maxImageWidth,style:'align: center'});this.items=[this.prevButton,this.imageDisplay,this.nextButton];this.tpl=new Ext.XTemplate('<img src="{image}"/>');this.callParent();},setStore:function(store){var imageSet=false;this.store=store;this.displayedImageId=0;var id=this.getImageToDisplayForward(0);if(id!==-1){this.setImage(id);imageSet=true;}
if(!imageSet){this.tpl.overwrite(this.imageDisplay.getEl(),{image:'image.php?type=partattachment&id=0&w='+this.maxImageWidth+'&h='+this.maxImageHeight});}},setImage:function(id){this.tpl.overwrite(this.imageDisplay.getEl(),{image:'image.php?type=partattachment&m=fitexact&w='+this.maxImageWidth+'&h='+this.maxImageHeight+'&id='+id});this.displayedImageId=id;},onNextClick:function(){var imgId=this.getImageToDisplayForward(this.displayedImageId);if(imgId!==-1){this.setImage(imgId);}},onPreviousClick:function(){var imgId=this.getImageToDisplayBackward(this.displayedImageId);if(imgId!==-1){this.setImage(imgId);}},getImageToDisplayForward:function(startId){var startIdx=this.store.findExact("id",startId);if(startIdx===-1){startIdx=0;}else{startIdx++;}
for(var i=startIdx;i<this.store.count();i++){if(this.store.getAt(i).get("image")){return this.store.getAt(i).get("id");}}
return-1;},getImageToDisplayBackward:function(startId){var startIdx=this.store.findExact("id",startId);if(startIdx>=this.store.count()){startIdx=this.store.count()-1;}else{startIdx--;}
for(var i=startIdx;i>-1;i--){if(this.store.getAt(i).get("image")){return this.store.getAt(i).get("id");}}
return-1;}});
Ext.define('PartKeepr.PartEditorWindow',{extend:'Ext.window.Window',constrainHeader:true,layout:'fit',width:600,minWidth:600,minHeight:415,height:415,saveText:i18n("Save"),cancelText:i18n("Cancel"),partMode:'edit',title:i18n("Add Part"),initComponent:function(){this.editor=Ext.create("PartKeepr.PartEditor",{border:false,partMode:this.partMode,enableButtons:false});if(this.partMode&&this.partMode=="create"){this.height=500;this.minHeight=500;}
this.items=[this.editor];this.editor.on("editorClose",function(context){this.close();},this,{delay:200});this.editor.on("titleChange",function(val){this.setTitle(val);},this);this.editor.on("itemSaved",this.onItemSaved,this);this.saveButton=Ext.create("Ext.button.Button",{text:this.saveText,icon:'resources/fugue-icons/icons/disk.png',handler:Ext.bind(this.onItemSave,this)});this.cancelButton=Ext.create("Ext.button.Button",{text:this.cancelText,icon:'resources/silkicons/cancel.png',handler:Ext.bind(this.onCancelEdit,this)});this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,defaults:{minWidth:100},dock:'bottom',ui:'footer',pack:'start',items:[this.saveButton,this.cancelButton]});this.dockedItems=[this.bottomToolbar];this.keepOpenCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Create blank item after save")});this.createCopyCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Create Copy after save")});this.copyPartDataCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Takeover all data"),disabled:true});if(this.partMode=="create"){this.bottomToolbar.add(this.keepOpenCheckbox);this.bottomToolbar.add(this.copyPartDataCheckbox);}else{this.bottomToolbar.add(this.createCopyCheckbox);}
this.keepOpenCheckbox.on("change",this.onKeepOpenCheckboxClick,this);this.editor.keepOpenCheckbox=this.keepOpenCheckbox;this.editor.copyPartDataCheckbox=this.copyPartDataCheckbox;this.editor.createCopyCheckbox=this.createCopyCheckbox;this.callParent();},onCancelEdit:function(){this.editor.onCancelEdit();},onKeepOpenCheckboxClick:function(field,value){if(value){this.copyPartDataCheckbox.enable();}else{this.copyPartDataCheckbox.disable();}},onItemSave:function(){if(!this.editor.getForm().isValid()){return;}
this.saveButton.disable();Ext.defer(function(){this.saveButton.enable();},30000,this);this.editor._onItemSave();},onItemSaved:function(){this.saveButton.enable();}});
Ext.define("PartKeepr.SessionManager",{extend:'Ext.util.Observable',session:null,loginDialog:null,constructor:function(config){this.addEvents({"login":true});this.callParent(arguments);},login:function(username,password){this.loginDialog=Ext.create("PartKeepr.LoginDialog");if(username&&password){this.onLogin(username,password);}else{this.loginDialog.on("login",this.onLogin,this);this.loginDialog.show();}},logout:function(){this.session=null;},onLogin:function(username,password){var k=new PartKeepr.ServiceCall("Auth","login");k.setParameter("username",username);k.setParameter("password",md5(password));k.enableAnonymous();k.setHandler(Ext.bind(this.onAfterLogin,this));k.doCall();},onAfterLogin:function(response){this.setSession(response.sessionid);this.loginDialog.destroy();PartKeepr.getApplication().setAdmin(response.admin);PartKeepr.getApplication().setUsername(response.username);PartKeepr.getApplication().setInitialUserPreferences(response.userPreferences);this.fireEvent("login");},setSession:function(sessionid){this.session=sessionid;},getSession:function(){return this.session;}});
Ext.define('PartKeepr.UserPreferencePanel',{extend:'Ext.tab.Panel',title:i18n("User Preferences"),tabPosition:'bottom',initComponent:function(){this.passwordChangePanel=Ext.create("PartKeepr.UserPasswordChangePanel");this.tipsPanel=Ext.create("PartKeepr.TipOfTheDayPreferencesPanel");this.formattingPanel=Ext.create("PartKeepr.FormattingPreferencesPanel");this.displayPreferencesPanel=Ext.create("PartKeepr.DisplayPreferencesPanel");this.stockPanel=Ext.create("PartKeepr.StockPreferencesPanel");this.items=[this.tipsPanel,this.formattingPanel,this.displayPreferencesPanel,this.passwordChangePanel,this.stockPanel];this.callParent();}});
Ext.define('PartKeepr.StockPreferencesPanel',{extend:'Ext.form.FormPanel',title:i18n("Stock Preferences"),bodyStyle:'background:#DBDBDB;padding: 10px;',initComponent:function(){this.confirmInlineStockLevelChangesCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Confirm in-line stock level changes from the parts grid"),handler:Ext.bind(this.confirmInlineStockLevelChangesHandler,this)});if(PartKeepr.getApplication().getUserPreference("partkeepr.inline-stock-change.confirm")===false){this.confirmInlineStockLevelChangesCheckbox.setValue(false);}else{this.confirmInlineStockLevelChangesCheckbox.setValue(true);}
this.items=[this.confirmInlineStockLevelChangesCheckbox];this.callParent();},confirmInlineStockLevelChangesHandler:function(checkbox,checked){PartKeepr.getApplication().setUserPreference("partkeepr.inline-stock-change.confirm",checked);}});
Ext.define('PartKeepr.FormattingPreferencesPanel',{extend:'Ext.form.FormPanel',title:i18n("Formatting"),bodyStyle:'background:#DBDBDB;padding: 10px;',loading:true,initComponent:function(){this.createWidgets();this.loadDefaults();this.items=[this.priceNumDecimalsField,this.useThousandSeparatorCheckbox,this.currencySymbolField,this.currencyAtEndCheckbox];this.callParent();},loadDefaults:function(){var numDecimals=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.numdecimals",2);this.priceNumDecimalsField.setValue(numDecimals);var useThousandsSeparator=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.thousandsSeparator",true);this.useThousandSeparatorCheckbox.setValue(useThousandsSeparator);var currencyAtEnd=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.currencySymbolAtEnd",true);this.currencyAtEndCheckbox.setValue(currencyAtEnd);var currencySymbol=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.symbol","€");this.currencySymbolField.setValue(currencySymbol);this.loading=false;},createWidgets:function(){this.priceNumDecimalsField=Ext.create("Ext.form.field.Number",{name:'priceNumDecimalsField',fieldLabel:i18n('Decimal precision'),labelWidth:120,columnWidth:0.5,minValue:0,maxValue:4,allowDecimals:false,listeners:{change:function(field,newValue){if(!this.loading){PartKeepr.getApplication().setUserPreference("partkeepr.formatting.currency.numdecimals",newValue);}},scope:this}});this.useThousandSeparatorCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Separate thousands"),labelWidth:120,hideEmptyLabel:false,listeners:{change:function(field,newValue){if(!this.loading){PartKeepr.getApplication().setUserPreference("partkeepr.formatting.currency.thousandsSeparator",newValue);}},scope:this}});this.currencySymbolField=Ext.create("Ext.form.field.Text",{fieldLabel:i18n("Currency Symbol"),labelWidth:120,maxLength:5,listeners:{change:function(field,newValue){if(!this.loading){PartKeepr.getApplication().setUserPreference("partkeepr.formatting.currency.symbol",newValue);}},scope:this}});this.currencyAtEndCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Currency Symbol after value"),labelWidth:120,hideEmptyLabel:false,listeners:{change:function(field,newValue){if(!this.loading){PartKeepr.getApplication().setUserPreference("partkeepr.formatting.currency.currencySymbolAtEnd",newValue);}},scope:this}});}});
Ext.define('PartKeepr.UserPasswordChangePanel',{extend:'Ext.form.FormPanel',title:i18n("Change Password"),bodyStyle:'background:#DBDBDB;padding: 10px;',initComponent:function(){this.oldPassword=Ext.create("Ext.form.field.Text",{inputType:"password",name:'password',labelWidth:150,style:'border-bottom: 1px solid grey; padding-bottom: 10px;',width:300,fieldLabel:i18n("Current Password")});this.newPassword=Ext.create("Ext.form.field.Text",{style:'margin-top: 10px',inputType:"password",name:'password',labelWidth:150,width:300,fieldLabel:i18n("New Password")});this.newPasswordConfirm=Ext.create("Ext.form.field.Text",{inputType:"password",name:'password',labelWidth:150,width:300,validator:Ext.bind(this.validatePassword,this),fieldLabel:i18n("New Password (Confirm)")});this.items=[this.oldPassword,this.newPassword,this.newPasswordConfirm,{xtype:'fieldcontainer',hideEmptyLabel:false,width:300,labelWidth:150,items:{xtype:'button',handler:this.onChangePassword,scope:this,width:145,icon:'resources/silkicons/accept.png',text:i18n("Change Password")}}];this.callParent();},onChangePassword:function(){if(this.getForm().isValid()){var call=new PartKeepr.ServiceCall("UserPreference","changePassword");call.setParameter("oldpassword",md5(this.oldPassword.getValue()));call.setParameter("newpassword",md5(this.newPassword.getValue()));call.setHandler(Ext.bind(this.onAfterPasswordChange,this));call.doCall();}},onAfterPasswordChange:function(data){Ext.Msg.alert(data.data,data.data);},validatePassword:function(){if(this.newPassword.getValue()!=this.newPasswordConfirm.getValue()){return i18n("Passwords don't match");}
return true;}});
Ext.define('PartKeepr.DisplayPreferencesPanel',{extend:'Ext.form.FormPanel',title:i18n("Display"),bodyStyle:'background:#DBDBDB;padding: 10px;',initComponent:function(){this.showDescriptionsCheckbox=Ext.create("Ext.form.field.Checkbox",{labelWidth:120,hideEmptyLabel:false,boxLabel:i18n("Show category descriptions"),handler:Ext.bind(this.showDescriptionsHandler,this)});if(PartKeepr.getApplication().getUserPreference("partkeepr.categorytree.showdescriptions")===false){this.showDescriptionsCheckbox.setValue(false);}else{this.showDescriptionsCheckbox.setValue(true);}
this.compactLayout=Ext.create("Ext.form.field.Radio",{boxLabel:i18n("Compact Layout")+'<br/> <img style="margin-top: 2px; margin-left: 18px;" src="resources/images/layout-compact.png"/>',name:'rb',inputValue:'compact'});this.standardLayout=Ext.create("Ext.form.field.Radio",{boxLabel:i18n("Standard Layout")+'<br/> <img style="margin-top: 2px; margin-left: 18px;" src="resources/images/layout-standard.png"/>',name:'rb',inputValue:'standard'});if(PartKeepr.getApplication().getUserPreference("partkeepr.partmanager.compactlayout",false)===true){this.compactLayout.setValue(true);}else{this.standardLayout.setValue(true);}
this.compactLayoutChooser=Ext.create("Ext.form.RadioGroup",{fieldLabel:i18n("Part Manager Layout"),labelWidth:120,columns:2,width:400,vertical:true,listeners:{change:function(field,newValue){if(newValue.rb=="standard"){value=false;}else{value=true;}
PartKeepr.getApplication().setUserPreference("partkeepr.partmanager.compactlayout",value);PartKeepr.getApplication().recreatePartManager();}},items:[this.compactLayout,this.standardLayout]});this.items=[this.showDescriptionsCheckbox,this.compactLayoutChooser];this.callParent();},showDescriptionsHandler:function(checkbox,checked){PartKeepr.getApplication().setUserPreference("partkeepr.categorytree.showdescriptions",checked);},compactLayoutHandler:function(){}});
Ext.define('PartKeepr.TipOfTheDayPreferencesPanel',{extend:'Ext.form.FormPanel',title:i18n("Tip of the Day"),bodyStyle:'background:#DBDBDB;padding: 10px;',initComponent:function(){this.displayTipsOnLoginCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Display tips on login"),handler:Ext.bind(this.showTipsHandler,this)});if(PartKeepr.getApplication().getUserPreference("partkeepr.tipoftheday.showtips")===false){this.displayTipsOnLoginCheckbox.setValue(false);}else{this.displayTipsOnLoginCheckbox.setValue(true);}
this.resetTipsButton=Ext.create("Ext.button.Button",{text:i18n("Mark all tips unread"),handler:this.onMarkAllTipsUnreadClick,scope:this});this.items=[this.displayTipsOnLoginCheckbox,this.resetTipsButton];this.callParent();},showTipsHandler:function(checkbox,checked){PartKeepr.getApplication().setUserPreference("partkeepr.tipoftheday.showtips",checked);},onMarkAllTipsUnreadClick:function(){var call=new PartKeepr.ServiceCall("TipOfTheDay","markAllTipsAsUnread");call.setLoadMessage(i18n("Marking all tips as unerad..."));call.setHandler(function(){var msg=i18n("All tips have been marked as unread");Ext.Msg.alert(msg,msg);});call.doCall();}});
Ext.define("PartKeepr.PartParameterComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.PartParameterComboBox',displayField:'name',valueField:'name',autoSelect:false,allowBlank:false,queryMode:'local',triggerAction:'all',forceSelection:false,editable:true,initComponent:function(){this.store=Ext.create("Ext.data.Store",{fields:[{name:'name'}],proxy:{type:'ajax',url:PartKeepr.getBasePath()+"/Part/getPartParameterNames",reader:{type:'json',root:'response.data'}}});this.store.load();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define("PartKeepr.UnitComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.UnitComboBox',displayField:'name',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,initComponent:function(){this.store=PartKeepr.getApplication().getUnitStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define('PartKeepr.ConnectionButton',{extend:'Ext.Button',connectedIcon:'resources/silkicons/connect.png',disconnectedIcon:'resources/silkicons/disconnect.png',cls:'x-btn-icon',icon:'resources/silkicons/disconnect.png',setConnected:function(){this.setIcon(this.connectedIcon);},setDisconnected:function(){this.setIcon(this.disconnectedIcon);}});
Ext.define("PartKeepr.PartUnitComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.PartUnitComboBox',displayField:'name',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,initComponent:function(){this.store=PartKeepr.getApplication().getPartUnitStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define("PartKeepr.DistributorComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.DistributorComboBox',displayField:'name',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,ignoreQuery:false,initComponent:function(){this.store=PartKeepr.getApplication().getDistributorStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();},onTriggerClick:function(){if(!this.ignoreQuery){this.callParent();}else{var me=this;if(!me.readOnly&&!me.disabled){if(me.isExpanded){me.collapse();}else{me.onFocus({});me.expand();}
me.inputEl.focus();}}}});
Ext.define("PartKeepr.UserComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.UserComboBox',displayField:'username',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,initComponent:function(){this.store=PartKeepr.getApplication().getUserStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define('PartKeepr.WebcamPanel',{extend:'Ext.panel.Panel',alias:'widget.WebcamPanel',initComponent:function(){this.takePhotoButton=Ext.create("Ext.button.Button",{text:i18n("Take picture and upload"),icon:'resources/fugue-icons/icons/webcam.png',handler:this.takePhoto});this.bbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,items:[this.takePhotoButton]});this.on("afterrender",this.renderWebcam,this);this.addEvents("uploadComplete");this.callParent();},renderWebcam:function(e){webcam.set_swf_url("resources/webcam.swf");webcam.set_quality(90);webcam.set_api_url(PartKeepr.getBasePath()+"?service=TempFile&call=uploadCam&session="+PartKeepr.getApplication().getSession());webcam.set_shutter_sound(false);webcam.set_hook('onComplete',Ext.bind(this.onUploadComplete,this));e.body.insertHtml('beforeEnd',webcam.get_html(640,480,640,480));},takePhoto:function(){webcam.snap();this.takePhotoButton.disable();this.takePhotoButton.setText(i18n("Uploading..."));},onUploadComplete:function(message){var response=Ext.decode(message);webcam.reset();this.fireEvent("uploadComplete",response.response);}});
Ext.define('PartKeepr.RemoteImageFieldLayout',{alias:['layout.remoteimagefield'],extend:'Ext.layout.component.field.Field',type:'remoteimagefield',sizeBodyContents:function(width,height){var me=this,owner=me.owner,inputEl=owner.inputEl,triggerWrap=owner.triggerWrap,triggerWidth=owner.getTriggerWidth();if(owner.hideTrigger||owner.readOnly||triggerWidth>0){me.setElementSize(inputEl,Ext.isNumber(width)?width-triggerWidth:width);triggerWrap.setWidth(triggerWidth);}}});
Ext.define('PartKeepr.SiUnitList',{extend:'Ext.view.BoundList',alias:'widget.siunitlist',getInnerTpl:function(displayField){return'<span style="display: inline-block; width: 15px;">{'+displayField+'}</span><span style="display: inline-block; width: 40px;">{prefix}</span>(10<sup>{power}</span>)';}});
Ext.define("PartKeepr.SiUnitField",{extend:"Ext.form.field.Picker",alias:'widget.SiUnitField',siPrefix:null,allowDecimals:true,decimalSeparator:'.',decimalPrecision:2,minValue:Number.NEGATIVE_INFINITY,maxValue:Number.MAX_VALUE,minText:'The minimum value for this field is {0}',maxText:'The maximum value for this field is {0}',nanText:'{0} is not a valid number',negativeText:'The value cannot be negative',baseChars:'0123456789',autoStripChars:false,initComponent:function(){var me=this,allowed;me.callParent();me.setMinValue(me.minValue);me.setMaxValue(me.maxValue);if(me.disableKeyFilter!==true){allowed=me.baseChars+'';var store=PartKeepr.getApplication().getSiPrefixStore();for(var i=0;i<store.count();i++){allowed+=store.getAt(i).get("symbol");}
allowed+="µ";if(me.allowDecimals){allowed+=me.decimalSeparator;}
if(me.minValue<0){allowed+='-';}
allowed=Ext.String.escapeRegex(allowed);me.maskRe=new RegExp('['+allowed+']');if(me.autoStripChars){me.stripCharsRe=new RegExp('[^'+allowed+']','gi');}}},onTriggerClick:function(){this.expand();var node=this.picker.getNode(this.siPrefix);if(node){this.picker.highlightItem(node);this.picker.listEl.scrollChildIntoView(node,false);}},getStore:function(){if(this.store){return this.store;}
return PartKeepr.getApplication().getSiPrefixStore();},setStore:function(store){if(this.picker){this.picker.bindStore(store);}else{this.store=store;}},createPicker:function(){var siprefixtpl=new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap">','{symbol} {prefix}','</div>','</tpl>');var tmp=Ext.create('PartKeepr.SiUnitList',{store:this.getStore(),singleSelect:true,ownerCt:this.ownerCt,renderTo:document.body,floating:true,maxHeight:300,shadow:'sides',focusOnToFront:false,hidden:true,focusOnShow:true,displayField:'symbol',isteners:{scope:this,itemclick:this.onSelect}});this.mon(tmp,{itemclick:this.onSelect,scope:this});return tmp;},onSelect:function(t,rec){var val=this.getValue();val.symbol=rec.get("symbol");val.power=rec.get("power");val.siprefix_id=rec.get("id");this.setValue(val);this.collapse();},getErrors:function(value){var me=this,errors=me.callParent(arguments),format=Ext.String.format,num,retVal;retVal=Ext.isDefined(value)?value:this.processRawValue(this.getRawValue());value=retVal.value;if(value.length<1){return errors;}
value=String(value).replace(me.decimalSeparator,'.');if(isNaN(value)){errors.push(format(me.nanText,value));}
num=me.parseValue(value);if(me.minValue===0&&num<0){errors.push(this.negativeText);}
else if(num<me.minValue){errors.push(format(me.minText,me.minValue));}
if(num>me.maxValue){errors.push(format(me.maxText,me.maxValue));}
return errors;},rawToValue:function(rawValue){var processValue;if(Ext.isObject(rawValue)){processValue=rawValue.value;}else{processValue=rawValue;}
return this.fixPrecision(this.parseValue(processValue))||processValue||null;},valueToRaw:function(value){var me=this,decimalSeparator=me.decimalSeparator;value=me.parseValue(value);value=me.fixPrecision(value);value=Ext.isNumber(value)?value:parseFloat(String(value).replace(decimalSeparator,'.'));value=isNaN(value)?'':String(value).replace('.',decimalSeparator);if(Ext.isObject(this.siPrefix)&&this.siPrefix.get("symbol")!==""){return value+" "+this.siPrefix.get("symbol");}else{return value;}},onChange:function(){var me=this,value=me.getValue(),valueIsNull=value===null;me.callParent(arguments);},getValue:function(){var v=this.callParent(arguments);if(this.siPrefix){return{value:v,symbol:this.siPrefix.get("symbol"),power:this.siPrefix.get("power"),siprefix_id:this.siPrefix.get("id")};}else{return{value:v,symbol:"",power:1,siprefix_id:null};}},setMinValue:function(value){this.minValue=Ext.Number.from(value,Number.NEGATIVE_INFINITY);},setMaxValue:function(value){this.maxValue=Ext.Number.from(value,Number.MAX_VALUE);},parseValue:function(value){value=parseFloat(String(value).replace(this.decimalSeparator,'.'));return isNaN(value)?null:value;},fixPrecision:function(value){var me=this,nan=isNaN(value),precision=me.decimalPrecision;if(nan||!value){return nan?'':value;}else if(!me.allowDecimals||precision<=0){precision=0;}
return parseFloat(Ext.Number.toFixed(parseFloat(value),precision));},beforeBlur:function(){var me=this,v=me.parseValue(me.getRawValue());if(!Ext.isEmpty(v)){me.setValue(v);}},findSiPrefix:function(value){var store=PartKeepr.getApplication().getSiPrefixStore();var symbol;for(var i=0;i<store.count();i++){symbol=store.getAt(i).get("symbol");if(symbol!==""){if(strpos(value,symbol)!==false){return store.getAt(i);}}else{emptyPrefix=store.getAt(i);}}
if(emptyPrefix){return emptyPrefix;}else{return null;}},setValue:function(v){if(Ext.isObject(v)){this.siPrefix=PartKeepr.getApplication().getSiPrefixStore().getById(v.siprefix_id);return this.callParent([v.value]);}else{return v;}},processRawValue:function(value){var prefix;value=PartKeepr.getApplication().convertMicroToMu(value);var siPrefix=this.findSiPrefix(value);this.siPrefix=siPrefix;if(siPrefix!==null){value=str_replace(siPrefix.get("symbol"),"",value);return{value:value,symbol:siPrefix.get("symbol"),power:siPrefix.get("power"),siprefix_id:siPrefix.get("id")};}else{return{value:value,symbol:"",power:0,siprefix_id:null};}}});
Ext.define('PartKeepr.FadingButton',{extend:'Ext.Button',initComponent:function(){this.callParent();},startFading:function(){var iconEl=this.getEl().down(".x-btn-inner");iconEl.animate({duration:1000,iterations:1,listeners:{afteranimate:function(){if(this.fadeRunning){Ext.defer(this.startFading,100,this);}},scope:this},keyframes:{50:{opacity:0},100:{opacity:1}}});this.fadeRunning=true;},stopFading:function(){this.fadeRunning=false;},isFading:function(){var iconEl=this.getEl().down(".x-btn-inner");if(iconEl.getActiveAnimation()===false){return false;}
return true;}});
Ext.define('PartKeepr.SystemNoticeButton',{extend:'PartKeepr.FadingButton',icon:'resources/fugue-icons/icons/service-bell.png',tooltip:i18n("Unacknowledged System Notices"),initComponent:function(){this.callParent();this.on("render",this.startFading,this);this.on("click",this.onClick,this);},onClick:function(){PartKeepr.getApplication().menuBar.showSystemNotices();}});
Ext.define('PartKeepr.RemoteImageField',{extend:'Ext.form.field.Base',alias:'widget.remoteimagefield',type:'remoteimagefield',imageWidth:32,imageHeight:32,fieldSubTpl:['<img id="{cmpId}-imgEl" style="{size}" class="remoteimagefield"/>',{compiled:true,disableFormats:true}],initComponent:function(){this.minHeight=this.imageHeight;this.minWidth=this.imageWidth;this.imageId=Ext.id("remoteimagefield");this.callParent();},getSubTplData:function(){return{cmpId:this.id,size:'height:'+this.imageHeight+"px;width:"+this.imageWidth+"px;",imageid:this.imageId};},onRender:function(){var me=this;me.onLabelableRender();me.addChildEls('imgEl');me.callParent(arguments);},afterRender:function(){this.imgEl.dom.src=this.getImageURL();this.imgEl.on("click",this.onClick,this);},onClick:function(){var j=Ext.create("PartKeepr.FileUploadDialog",{imageUpload:true});j.on("fileUploaded",this.onFileUploaded,this);j.show();},onFileUploaded:function(data){this.setValue("TMP:"+data.id);},getImageURL:function(){var idparam;if(strpos(this.value,"TMP:")!==false){idparam="id=0&tmpId="+str_replace("TMP:","",this.value);}else{idparam="id="+this.value;}
return PartKeepr.getImagePath()+"?"+idparam+"&type="+this.imageType+"&w="+this.imageWidth+"&h="+this.imageHeight+"&m=fitpadding&_dc="+Ext.Date.now();},setValue:function(value){var me=this;this.setRawValue(value);this.value=value;if(this.rendered){this.imgEl.dom.src=this.getImageURL();}
return this;}});
Ext.define("PartKeepr.ResistorDisplay",{extend:"Ext.draw.Component",alias:'widget.ResistorDisplay',viewBox:false,initComponent:function(){this.circle=Ext.create("Ext.draw.Sprite",{type:'circle',fill:'#79BB3F',radius:100,x:100,y:100});this.items=[this.circle];this.callParent();this.circle=this.surface;}});
Ext.define("PartKeepr.ManufacturerComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.ManufacturerComboBox',displayField:'name',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,initComponent:function(){this.store=PartKeepr.getApplication().getManufacturerStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define("PartKeepr.FootprintComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.FootprintComboBox',displayField:'name',valueField:'id',autoSelect:true,queryMode:'local',triggerAction:'all',forceSelection:true,editable:true,initComponent:function(){this.store=PartKeepr.getApplication().getFootprintStore();this.store.on("beforeload",function(){this._oldValue=this.getValue();},this);this.store.on("load",function(){this.setValue(this._oldValue);},this);this.callParent();}});
Ext.define("PartKeepr.RemotePartComboBox",{extend:"Ext.form.field.Picker",alias:'widget.RemotePartComboBox',requires:["Ext.grid.Panel"],selectedValue:null,initComponent:function(){Ext.apply(this,{pickerAlign:"tl-bl?",editable:false});this.createStore({model:'PartKeepr.Part',proxy:PartKeepr.getRESTProxy("Part"),groupField:'categoryPath',sorters:[{property:'name',direction:'ASC'}]});this.callParent();this.createPicker();this.on("focus",function(){this.onTriggerClick();},this);},createStore:function(config){Ext.Object.merge(config,{autoLoad:true,autoSync:false,remoteFilter:true,remoteSort:true,pageSize:15});this.store=Ext.create('Ext.data.Store',config);this.store.on('write',function(store,operation){var success=operation.wasSuccessful();if(success){Ext.each(operation.records,function(record){if(record.dirty){record.commit();}});}});},onTrigger1Click:function(){this.onTriggerClick();},createPicker:function(){this.partsGrid=Ext.create("PartKeepr.PartsGrid",{enableTopToolbar:true,enableEditing:false,store:this.store,region:'center'});this.filter=Ext.create("PartKeepr.PartFilterPanel",{region:'south',floatable:false,titleCollapse:true,height:225,autoScroll:true,store:this.store,title:i18n("Part Filter"),split:true,collapsed:true,collapsible:true});this.picker=Ext.create("Ext.panel.Panel",{layout:'border',floating:true,focusOnToFront:false,height:300,minWidth:350,shadow:false,ownerCt:this.ownerCt,items:[this.partsGrid,this.filter]});this.picker.on({show:function(){this.partsGrid.searchField.setValue(this.getDisplayValue());this.partsGrid.searchField.startSearch();},scope:this});this.partsGrid.on("select",function(selModel,record){this.setSelectedValue(record.get("id"));this.setDisplayValue(record.get("name"));this.collapse();},this);return self.picker;},getDisplayValue:function(){return this.displayValue;},setSelectedValue:function(id){this.selectedValue=id;},getValue:function(){return this.selectedValue;},setDisplayValue:function(value){this.setRawValue(value);this.displayValue=value;},setValue:function(){},_selectRecords:function(r){this.picker.getView().select(r);this.picker.getView().ensureVisible(r);this.picker.getView().scrollIntoView(r);},alignPicker:function(){var me=this,picker,isAbove,aboveSfx='-above';if(this.isExpanded){picker=me.getPicker();if(me.matchFieldWidth){picker.setWidth(me.bodyEl.getWidth());}
if(picker.isFloating()){picker.alignTo(me.inputEl,me.pickerAlign,me.pickerOffset);isAbove=picker.el.getY()<me.inputEl.getY();me.bodyEl[isAbove?'addCls':'removeCls'](me.openCls+aboveSfx);picker.el[isAbove?'addCls':'removeCls'](picker.baseCls+aboveSfx);}}},getErrors:function(value){if(this.getValue()===null){return[i18n("You need to select a category")];}
return[];}});
Ext.define("PartKeepr.ResistorCalculator",{extend:"Ext.window.Window",alias:'widget.ResistorCalculator',width:300,height:300,layout:'fit',initComponent:function(){this.resistorDisplay=Ext.create("PartKeepr.ResistorDisplay",{viewBox:false});this.items=[this.resistorDisplay];this.callParent();}});
Ext.define("PartKeepr.CategoryComboBox",{extend:"Ext.form.field.Picker",alias:'widget.CategoryComboBox',requires:["Ext.tree.Panel"],selectedValue:null,trigger2Cls:Ext.baseCSSPrefix+'form-reload-trigger',initComponent:function(){var self=this;Ext.apply(self,{pickerAlign:"tl-bl?",editable:false});self.callParent();this.createPicker();},onTrigger1Click:function(){this.onTriggerClick();},onTrigger2Click:function(){this.collapse();this.picker.loadCategories();this.expand();},expand:function(){if(!this.picker.loaded){Ext.defer(this.expand,100,this);return;}else{this.callParent();}},createPicker:function(){var self=this;self.picker=new PartKeepr.CategoryTree({height:290,categoryService:'PartCategory',categoryModel:'PartKeepr.PartCategory',floating:true,focusOnToFront:false,shadow:false,ownerCt:this.ownerCt});self.picker.on({itemclick:Ext.bind(function(sm,record){this.setValue(record.get("name"),true);this.setSelectedValue(record.get("id"));this.collapse();},this),show:{fn:Ext.bind(function(cmp){var record=this.picker.getSelectionModel().getLastSelected();this.picker.getView().focusRow(record);},this),delay:50}});self.picker.getView().on("render",Ext.bind(function(){var record=this.picker.getSelectionModel().getLastSelected();this.picker.getView().ensureVisible(record);this.picker.getView().focusRow(record);},this));return self.picker;},setSelectedValue:function(id){this.selectedValue=id;},getValue:function(){return this.selectedValue;},setValue:function(val,parent){if(parent){this.callParent([val]);}
if(!this.picker){return;}
if(!this.picker.loaded){this.picker.on("categoriesLoaded",function(){this._setValue(val);},this);}else{this._setValue(val);}},_setValue:function(val){var r=this.findById(val);if(r!==null){this.setSelectedValue(r.get("id"));this.setValue(r.get("name"),true);if(this.picker.getView().rendered){this._selectRecords(r);}else{this.picker.getView().on("render",function(){this._selectRecords(r);},this);}}},_selectRecords:function(r){this.picker.getView().select(r);this.picker.getView().ensureVisible(r);this.picker.getView().scrollIntoView(r);},findById:function(id){return this.picker.getRootNode().findChild("id",id,true);},alignPicker:function(){var me=this,picker,isAbove,aboveSfx='-above';if(this.isExpanded){picker=me.getPicker();if(me.matchFieldWidth){picker.setWidth(me.bodyEl.getWidth());}
if(picker.isFloating()){picker.alignTo(me.inputEl,me.pickerAlign,me.pickerOffset);isAbove=picker.el.getY()<me.inputEl.getY();me.bodyEl[isAbove?'addCls':'removeCls'](me.openCls+aboveSfx);picker.el[isAbove?'addCls':'removeCls'](picker.baseCls+aboveSfx);}}},getErrors:function(value){if(this.getValue()===null){return[i18n("You need to select a category")];}
return[];}});
Ext.define("PartKeepr.StorageLocationComboBox",{extend:"Ext.form.field.ComboBox",alias:'widget.StorageLocationComboBox',displayField:'name',valueField:'id',queryMode:'local',triggerAction:'all',trigger2Cls:Ext.baseCSSPrefix+'form-reload-trigger',onTrigger1Click:function(){this.onTriggerClick();},onTrigger2Click:function(){this.expand();this.store.load();},initComponent:function(){this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.StorageLocation',proxy:PartKeepr.getRESTProxy("StorageLocation"),pageSize:-1,autoLoad:true});this.callParent();},setValue:function(val){if(val===0){return;}
this.callParent(arguments);}});
Ext.define('PartKeepr.Menu',{extend:'Ext.toolbar.Toolbar',items:[{}]});
Ext.define("PartKeepr.StorageLocationMultiCreateWindow",{extend:'Ext.Window',layout:'fit',width:500,height:250,title:i18n("Multi-Create Storage Locations"),initComponent:function(){this.form=Ext.create("PartKeepr.StorageLocationMultiAddDialog");this.items=[this.form];this.addButton=Ext.create("Ext.button.Button",{text:i18n("Create Storage Locations"),icon:'resources/silkicons/add.png',handler:this.onAddClick,scope:this});this.dockedItems=[{xtype:'toolbar',defaults:{minWidth:100},dock:'bottom',ui:'footer',pack:'start',items:[this.addButton,{text:i18n("Close"),handler:this.onCloseClick,scope:this,icon:'resources/silkicons/cancel.png'}]}];this.callParent();},onAddClick:function(){this.addButton.disable();var call=new PartKeepr.ServiceCall("StorageLocation","massCreate");call.setParameter("storageLocations",this.form.getStorageLocations());call.setHandler(Ext.bind(this.onAdded,this));call.doCall();},onAdded:function(response){this.addButton.enable();if(response.data.length>0){Ext.Msg.alert(i18n("Errors occured"),implode("<br>",response.data));}else{this.close();}},onCloseClick:function(){this.close();}});
Ext.define('PartKeepr.StorageLocationMultiAddDialog',{extend:'Ext.form.Panel',layout:'anchor',defaults:{anchor:'100%'},border:false,bodyStyle:'background:#DBDBDB;padding: 10px;',initComponent:function(){this.storageLocationPrefix=Ext.create("Ext.form.field.Text",{fieldLabel:i18n("Name Prefix"),listeners:{change:{fn:this.onFormChange,scope:this}}});this.storageLocationStart=Ext.create("Ext.form.field.Number",{fieldLabel:i18n("Start"),value:1,minValue:0,columnWidth:0.5,listeners:{change:{fn:this.onFormChange,scope:this}}});this.storageLocationEnd=Ext.create("Ext.form.field.Number",{fieldLabel:i18n("End"),value:10,minValue:1,columnWidth:0.5,margin:"0 0 0 5",listeners:{change:{fn:this.onFormChange,scope:this}}});this.storageLocationZeroPrefix=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Prefix with zeroes"),hideEmptyLabel:false,columnWidth:0.5,listeners:{change:{fn:this.onFormChange,scope:this}}});this.storageLocationOverallLength=Ext.create("Ext.form.field.Number",{fieldLabel:i18n("Length"),columnWidth:0.5,margin:"0 0 0 5",disabled:true,listeners:{change:{fn:this.onFormChange,scope:this}}});this.outputField=Ext.create("Ext.form.field.TextArea",{fieldLabel:i18n("Sample"),readOnly:true,anchor:'100% -70'});this.items=[this.storageLocationPrefix,{layout:'column',border:false,bodyStyle:'background:#DBDBDB;',items:[this.storageLocationStart,this.storageLocationEnd]},{layout:'column',border:false,plain:true,bodyStyle:'background:#DBDBDB;',items:[this.storageLocationZeroPrefix,this.storageLocationOverallLength]},this.outputField];this.callParent();this.recalculateDemo();},onFormChange:function(){if(this.storageLocationOverallLength.getValue()<this.getMinLength()){this.storageLocationOverallLength.setValue(this.getMinLength());}
if(this.storageLocationStart.getValue()>this.storageLocationEnd.getValue()){this.storageLocationEnd.setValue(this.storageLocationStart.getValue());}
if(this.storageLocationZeroPrefix.getValue()){this.storageLocationOverallLength.enable();}else{this.storageLocationOverallLength.disable();}
this.recalculateDemo();},getMinLength:function(){return strlen(this.storageLocationPrefix.getValue())+
strlen((this.storageLocationEnd.getValue()).toString());},recalculateDemo:function(){this.outputField.setValue(implode("\n",this.getStorageLocations()));},getStorageLocations:function(){var j=[];for(var i=this.storageLocationStart.getValue();i<this.storageLocationEnd.getValue()+1;i++){if(!this.storageLocationZeroPrefix.getValue()){j.push(this.storageLocationPrefix.getValue()+i);}else{var padLength=this.storageLocationOverallLength.getValue()-
(strlen(this.storageLocationPrefix.getValue())+
strlen(i));j.push(this.storageLocationPrefix.getValue()+str_repeat("0",padLength)+i);}}
return j;}});
Ext.define("PartKeepr.TipOfTheDayWindow",{extend:'Ext.window.Window',titleTemplate:i18n("Tip of the Day"),width:600,height:300,minWidth:600,minHeight:300,layout:'fit',currentTip:null,tipStore:null,initComponent:function(){this.title=this.titleTemplate;this.tipStore=PartKeepr.getApplication().getTipOfTheDayStore();this.tipDisplay=Ext.create("Ext.ux.SimpleIFrame",{border:false});this.items=this.tipDisplay;this.previousButton=Ext.create("Ext.button.Button",{text:i18n("Previous Tip"),handler:Ext.bind(this.displayPreviousTip,this),icon:'resources/icons/tip_previous.png',disabled:true});this.nextButton=Ext.create("Ext.button.Button",{text:i18n("Next Tip"),icon:'resources/icons/tip_next.png',handler:Ext.bind(this.displayNextTip,this)});this.showTipsCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Show Tips on login"),handler:Ext.bind(this.showTipsHandler,this)});this.displayReadTipsCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Show read tips"),handler:Ext.bind(this.showReadTipsHandler,this)});if(PartKeepr.getApplication().getUserPreference("partkeepr.tipoftheday.showtips")===false){this.showTipsCheckbox.setValue(false);}else{this.showTipsCheckbox.setValue(true);}
this.dockedItems=[{xtype:'toolbar',dock:'bottom',ui:'footer',defaults:{minWidth:100},pack:'start',items:[this.previousButton,this.nextButton,'->',this.showTipsCheckbox,this.displayReadTipsCheckbox]}];this.on("show",this.displayNextTip,this);this.on("destroy",this.onDestroy,this);this.callParent();},showReadTipsHandler:function(){this.updateButtons(this.currentTip);},onDestroy:function(){this.cancelReadTimer();},cancelReadTimer:function(){if(this.markAsReadTask){this.markAsReadTask.cancel();}},showTipsHandler:function(checkbox,checked){PartKeepr.getApplication().setUserPreference("partkeepr.tipoftheday.showtips",checked);},displayTip:function(record){this.cancelReadTimer();this.updateButtons(record);this.setTitle(this.titleTemplate+": "+record.get("name"));this.tipDisplay.setSrc(record.get("url"));this.markAsReadTask=new Ext.util.DelayedTask(this.markTipRead,this);this.markAsReadTask.delay(5000);},updateButtons:function(record){if(this.displayReadTipsCheckbox.getValue()===true){if(this.tipStore.indexOf(record)>0){this.previousButton.enable();}else{this.previousButton.disable();}
if(this.tipStore.indexOf(record)===this.tipStore.getTotalCount()-1){this.nextButton.disable();}else{this.nextButton.enable();}}else{if(this.tipStore.indexOf(record)>this.getFirstUnreadTip()){this.previousButton.enable();}else{this.previousButton.disable();}
if(this.tipStore.indexOf(record)>=this.getLastUnreadTip()){this.nextButton.disable();}else{this.nextButton.enable();}}},getFirstUnreadTip:function(){for(var i=0;i<this.tipStore.getTotalCount();i++){if(this.tipStore.getAt(i).get("read")===false){return i;}}
return null;},getLastUnreadTip:function(){for(var i=this.tipStore.getTotalCount()-1;i>-1;i--){if(this.tipStore.getAt(i).get("read")===false){return i;}}
return null;},markTipRead:function(){this.currentTip.set("read",true);this.currentTip.commit();var call=new PartKeepr.ServiceCall("TipOfTheDay","markTipAsRead");call.setLoadMessage(sprintf(i18n("Marking tip %s as read..."),this.currentTip.get("name")));call.setParameter("name",this.currentTip.get("name"));call.doCall();},displayNextTip:function(){this.retrieveTip("ASC");},displayPreviousTip:function(){this.retrieveTip("DESC");},retrieveTip:function(dir){var startIdx=-1,record=null;if(this.currentTip){startIdx=this.tipStore.indexOf(this.currentTip);}
if(dir==="ASC"){record=this.extractNextTip(startIdx);}else{record=this.extractPreviousTip(startIdx);}
if(record){this.currentTip=record;this.displayTip(record);}},extractNextTip:function(startIdx){var record=null,foundRecord=null;if(this.displayReadTipsCheckbox.getValue()===true){var tmpIdx=startIdx+1;if(tmpIdx>this.tipStore.getTotalCount()-1){tmpIdx=this.tipStore.getTotalCount()-1;}
foundRecord=this.tipStore.getAt(tmpIdx);}else{for(var i=startIdx+1;i<this.tipStore.getTotalCount();i++){record=this.tipStore.getAt(i);if(record.get("read")===false){foundRecord=record;break;}}}
return foundRecord;},extractPreviousTip:function(startIdx){var record=null,foundRecord=null;if(this.displayReadTipsCheckbox.getValue()===true){var tmpIdx=startIdx-1;if(tmpIdx<0){tmpIdx=0;}
foundRecord=this.tipStore.getAt(tmpIdx);}else{for(var i=startIdx-1;i>-1;i--){record=this.tipStore.getAt(i);if(record.get("read")===false){foundRecord=record;break;}}}
return foundRecord;}});
Ext.define('PartKeepr.ProjectReportView',{extend:'Ext.panel.Panel',alias:'widget.ProjectReportView',bodyStyle:'background:#DBDBDB;padding: 5px',border:false,defaults:{bodyStyle:'padding:10px'},layout:'border',initComponent:function(){this.createStores();this.upperGridEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.reportList=Ext.create("PartKeepr.BaseGrid",{selModel:{mode:'MULTI'},selType:'checkboxmodel',flex:1,columns:[{header:i18n("Amount"),dataIndex:'amount',width:50,editor:{xtype:'numberfield'}},{header:i18n("Project Name"),dataIndex:'name',flex:1},{header:i18n("Description"),dataIndex:'description',flex:1}],store:this.store,plugins:[this.upperGridEditing]});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.reportResult=Ext.create("PartKeepr.BaseGrid",{flex:1,features:[{ftype:'summary'}],columns:[{header:i18n("Quantity"),dataIndex:'quantity',width:50},{header:i18n("Part"),renderer:function(val,p,rec){return rec.part().getAt(0).get("name");},flex:1},{header:i18n("Remarks"),dataIndex:'remarks',flex:1},{header:i18n("Projects"),dataIndex:'projects',flex:1},{header:i18n("Storage Location"),dataIndex:'storageLocation_name',width:100},{header:i18n("Available"),dataIndex:'available',width:75},{header:i18n("Distributor"),dataIndex:'distributor_id',renderer:function(val,p,rec){return rec.get("distributor_name");},flex:1,editor:{xtype:'DistributorComboBox',triggerAction:'query',ignoreQuery:true,forceSelection:true,editable:false}},{header:i18n("Distributor Order Number"),dataIndex:'distributor_order_number',flex:1,editor:{xtype:'textfield'}},{header:i18n("Price per Item"),dataIndex:'price',renderer:PartKeepr.getApplication().formatCurrency,width:100},{header:i18n("Sum"),dataIndex:'sum',renderer:PartKeepr.getApplication().formatCurrency,summaryType:'sum',summaryRenderer:PartKeepr.getApplication().formatCurrency,width:100},{header:i18n("Amount to Order"),dataIndex:'missing',width:100},{header:i18n("Sum (Order)"),dataIndex:'sum_order',renderer:PartKeepr.getApplication().formatCurrency,summaryType:'sum',summaryRenderer:PartKeepr.getApplication().formatCurrency,width:100}],store:this.projectReportStore,plugins:[this.editing]});this.reportResult.on("beforeedit",this.onBeforeEdit,this);this.reportResult.on("edit",this.onEdit,this);this.createReportButton=Ext.create('Ext.button.Button',{xtype:'button',text:i18n("Create Report"),width:120,margins:{right:10},listeners:{click:this.onCreateReportClick,scope:this}});this.autoFillButton=Ext.create('Ext.button.Button',{text:i18n("Autofill"),width:120,margins:{right:20},listeners:{click:this.onAutoFillClick,scope:this}});this.removeStockButton=Ext.create('Ext.button.Button',{text:i18n("Remove parts from stock"),width:160,listeners:{click:this.onStockRemovalClick,scope:this}});this.items=[{title:i18n("Choose Projects to create a report for"),split:true,minHeight:300,height:300,bodyStyle:'background:#DBDBDB;padding: 10px;',layout:{type:'vbox',align:'stretch',pack:'start'},region:'north',items:[this.reportList,{layout:{type:'hbox',pack:'start'},margins:{top:10},border:false,bodyStyle:'background:#DBDBDB',items:[this.createReportButton,this.autoFillButton,{xtype:'tbspacer'},this.removeStockButton]}]},{region:'center',layout:'fit',bodyStyle:'background:#DBDBDB;padding: 10px;',title:i18n("Project Report"),items:this.reportResult}];this.callParent();},onBeforeEdit:function(e){if(e.field!=="distributor_id"){return;}
var distributors=e.record.part().getAt(0).distributors();var filterIds=new Array();for(var i=0;i<distributors.count();i++){filterIds.push(distributors.getAt(i).get("distributor_id"));}
e.column.getEditor().store.clearFilter();e.column.getEditor().store.filter({filterFn:function(item){for(var i=0;i<filterIds.length;i++){if(item.get("id")==filterIds[i]){return true;}}
return false;}});},onStockRemovalClick:function(){Ext.Msg.confirm(i18n("Remove parts from stock"),i18n("Do you really want to remove the parts in the project report from the stock?"),this.removeStocks,this);},removeStocks:function(btn){if(btn=="yes"){var store=this.reportResult.getStore();var removals=[];for(var i=0;i<store.count();i++){var item=store.getAt(i);removals.push({part:item.part().getAt(0).get("id"),amount:item.get("quantity"),comment:item.get("projects")});}
var call=new PartKeepr.ServiceCall("Part","massDeleteStock");call.setParameter("removals",removals);call.doCall();}},onEdit:function(editor,e){if(e.field=="distributor_id"){var distributors=e.record.part().getAt(0).distributors();for(var i=0;i<distributors.count();i++){if(distributors.getAt(i).get("distributor_id")==e.value){e.record.set("distributor_name",distributors.getAt(i).get("distributor_name"));e.record.set("price",distributors.getAt(i).get("price"));e.record.set("distributor_order_number",distributors.getAt(i).get("orderNumber"));e.record.set("sum_order",e.record.get("missing")*e.record.get("price"));e.record.set("sum",e.record.get("quantity")*e.record.get("price"));}}}
this.reportResult.getView().refresh(true);},onAutoFillClick:function(){for(var i=0;i<this.reportResult.store.count();i++){var activeRecord=this.reportResult.store.getAt(i);var cheapest=null;var cheapestPrice=null;for(var j=0;j<activeRecord.part().getAt(0).distributors().count();j++){var activeDistributor=activeRecord.part().getAt(0).distributors().getAt(j);if(cheapestPrice===null&&parseFloat(activeDistributor.get("price"))!==0){cheapestPrice=activeDistributor.get("price");cheapest=activeDistributor;}else{if(parseFloat(activeDistributor.get("price"))!==0&&parseFloat(activeDistributor.get("price"))<cheapestPrice){cheapestPrice=activeDistributor.get("price");cheapest=activeDistributor;}}}
if(cheapest!==null){activeRecord.set("distributor_name",cheapest.get("distributor_name"));activeRecord.set("distributor_order_number",cheapest.get("orderNumber"));activeRecord.set("price",cheapest.get("price"));activeRecord.set("sum_order",activeRecord.get("missing")*activeRecord.get("price"));activeRecord.set("sum",activeRecord.get("quantity")*activeRecord.get("price"));}}
this.reportResult.getView().refresh(true);},onCreateReportClick:function(){selection=this.reportList.getSelectionModel().getSelection();var params=new Array();for(var i=0;i<selection.length;i++){params.push({project:selection[i].get("id"),amount:selection[i].get("amount")});}
this.projectReportStore.getProxy().extraParams.reports=Ext.encode(params);this.projectReportStore.load();},createStores:function(){var config={autoLoad:true,model:"PartKeepr.ProjectReportList",pageSize:-1};this.store=Ext.create('Ext.data.Store',config);this.projectReportStore=Ext.create('Ext.data.Store',{model:"PartKeepr.ProjectReport",pageSize:-1});}});
Ext.define('PartKeepr.picker.Char',{extend:'Ext.Component',requires:'Ext.XTemplate',alias:'widget.charpicker',componentCls:Ext.baseCSSPrefix+'char-picker',selectedCls:Ext.baseCSSPrefix+'char-picker-selected',value:null,clickEvent:'click',allowReselect:false,chars:[' ','&','"','¢','€','£','¥','©','®','™','‰','µ','·','•','…','′','″','§','¶','ß','‹','›','«','»','‘','’','“','”','‚','„','<','>','≤','≥','–','—','¯','‾','¤','¦','¨','¡','¿','ˆ','˜','°','−','±','÷','⁄','×','¹','²','³','¼','½','¾','ƒ','∫','∑','∞','√','≈','≠','≡','∏','¬','∩','∂','´','¸','ª','º','†','‡','À','Á','Â','Ã','Ä','Å','Æ','Ç','È','É','Ê','Ë','Ì','Í','Î','Ï','Ð','Ñ','Ò','Ó','Ô','Õ','Ö','Ø','Œ','Š','Ù','Ú','Û','Ü','Ý','Ÿ','Þ','à','á','â','ã','ä','å','æ','ç','è','é','ê','ë','ì','í','î','ï','ð','ñ','ò','ó','ô','õ','ö','ø','œ','š','ù','ú','û','ü','ý','þ','ÿ','Α','Β','Γ','Δ','Ε','Ζ','Η','Θ','Ι','Κ','Λ','Μ','Ν','Ξ','Ο','Π','Ρ','Σ','Τ','Υ','Φ','Χ','Ψ','Ω','α','β','γ','δ','ε','ζ','η','θ','ι','κ','λ','μ','ν','ξ','ο','π','ρ','ς','σ','τ','υ','φ','χ','ψ','ω','←','↑','→','↓','↔','◊','♠','♣','♥','♦','⌀','∅'],renderTpl:['<tpl for="chars">','<a href="#" hidefocus="on">','<em><span unselectable="on">{.}</span></em>','</a>','</tpl>'],initComponent:function(){var me=this;me.callParent(arguments);me.addEvents('select');if(me.handler){me.on('select',me.handler,me.scope,true);}},onRender:function(container,position){var me=this,clickEvent=me.clickEvent;Ext.apply(me.renderData,{itemCls:me.itemCls,chars:me.chars});me.callParent(arguments);me.mon(me.el,clickEvent,me.handleClick,me,{delegate:'a'});if(clickEvent!='click'){me.mon(me.el,'click',Ext.emptyFn,me,{delegate:'a',stopEvent:true});}},afterRender:function(){var me=this,value;me.callParent(arguments);if(me.value){value=me.value;me.value=null;me.select(value,true);}},handleClick:function(event,target){var me=this;event.stopEvent();if(!me.disabled){var el=Ext.get(target);me.select(el.down("span").dom.textContent);}},select:function(chr,suppressEvent){var me=this,selectedCls=me.selectedCls,value=me.value,el;if(!me.rendered){me.value=chr;return;}
if(chr!=value||me.allowReselect){me.value=chr;if(suppressEvent!==true){me.fireEvent('select',me,chr);}}},getValue:function(){return this.value||null;}});
Ext.define('PartKeepr.TimeDisplay',{extend:'Ext.Toolbar.TextItem',el:null,dt:null,enable:Ext.emptyFn,disable:Ext.emptyFn,focus:Ext.emptyFn,beforeRender:function(){this.callParent();Ext.defer(this.onUpdate,240,this);},onUpdate:function(obj){var dt=new Date();this.setText(Ext.Date.format(dt,Ext.getDateFormat()));delete dt;Ext.defer(this.onUpdate,240,this);}});
Ext.define("PartKeepr.CategoryTreeStore",{extend:"Ext.data.TreeStore",model:'PartKeepr.Category',root:{text:'Ext JS',id:'src',expanded:true},constructor:function(){Ext.apply(this,{proxy:{type:'ajax',url:PartKeepr.getBasePath()+'/Category',method:'POST',extraParams:{call:'getCategories'},reader:{type:'json',root:'response'}}});this.proxy.extraParams.session=PartKeepr.getSession();this.callParent();},folderSort:true});
Ext.define('PartKeepr.MenuBar',{extend:'Ext.toolbar.Toolbar',initComponent:function(){this.ui="mainmenu";this.editMenu=Ext.create('Ext.menu.Menu',{items:[{text:i18n('Projects'),icon:'resources/fugue-icons/icons/drill.png',handler:this.editProjects},{text:i18n('Footprints'),icon:'resources/fugue-icons/icons/fingerprint.png',handler:this.editFootprints},{text:i18n('Manufacturers'),icon:'resources/silkicons/building.png',handler:this.editManufacturers},{text:i18n('Storage Locations'),icon:'resources/fugue-icons/icons/wooden-box.png',handler:this.editStorageLocations},{text:i18n('Distributors'),icon:'resources/silkicons/lorry.png',handler:this.editDistributors},{text:i18n('Users'),id:'edit-users',handler:this.editUsers,icon:"resources/silkicons/user.png"},{text:i18n('Part Measure Units'),handler:this.editPartUnits,icon:"resources/fugue-icons/icons/ruler.png"},{text:i18n("Units"),handler:this.editUnits,icon:'resources/icons/unit.png'}]});this.viewMenu=Ext.create('Ext.menu.Menu',{items:[{text:i18n("Statistics"),icon:'resources/silkicons/chart_bar.png',menu:[{text:i18n("Summary"),handler:this.showStatisticsSummary,icon:'resources/silkicons/chart_bar.png'},{text:i18n("Chart"),handler:this.showStatisticsChart,icon:'resources/silkicons/chart_bar.png'}]},{text:i18n("System Information"),handler:this.showSystemInformation,icon:'resources/fugue-icons/icons/system-monitor.png'},{text:i18n("Project Reports"),handler:this.showProjectReports,icon:'resources/fugue-icons/icons/drill.png'},{text:i18n("System Notices"),handler:this.showSystemNotices,icon:'resources/fugue-icons/icons/service-bell.png'},{text:i18n("Stock History"),handler:this.showStockHistory,icon:'resources/fugue-icons/icons/notebook.png'}]});this.systemMenu=Ext.create('Ext.menu.Menu',{items:[{text:i18n('Disconnect'),icon:'resources/silkicons/disconnect.png',handler:this.disconnect},{text:i18n("User Preferences"),icon:'resources/fugue-icons/icons/gear.png',handler:this.showUserPreferences}]});this.items=[{text:i18n("System"),menu:this.systemMenu},{text:i18n('Edit'),menu:this.editMenu},{text:i18n('View'),menu:this.viewMenu},'->',{xtype:'tbtext',cls:'partkeepr-logo-align',text:'<div class="partkeepr-logo">PartKeepr</div>'},{xtype:'tbtext',text:'<img style="float: left;" src="resources/images/partkeepr-logo.png"/>'}];this.callParent();},showUserPreferences:function(){var j=new PartKeepr.UserPreferencePanel({iconCls:'icon-gear',closable:true});PartKeepr.getApplication().addItem(j);j.show();},disconnect:function(){PartKeepr.getApplication().logout();},showSystemInformation:function(){var j=Ext.create("PartKeepr.SystemInformationGrid",{title:i18n("System Information"),iconCls:'icon-system-monitor',closable:true,padding:"5 5 5 5"});PartKeepr.getApplication().addItem(j);j.show();},showStatisticsSummary:function(){var j=Ext.create("PartKeepr.CurrentStatisticsPanel",{iconCls:'icon-chart-bar',closable:true});PartKeepr.getApplication().addItem(j);j.show();},showStatisticsChart:function(){var j=Ext.create("PartKeepr.StatisticsChartPanel",{iconCls:'icon-chart-bar',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editStorageLocations:function(){var j=Ext.create("PartKeepr.StorageLocationEditorComponent",{title:i18n("Storage Locations"),iconCls:'icon-wooden-box',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editUnits:function(){var j=Ext.create("PartKeepr.UnitEditorComponent",{title:i18n("Units"),iconCls:'icon-unit',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editManufacturers:function(){var j=Ext.create("PartKeepr.ManufacturerEditorComponent",{title:i18n("Manufacturers"),iconCls:'icon-building',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editFootprints:function(){var j=Ext.create("PartKeepr.FootprintEditorComponent",{title:i18n("Footprints"),iconCls:'icon-footprint',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editDistributors:function(){var j=Ext.create("PartKeepr.DistributorEditorComponent",{title:i18n("Distributors"),iconCls:'icon-lorry',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editUsers:function(){var j=Ext.create("PartKeepr.UserEditorComponent",{title:i18n("Users"),iconCls:'icon-user',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editPartUnits:function(){var j=Ext.create("PartKeepr.PartUnitEditorComponent",{title:i18n("Part Measurement Units"),iconCls:'icon-ruler',closable:true});PartKeepr.getApplication().addItem(j);j.show();},editProjects:function(){var j=Ext.create("PartKeepr.ProjectEditorComponent",{title:i18n("Projects"),iconCls:'icon-drill',closable:true});PartKeepr.getApplication().addItem(j);j.show();},showProjectReports:function(){var j=Ext.create("PartKeepr.ProjectReportView",{title:i18n("Project Reports"),iconCls:'icon-drill',closable:true});PartKeepr.getApplication().addItem(j);j.show();},showSystemNotices:function(){var j=Ext.create("PartKeepr.SystemNoticeEditorComponent",{title:i18n("System Notices"),iconCls:'icon-service-bell',closable:true});PartKeepr.getApplication().addItem(j);j.show();},showStockHistory:function(){var j=Ext.create("PartKeepr.StockHistoryGrid",{title:i18n("Stock History"),iconCls:'icon-notebook',closable:true});PartKeepr.getApplication().addItem(j);j.show();},displayComponent:function(component){var j=Ext.create(component.type,{title:component.title,iconCls:component.iconCls,closable:component.closable});PartKeepr.getApplication().addItem(j);j.show();}});
Ext.define("PartKeepr.CategoryTree",{alias:'widget.CategoryTree',extend:'Ext.tree.Panel',categoryService:null,categoryModel:null,sorters:[{property:'name',direction:'ASC'}],viewConfig:{animate:false},loaded:false,rootVisible:false,initComponent:function(){this.store=new Ext.data.TreeStore({root:{id:"src",name:"Foo"},remoteSort:false,folderSort:true});this.callParent();this.addEvents("categoriesLoaded");this.loadCategories();},loadCategories:function(){this.loaded=false;var call=new PartKeepr.ServiceCall(this.categoryService,"getAllCategories");call.setLoadMessage(i18n("Loading categories..."));call.setHandler(Ext.bind(this._onCategoriesLoaded,this));call.doCall();},_onCategoriesLoaded:function(result){var expandedNodes=this.getExpandedNodes(this.getRootNode());this.getRootNode().removeAll();this.buildCategoryTree(this.getRootNode(),result,expandedNodes);this.loaded=true;this.getRootNode().expandChildren();this.getStore().sort("name","ASC");this.fireEvent("categoriesLoaded");},getExpandedNodes:function(node){var ret=[];if(node.get("expanded")===true){ret.push(node.get("id"));}
for(var i=0;i<node.childNodes.length;i++){ret=ret.concat(this.getExpandedNodes(node.childNodes[i]));}
return ret;},buildCategoryTree:function(root,data,expandedNodes){var label;if(data.description&&PartKeepr.getApplication().getUserPreference("partkeepr.categorytree.showdescriptions")===true)
{label=data.name+" - "+data.description;}else{label=data.name;}
var nodeData={id:data.id,name:data.name,description:data.description,text:label,tooltip:data.description};if(Ext.Array.contains(expandedNodes,data.id)){Ext.apply(nodeData,{expanded:true});}
if(data.id==1){nodeData.allowDrag=false;}
nodeData.leaf=false;Ext.data.NodeInterface.decorate(this.categoryModel);var newNode=Ext.create(this.categoryModel,nodeData);newNode=root.appendChild(newNode);for(var i=0;i<data.children.length;i++){this.buildCategoryTree(newNode,data.children[i],expandedNodes);}
return newNode;}});
Ext.define("PartKeepr.CategoryEditorTree",{alias:'widget.CategoryEditorTree',extend:'PartKeepr.CategoryTree',ddGroup:null,categoryModel:null,categoryService:null,initComponent:function(){if(this.ddGroup!==null){Ext.apply(this,{viewConfig:{animate:false,plugins:{ptype:'treeviewdragdrop',ddGroup:this.ddGroup}}});}
this.createToolbar();this.callParent();this.getView().on("drop",Ext.bind(this.onCategoryDrop,this));this.getView().on("beforedrop",this.onBeforeDrop,this);this.getView().on("itemcontextmenu",Ext.bind(this.onItemContextMenu,this));this.createMenu();},onBeforeDrop:function(){},onCategoryDrop:function(node,data,model,pos){var draggedRecord=data.records[0];var droppedOn=this.getView().getRecord(node);if(!draggedRecord.isCategory){return;}else{var targetRecord;if(pos=="after"||pos=="before"){targetRecord=droppedOn.parentNode;}else{targetRecord=droppedOn;}
this.getStore().sort("name","ASC");var call=new PartKeepr.ServiceCall(this.categoryService,"moveCategory");call.setLoadMessage(sprintf(i18n("Moving category %s..."),draggedRecord.get("name")));call.setParameter("category",draggedRecord.get("id"));call.setParameter("target",targetRecord.get("id"));call.doCall();}},onItemContextMenu:function(view,record,item,index,event){if(!record.isCategory){return;}
var menu=this.menu;event.stopEvent();menu.record=record;this.menuCategoryDelete.enable();if(record.get("id")==1){this.menuCategoryDelete.disable();}
if(record.hasChildNodes()){this.menuCategoryDelete.disable();}
menu.showAt(event.getXY());},createMenu:function(){this.menuCategoryDelete=Ext.create("Ext.menu.Item",{text:i18n("Delete Category"),handler:Ext.bind(this.confirmCategoryDelete,this),icon:'resources/silkicons/folder_delete.png'});this.menuCategoryAdd=Ext.create("Ext.menu.Item",{text:i18n("Add Category"),handler:Ext.bind(this.showCategoryAddDialog,this),icon:'resources/silkicons/folder_add.png'});this.menuCategoryEdit=Ext.create("Ext.menu.Item",{text:i18n("Edit Category"),handler:Ext.bind(this.showCategoryEditDialog,this),icon:'resources/silkicons/folder_edit.png'});this.menu=Ext.create('widget.menu',{items:[this.menuCategoryAdd,this.menuCategoryEdit,this.menuCategoryDelete]});},createToolbar:function(){this.toolbarExpandButton=Ext.create("Ext.button.Button",{icon:'resources/fugue-icons/icons/toggle-expand.png',tooltip:i18n("Expand All"),handler:this._onExpandClick,scope:this});this.toolbarCollapseButton=Ext.create("Ext.button.Button",{icon:'resources/fugue-icons/icons/toggle.png',tooltip:i18n("Collapse All"),handler:this._onCollapseClick,scope:this});this.toolbarReloadButton=Ext.create("Ext.button.Button",{icon:'extjs/resources/themes/images/default/grid/refresh.gif',tooltip:i18n("Reload"),handler:this._onReloadClick,scope:this});this.toolbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,dock:'top',items:[this.toolbarExpandButton,this.toolbarCollapseButton,this.toolbarReloadButton]});Ext.apply(this,{dockedItems:[this.toolbar]});},_onReloadClick:function(){this.loadCategories();},_onExpandClick:function(){this.getRootNode().firstChild.expand(true);},_onCollapseClick:function(){this.getRootNode().firstChild.collapse(true);},confirmCategoryDelete:function(){Ext.Msg.confirm(i18n("Confirm Category Delete"),sprintf(i18n("Do you really wish to delete the category %s?"),this.menu.record.get("name")),this.onCategoryDelete,this);},showCategoryAddDialog:function(){var j=Ext.create("PartKeepr.CategoryEditorWindow",{record:null,categoryModel:this.categoryModel,parent:this.menu.record.get("id"),listeners:{save:Ext.bind(this.onUpdateRecord,this)}});j.show();},showCategoryEditDialog:function(){var j=Ext.create("PartKeepr.CategoryEditorWindow",{record:this.menu.record,parent:null,categoryModel:this.categoryModel,listeners:{save:Ext.bind(this.onUpdateRecord,this)}});j.show();},onUpdateRecord:function(record){var currentRecord=this.getStore().getRootNode().findChild("id",record.get("id"),true);var label;if(PartKeepr.getApplication().getUserPreference("partkeepr.categorytree.showdescriptions")===true){label=record.get("name")+" - "+record.get("description");}else{label=record.get("name");}
if(currentRecord===null){var parentRecord=this.getStore().getRootNode().findChild("id",record.get("parent"),true);var nodeData={id:record.get("id"),name:record.get("name"),description:record.get("description"),text:label,tooltip:record.get("description")};parentRecord.appendChild(nodeData);}else{currentRecord.set("name",record.get("name"));currentRecord.set("description",record.get("description"));currentRecord.set("text",label);currentRecord.set("tooltip",record.get("description"));currentRecord.commit();}},onCategoryDelete:function(btn){if(btn=="yes"){var del=this.getStore().getRootNode().findChild("id",this.menu.record.get("id"),true);del.destroy({failure:function(){this.loadCategories();},scope:this});}}});
Ext.define("PartKeepr.PartCategoryTree",{extend:'PartKeepr.CategoryEditorTree',alias:'widget.PartCategoryTree',ddGroup:'PartTree',categoryModel:'PartKeepr.PartCategory',categoryService:'PartCategory',initComponent:function(){this.addEvents("syncCategory");this.callParent();this.syncButton=Ext.create("Ext.button.Button",{tooltip:i18n("Reveal Category for selected part"),icon:'resources/fugue-icons/icons/arrow-split-180.png',handler:Ext.bind(function(){this.fireEvent("syncCategory");},this),disabled:true});this.toolbar.add(['->',this.syncButton]);},onBeforeDrop:function(node,data,overModel,dropPosition,dropFunction,options){var draggedRecord=data.records[0];var droppedOn=this.getView().getRecord(node);if(draggedRecord.modelName=="PartKeepr.Part"){var call=new PartKeepr.ServiceCall("Part","movePart");if(data.records.length>1){var sources=[];for(var i=0;i<data.records.length;i++){sources.push(data.records[i].get("id"));}
call.setParameter("parts",sources);}else{call.setParameter("part",draggedRecord.get("id"));}
call.setParameter("targetCategory",droppedOn.get("id"));call.setHandler(function(){data.view.store.load();});call.doCall();return false;}}});
Ext.define("PartKeepr.FootprintTree",{extend:'PartKeepr.CategoryEditorTree',alias:'widget.FootprintTree',ddGroup:'FootprintTree',categoryModel:'PartKeepr.FootprintCategory',categoryService:'FootprintCategory',folderSort:true,addButtonIcon:'resources/icons/footprint_add.png',deleteButtonIcon:'resources/icons/footprint_delete.png',initComponent:function(){this.callParent();this.addEvents("itemEdit");this.on("itemclick",Ext.bind(function(t,record){if(record.self.getName()=="PartKeepr.Footprint"){this.fireEvent("itemEdit",record.get("id"));}},this));this.addButton=Ext.create("Ext.button.Button",{tooltip:i18n("Add Footprint"),icon:this.addButtonIcon,handler:this._onAddFootprint,scope:this});this.deleteButton=Ext.create("Ext.button.Button",{tooltip:i18n("Delete Footprint"),icon:this.deleteButtonIcon,handler:Ext.bind(function(){this.fireEvent("itemDelete");},this),disabled:true});this.toolbar.add(['-',this.addButton,this.deleteButton]);this.getSelectionModel().on("select",this._onItemSelect,this);this.getSelectionModel().on("deselect",this._onItemDeselect,this);},_onAddFootprint:function(){var record=this.getSelectionModel().getLastSelected();if(!record){this.fireEvent("itemAdd",{category:this.getRootNode().get("id")});}
if(record.self.getName()=="PartKeepr.FootprintCategory"){this.fireEvent("itemAdd",{category:record.get("id")});}else{if(record.parentNode&&record.parentNode.self.getName()=="PartKeepr.FootprintCategory"){this.fireEvent("itemAdd",{category:record.parentNode.get("id")});}else{this.fireEvent("itemAdd",{category:this.getRootNode().get("id")});}}},_onItemSelect:function(selectionModel,record){this._updateDeleteButton(selectionModel,record);this.fireEvent("itemSelect",record);},_onItemDeselect:function(selectionModel,record){this._updateDeleteButton(selectionModel,record);this.fireEvent("itemDeselect",record);},_updateDeleteButton:function(selectionModel,record){if(this.getSelectionModel().getCount()==1&&record.self.getName()=="PartKeepr.Footprint"){this.deleteButton.enable();}else{this.deleteButton.disable();}},syncChanges:function(record){var oldRecordIndex=PartKeepr.getApplication().getFootprintStore().find("id",record.get("id"));if(oldRecordIndex===-1){PartKeepr.getApplication().getFootprintStore().add(record);}else{var oldRecord=PartKeepr.getApplication().getFootprintStore().getAt(oldRecordIndex);oldRecord.set("name",record.get("name"));}
this.loadCategories();},_onCategoriesLoaded:function(){this.callParent(arguments);var store=PartKeepr.getApplication().getFootprintStore();var nodeData,record;Ext.data.NodeInterface.decorate("PartKeepr.Footprint");for(var i=0;i<store.getCount();i++){record=store.getAt(i);nodeData={text:record.getRecordName(),id:record.get("id"),leaf:true,iconCls:'icon-footprint'};var newNode=Ext.create("PartKeepr.Footprint",nodeData);if(record.get("category")===0){this.getRootNode().firstChild.appendChild(newNode);}else{var node=this.getRootNode().findChildBy(function(){if(this.self.getName()=="PartKeepr.FootprintCategory"&&this.get("id")==record.get("category")){return true;}else{return false;}},false,true);if(node){node.appendChild(newNode);}else{this.getRootNode().firstChild.appendChild(newNode);}}}},onBeforeDrop:function(node,data,overModel,dropPosition,dropFunction,options){var draggedRecord=data.records[0];var droppedOn=this.getView().getRecord(node);if(droppedOn.self.getName()=="PartKeepr.Footprint"){return false;}
if(draggedRecord.self.getName()=="PartKeepr.Footprint"){var call=new PartKeepr.ServiceCall("Footprint","moveFootprint");call.setParameter("id",draggedRecord.get("id"));call.setParameter("targetCategory",droppedOn.get("id"));call.setHandler(Ext.bind(function(){var sourceNode=this.getRootNode().findChildBy(function(){if(this.self.getName()=="PartKeepr.Footprint"&&this.get("id")==draggedRecord.get("id")){return true;}else{return false;}},false,true);var targetNode=this.getRootNode().findChildBy(function(){if(this.self.getName()=="PartKeepr.FootprintCategory"&&this.get("id")==droppedOn.get("id")){return true;}else{return false;}},false,true);targetNode.expand();sourceNode.remove();targetNode.appendChild(sourceNode);var oldRecordIndex=PartKeepr.getApplication().getFootprintStore().find("id",draggedRecord.get("id"));var oldRecord=PartKeepr.getApplication().getFootprintStore().getAt(oldRecordIndex);oldRecord.set("category",droppedOn.get("id"));},this));call.doCall();return false;}}});
Ext.define('PartKeepr.LoginDialog',{extend:'Ext.Window',title:i18n("PartKeepr: Login"),width:400,height:125,modal:true,resizable:false,layout:'anchor',bodyStyle:'padding: 5px;',initComponent:function(){this.loginField=Ext.ComponentMgr.create({xtype:'textfield',value:"",fieldLabel:i18n("Username"),anchor:'100%'});this.passwordField=Ext.ComponentMgr.create({xtype:'textfield',inputType:"password",value:"",fieldLabel:i18n("Password"),anchor:'100%'});Ext.apply(this,{items:[this.loginField,this.passwordField],dockedItems:[{xtype:'toolbar',enableOverflow:false,dock:'bottom',ui:'footer',pack:'start',defaults:{minWidth:100},items:[{text:i18n("Connect"),icon:'resources/silkicons/connect.png',handler:Ext.bind(this.login,this)},{text:i18n("Close"),handler:Ext.bind(this.close,this),icon:'resources/silkicons/cancel.png'}]}]});this.callParent(arguments);this.on("render",this.assignEnterKey,this);this.on("show",function(){this.loginField.focus();},this,{delay:100});},assignEnterKey:function(){var keyMap=this.getKeyMap();keyMap.on(Ext.EventObject.ENTER,this.login,this);},login:function(){this.fireEvent("login",this.loginField.getValue(),this.passwordField.getValue());}});
Ext.define('PartKeepr.ContextMenu.CharPicker',{extend:'Ext.menu.Menu',alias:'widget.charpickermenu',hideOnClick:true,pickerId:null,initComponent:function(){var me=this,cfg=Ext.apply({},me.initialConfig);delete cfg.listeners;Ext.apply(me,{plain:true,showSeparator:false,items:Ext.applyIf({cls:Ext.baseCSSPrefix+'menu-char-item',id:me.pickerId,xtype:'charpicker'},cfg)});me.callParent(arguments);me.picker=me.down('charpicker');me.relayEvents(me.picker,['select']);if(me.hideOnClick){me.on('select',me.hidePickerOnSelect,me);}},hidePickerOnSelect:function(){Ext.menu.Manager.hideAll();}});
Ext.define("PartKeepr.GridMenuPlugin",{alias:'plugin.gridmenu',grid:null,init:function(grid){this.grid=grid;this.menu=new Ext.menu.Menu({floating:true,renderTo:Ext.getBody(),items:[{text:i18n("Export"),icon:'resources/fugue-icons/icons/application-export.png',menu:[{icon:'resources/mimetypes/csv.png',text:'Export as CSV (.csv)',handler:this.exportCSV,scope:this},{icon:'resources/fugue-icons/icons/blue-document-excel.png',text:'Export as Excel XML (.xlsx)',handler:this.exportXLSX,scope:this},{icon:'resources/icons/mediawiki_icon.png',text:'Export as MediaWiki table (.txt)',handler:this.exportWiki,scope:this}]}]});grid.on("itemcontextmenu",function(view,record,item,index,e,eOpts){this.menu.showAt(e.xy[0],e.xy[1]);},this);grid.on("containercontextmenu",function(view,e,eOpts){this.menu.showAt(e.xy[0],e.xy[1]);},this);},exportCSV:function(){this.doExport(Ext.ux.exporter.Exporter.exportAny(this.grid,"csv",{}),this.getExportFilename()+".csv");},exportWiki:function(){this.doExport(Ext.ux.exporter.Exporter.exportAny(this.grid,"wiki",{}),this.getExportFilename()+".txt");},exportXLSX:function(){this.doExport(Ext.ux.exporter.Exporter.exportAny(this.grid,"excel",{}),this.getExportFilename()+".xlsx");},getExportFilename:function(){return this.grid.title;},doExport:function(data,filename){var call=new PartKeepr.ServiceCall("TempFile","jsonUpload");call.setParameter("filedata",Ext.ux.exporter.Base64.encode(data));call.setParameter("filename",filename);call.setHandler(function(response){var loc="file.php?type=temp&download=true&id=TMP:"+response.id;window.location.href=loc;});call.doCall();}});
Ext.define('PartKeepr.BaseGrid',{extend:'Ext.grid.Panel',alias:'widget.BaseGrid',initComponent:function(){if(this.plugins){this.plugins.push('gridmenu');}else{this.plugins=['gridmenu'];}
this.callParent();}});
Ext.define('PartKeepr.PartManufacturerGrid',{extend:'PartKeepr.BaseGrid',alias:'widget.PartManufacturerGrid',border:false,initComponent:function(){this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.PartManufacturer',proxy:{type:'memory',reader:{type:'json'}}});this.editing=Ext.create('Ext.grid.plugin.RowEditing',{clicksToEdit:1});this.plugins=[this.editing];this.deleteButton=Ext.create("Ext.button.Button",{text:'Delete',disabled:true,itemId:'delete',scope:this,icon:'resources/silkicons/building_delete.png',handler:this.onDeleteClick});this.dockedItems=[{xtype:'toolbar',items:[{text:'Add',scope:this,icon:'resources/silkicons/building_add.png',handler:this.onAddClick},this.deleteButton]}];this.columns=[{header:i18n("Manufacturer"),dataIndex:'manufacturer_id',xtype:'templatecolumn',tpl:'{manufacturer_name}',flex:0.4,editor:{xtype:'ManufacturerComboBox',allowBlank:true}},{header:i18n("Part Number"),dataIndex:'partNumber',flex:0.4,editor:{xtype:'textfield',allowBlank:true}}];this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.on("edit",this.onEdit,this);},onEdit:function(editor,data){var id=data.record.get("manufacturer_id");var rec=PartKeepr.getApplication().getManufacturerStore().findRecord("id",id);if(rec){data.record.set("manufacturer_name",rec.get("name"));}},onAddClick:function(){this.editing.cancelEdit();var rec=new PartKeepr.PartManufacturer({packagingUnit:1});this.store.insert(0,rec);this.editing.startEdit(0,0);},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.store.remove(selection);}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);}});
Ext.define('PartKeepr.PartDistributorGrid',{extend:'PartKeepr.BaseGrid',alias:'widget.PartDistributorGrid',border:false,initComponent:function(){this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.PartDistributor',proxy:{type:'memory',reader:{type:'json'}}});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1,listeners:{beforeedit:function(editor,e,eOpts){if(e.field=="packagePrice"){e.record.set("packagePrice",e.record.get("price")*e.record.get("packagingUnit"));}},edit:function(editor,e,eOpts){if(e.field=="packagePrice"&&e.record.get("packagingUnit")){e.record.set("price",e.value/e.record.get("packagingUnit"));}},scope:this}});this.plugins=[this.editing];this.deleteButton=Ext.create("Ext.button.Button",{text:'Delete',disabled:true,itemId:'delete',scope:this,icon:'resources/silkicons/lorry_delete.png',handler:this.onDeleteClick});this.dockedItems=[{xtype:'toolbar',items:[{text:'Add',scope:this,icon:'resources/silkicons/lorry_add.png',handler:this.onAddClick},this.deleteButton]}];this.columns=[{header:i18n("Distributor"),dataIndex:'distributor_id',xtype:'templatecolumn',tpl:'{distributor_name}',flex:1,editor:{xtype:'DistributorComboBox',allowBlank:true}},{header:i18n("Order Number"),dataIndex:'orderNumber',flex:1,editor:{xtype:'textfield',allowBlank:true}},{header:i18n("Packaging Unit"),dataIndex:'packagingUnit',flex:1,editor:{xtype:'numberfield',allowDecimals:false,allowBlank:false,minValue:1}},{header:i18n("Price per Item"),dataIndex:'price',flex:1,renderer:function(val,p,rec){return PartKeepr.getApplication().formatCurrency(val);},editor:{xtype:'CurrencyField',allowBlank:false}},{header:i18n("Package Price"),flex:1,dataIndex:'packagePrice',renderer:function(val,p,rec){return PartKeepr.getApplication().formatCurrency(rec.get("price")*rec.get("packagingUnit"));},editor:{xtype:'CurrencyField',allowBlank:true}},{header:i18n("SKU"),dataIndex:'sku',flex:1,editor:{xtype:'textfield',allowBlank:true}}];this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.on("edit",this.onEdit,this);},onEdit:function(editor,data){var id=data.record.get("distributor_id");var rec=PartKeepr.getApplication().getDistributorStore().findRecord("id",id);if(rec){data.record.set("distributor_name",rec.get("name"));}},onAddClick:function(){this.editing.cancelEdit();var rec=new PartKeepr.PartDistributor({packagingUnit:1});this.store.insert(0,rec);this.editing.startEdit(0,0);},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.store.remove(selection);}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);}});
Ext.define('PartKeepr.PartParameterGrid',{extend:'PartKeepr.BaseGrid',alias:'widget.PartParameterGrid',border:false,initComponent:function(){this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.PartParameter',proxy:{type:'memory',reader:{type:'json'}}});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1,listeners:{scope:this,beforeedit:this.onBeforeEdit,edit:this.onAfterEdit}});this.plugins=[this.editing];this.deleteButton=Ext.create("Ext.button.Button",{text:i18n('Delete'),disabled:true,itemId:'delete',scope:this,icon:'resources/fugue-icons/icons/table--minus.png',handler:this.onDeleteClick});this.dockedItems=[{xtype:'toolbar',items:[{text:i18n('Add'),scope:this,icon:'resources/fugue-icons/icons/table--plus.png',handler:this.onAddClick},this.deleteButton]}];this.columns=[{header:i18n("Parameter"),dataIndex:'name',flex:0.2,editor:{xtype:'PartParameterComboBox',allowBlank:false,lazyRender:true,listClass:'x-combo-list-small',selectOnTab:true}},{header:i18n("Value"),flex:0.2,dataIndex:"prefixedValue",renderer:function(val,p,rec){if(!Ext.isObject(val)){return"";}
var foundRec=PartKeepr.getApplication().getUnitStore().findRecord("id",rec.get("unit_id"));if(foundRec){return val.value+" "+val.symbol+foundRec.get("symbol");}else{return val.value+" "+val.symbol;}},editor:{xtype:'SiUnitField',decimalPrecision:20}},{header:i18n("Unit"),flex:0.2,dataIndex:'unit_id',renderer:function(val,p,rec){var unitStore=PartKeepr.getApplication().getUnitStore();var foundRec=unitStore.findRecord("id",val,0,false,false,true);if(foundRec){return foundRec.get("name");}else{return"";}},editor:{xtype:'UnitComboBox',allowBlank:true}},{header:i18n("Description"),dataIndex:'description',flex:0.3,editor:{xtype:'textfield',allowBlank:true}}];this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);},onAddClick:function(){this.editing.cancelEdit();var rec=new PartKeepr.PartParameter({});this.store.insert(0,rec);this.editing.startEditByPosition({row:0,column:0});},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.store.remove(selection);}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);},onBeforeEdit:function(editor,e,o){var header=this.headerCt.getHeaderAtIndex(e.colIdx);var edit=this.editing.getEditor(editor.record,header);if(e.field=="prefixedValue"){var unit=PartKeepr.getApplication().getUnitStore().getById(e.record.get("unit_id"));if(unit){edit.field.setStore(unit.prefixes());}}},onAfterEdit:function(editor,e){var f=e.record.get("prefixedValue");e.record.set("siprefix_id",f.siprefix_id);e.record.set("value",f.value);}});
Ext.define('PartKeepr.UserPreferenceGrid',{extend:'PartKeepr.BaseGrid',columnLines:true,columns:[{header:i18n("Key"),dataIndex:'key',flex:0.3,minWidth:200,renderer:Ext.util.Format.htmlEncode},{header:i18n("Value"),dataIndex:'value',flex:0.7,minWidth:200,renderer:Ext.util.Format.htmlEncode}],userId:null,initComponent:function(){this.deleteButton=Ext.create("Ext.button.Button",{text:i18n('Delete'),disabled:true,itemId:'delete',scope:this,icon:'resources/silkicons/delete.png',handler:this.onDeleteClick});this.dockedItems=[{xtype:'toolbar',items:[this.deleteButton]}];this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.UserPreference',pageSize:-1});this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){selection.phantom=false;this.store.remove(selection);}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);},syncPreferences:function(){for(var j=0;j<this.store.removed.length;j++){var call=new PartKeepr.ServiceCall("UserPreference","destroy");call.setParameter("key",this.store.removed[j].get("key"));call.setParameter("user_id",this.store.removed[j].get("user_id"));call.doCall();}
this.store.removed=[];}});
Ext.define('PartKeepr.AttachmentGrid',{extend:'PartKeepr.BaseGrid',alias:'widget.AttachmentGrid',border:false,model:null,initComponent:function(){if(this.model===null){alert("Error: Model can't be null!");}
this.store=Ext.create("Ext.data.Store",{model:this.model,proxy:{type:'memory',reader:{type:'json'}}});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.plugins=[this.editing];this.deleteButton=Ext.create("Ext.button.Button",{text:i18n('Delete'),disabled:true,itemId:'delete',scope:this,icon:'resources/silkicons/delete.png',handler:this.onDeleteClick});this.viewButton=Ext.create("Ext.button.Button",{text:i18n("View"),handler:this.onViewClick,scope:this,icon:'resources/silkicons/zoom.png',disabled:true});this.webcamButton=Ext.create("Ext.button.Button",{text:i18n("Take image"),handler:this.onWebcamClick,scope:this,icon:'resources/fugue-icons/icons/webcam.png'});this.dockedItems=[{xtype:'toolbar',items:[{text:i18n('Add'),scope:this,icon:'resources/silkicons/attach.png',handler:this.onAddClick},this.webcamButton,this.viewButton,this.deleteButton]}];this.columns=[{dataIndex:'extension',width:30,renderer:function(val){return'<img src="resources/mimetypes/'+val+'.png"/>';}},{header:i18n("Filename"),dataIndex:'originalFilename',width:200},{header:i18n("Size"),dataIndex:'size',width:80,renderer:PartKeepr.bytesToSize},{header:i18n("Description"),dataIndex:'description',flex:0.4,editor:{xtype:'textfield',allowBlank:true}}];this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.on("itemdblclick",this.onDoubleClick,this);},onWebcamClick:function(){var wp=Ext.create("PartKeepr.WebcamPanel");wp.on("uploadComplete",this.onFileUploaded,this);var j=Ext.create("Ext.window.Window",{title:i18n("Take Webcam Photo"),items:[wp]});wp.on("uploadComplete",function(){j.close();});j.show();},onDoubleClick:function(view,record){if(record){this.viewAttachment(record);}},onAddClick:function(){var j=Ext.create("PartKeepr.FileUploadDialog");j.on("fileUploaded",this.onFileUploaded,this);j.show();},onFileUploaded:function(response){this.editing.cancelEdit();this.store.insert(this.store.getCount(),Ext.create(this.model,{id:"TMP:"+response.id,extension:response.extension,size:response.size,originalFilename:response.originalFilename}));},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.store.remove(selection);}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);this.viewButton.setDisabled(selections.length===0);},onViewClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.viewAttachment(selection);}},viewAttachment:function(record){var mySrc="file.php?type="+this.model+"&";if(record.get("id")===0){mySrc+="id=0&tmpId="+record.get("tmp_id");}else{mySrc+="id="+record.get("id");}
new Ext.Window({title:i18n("Display File"),width:640,height:600,maximizable:true,constrain:true,layout:'fit',items:[{xtype:"component",autoEl:{tag:"iframe",src:mySrc}}]}).show();}});
Ext.define('PartKeepr.PartAttachmentGrid',{extend:'PartKeepr.AttachmentGrid',alias:'widget.PartAttachmentGrid',model:"PartKeepr.PartAttachment"});
Ext.define('PartKeepr.FootprintAttachmentGrid',{extend:'PartKeepr.AttachmentGrid',alias:'widget.FootprintAttachmentGrid',model:"PartKeepr.FootprintAttachment"});
Ext.define('PartKeepr.ProjectAttachmentGrid',{extend:'PartKeepr.AttachmentGrid',alias:'widget.ProjectAttachmentGrid',model:"PartKeepr.ProjectAttachment"});
Ext.define('PartKeepr.MessageLog',{extend:'PartKeepr.BaseGrid',store:{model:"PartKeepr.Message"},columns:[{header:i18n("Message"),dataIndex:'message',flex:1},{header:i18n("Date"),dataIndex:'date',width:300},{header:i18n("Severity"),dataIndex:'severity'}],proxy:{type:'memory',reader:{type:'json',root:'items'}},sorters:[{property:'date',direction:'DESC'}]});
Ext.define('PartKeepr.AbstractStockHistoryGrid',{extend:'PartKeepr.BaseGrid',pageSize:25,defineColumns:function(){this.columns=[{header:"",xtype:'actioncolumn',dataIndex:'direction',renderer:function(val){if(val=="out")
{return'<img title="'+i18n("Parts removed")+'" src="resources/silkicons/brick_delete.png"/>';}else{return'<img title="'+i18n("Parts added")+'" src="resources/silkicons/brick_add.png"/>';}},width:20},{header:i18n("Date"),dataIndex:'dateTime',width:120},{header:i18n("User"),dataIndex:'user_id',flex:1,minWidth:80,renderer:function(val,p,rec){return rec.get("username");},editor:{xtype:'UserComboBox'}},{header:i18n("Amount"),dataIndex:'stockLevel',width:50,editor:{xtype:'numberfield',allowBlank:false}},{header:i18n("Price"),editor:{xtype:'CurrencyField',allowBlank:false},dataIndex:'price',width:60,renderer:function(val,p,rec){if(rec.get("dir")=="out"){return"-";}else{return PartKeepr.getApplication().formatCurrency(val);}}},{header:i18n("Comment"),dataIndex:'comment',renderer:Ext.util.Format.htmlEncode,width:60,editor:{xtype:'textfield',allowBlank:true}}];},model:'PartKeepr.StockEntry',initComponent:function(){this.defineColumns();var config={autoLoad:false,autoSync:true,remoteFilter:true,remoteSort:true,proxy:PartKeepr.getRESTProxy("Stock"),model:'PartKeepr.StockEntry',sorters:[{property:'dateTime',direction:'DESC'}],pageSize:this.pageSize};this.store=Ext.create('Ext.data.Store',config);this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.plugins=[this.editing];this.bottomToolbar=Ext.create("Ext.toolbar.Paging",{store:this.store,enableOverflow:true,dock:'bottom',displayInfo:false});this.dockedItems=new Array();this.dockedItems.push(this.bottomToolbar);this.editing.on("beforeedit",this.onBeforeEdit,this);this.callParent();},onBeforeEdit:function(e){var sameUser=e.record.get("username")==PartKeepr.getApplication().getUsername();switch(e.field){case"price":if(e.record.get("direction")=="out"){return false;}
if(!sameUser&&!PartKeepr.getApplication().isAdmin()){return false;}
break;case"stockLevel":if(!PartKeepr.getApplication().isAdmin()){return false;}
break;case"user":if(!PartKeepr.getApplication().isAdmin()){return false;}
break;case"comment":if(!sameUser&&!PartKeepr.getApplication().isAdmin()){return false;}
break;default:return true;}
return true;}});
Ext.define('PartKeepr.PartStockHistory',{extend:'PartKeepr.AbstractStockHistoryGrid',alias:'widget.PartStockHistory',initComponent:function(){this.callParent();this.on("activate",this.onActivate,this);},onActivate:function(){var proxy=this.store.getProxy();proxy.extraParams.part=this.part;this.store.load();}});
Ext.define('PartKeepr.StockHistoryGrid',{extend:'PartKeepr.AbstractStockHistoryGrid',alias:'widget.PartStockHistory',pageSize:25,defineColumns:function(){this.callParent();this.columns.splice(2,0,{header:i18n("Part"),renderer:Ext.util.Format.htmlEncode,dataIndex:'part_name',flex:1,minWidth:200});this.columns.splice(3,0,{header:i18n("Storage Location"),renderer:Ext.util.Format.htmlEncode,dataIndex:'storageLocation_name',flex:1,minWidth:200});},initComponent:function(){this.callParent();this.on("activate",this.onActivate,this);},onActivate:function(){this.store.load();}});
Ext.define('PartKeepr.ProjectPartGrid',{extend:'PartKeepr.BaseGrid',columns:[{header:i18n("Quantity"),dataIndex:'quantity',wdith:50,editor:{xtype:'numberfield',allowBlank:false,minValue:1}},{header:i18n("Part"),dataIndex:'part_id',flex:1,editor:{xtype:'RemotePartComboBox'},renderer:function(val,p,rec){return Ext.util.Format.htmlEncode(rec.get("part_name"));}},{header:i18n("Remarks"),dataIndex:'remarks',flex:1,editor:{xtype:'textfield',listeners:{focus:function(){console.log("TEXTFIELDFOCUS");}}}}],initComponent:function(){this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1,listeners:{beforeedit:function(editor,e,eOpts){if(e.field=="part_id"){e.value=e.record.get("part_name");var header=this.headerCt.getHeaderAtIndex(e.colIdx);var edit=this.editing.getEditor(editor.record,header);edit.field.setDisplayValue(e.record.get("part_name"));}},scope:this}});this.plugins=[this.editing];this.deleteButton=Ext.create("Ext.button.Button",{text:i18n('Delete'),disabled:true,itemId:'delete',scope:this,icon:'resources/silkicons/brick_delete.png',handler:this.onDeleteClick});this.viewButton=Ext.create("Ext.button.Button",{text:i18n('View Part'),disabled:true,itemId:'view',scope:this,icon:'resources/silkicons/brick_go.png',handler:this.onViewClick});this.dockedItems=[{xtype:'toolbar',items:[{text:i18n('Add'),scope:this,icon:'resources/silkicons/brick_add.png',handler:this.onAddClick},{text:i18n("Create new Part"),scope:this,icon:'resources/silkicons/brick_add.png',handler:this.onAddPartClick},this.deleteButton,this.viewButton]}];this.callParent();this.getSelectionModel().on('selectionchange',this.onSelectChange,this);},onAddClick:function(){this.editing.cancelEdit();var rec=new PartKeepr.ProjectPart({quantity:1});this.store.insert(this.store.count(),rec);this.editing.startEdit(rec,this.columns[0]);},onAddPartClick:function(){var win=Ext.getCmp("partkeepr-partmanager").onItemAdd();win.editor.on("editorClose",function(context){if(context.record.phantom){return;}
this.editing.cancelEdit();var rec=new PartKeepr.ProjectPart({quantity:1,part_id:context.record.get("id"),part_name:context.record.get("name")});this.store.insert(this.store.count(),rec);this.editing.startEdit(rec,this.columns[0]);},this);},onDeleteClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){this.store.remove(selection);}},onViewClick:function(){var selection=this.getView().getSelectionModel().getSelection()[0];if(selection){Ext.getCmp("partkeepr-partmanager").onEditPart(selection.get("part_id"));}},onSelectChange:function(selModel,selections){this.deleteButton.setDisabled(selections.length===0);this.viewButton.setDisabled(selections.length===0);}});
Ext.define('PartKeepr.SystemInformationGrid',{extend:'PartKeepr.BaseGrid',columns:[{header:'Name',dataIndex:'name',width:200},{header:'Value',dataIndex:'value',renderer:'htmlEncode',flex:1},{header:'Category',dataIndex:'category',hidden:true}],initComponent:function(){var groupingFeature=Ext.create('Ext.grid.feature.Grouping',{groupHeaderTpl:'{name}'});this.features=[groupingFeature];this.store=Ext.create("Ext.data.Store",{model:'PartKeepr.SystemInformationRecord',sorters:['category','name'],groupField:'category',proxy:{type:'memory'}});this.refreshButton=Ext.create("Ext.button.Button",{handler:this.requestSystemInformation,scope:this,text:i18n("Refresh")});this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:'bottom',ui:'footer',items:[this.refreshButton]});this.dockedItems=[this.bottomToolbar];this.callParent();this.requestSystemInformation();},requestSystemInformation:function(){var call=new PartKeepr.ServiceCall("System","getSystemInformation");call.setHandler(Ext.bind(this.processSystemInformationRecords,this));call.doCall();},processSystemInformationRecords:function(response){this.store.removeAll();this.view.all.clear();for(var i=0;i<response.data.length;i++){var rec=new PartKeepr.SystemInformationRecord({category:response.data[i].category,name:response.data[i].name,value:response.data[i].value});this.store.insert(0,rec);}}});
Ext.define('PartKeepr.EditorGrid',{extend:'PartKeepr.BaseGrid',alias:'widget.EditorGrid',deleteButtonText:i18n("Delete Item"),deleteButtonIcon:'resources/silkicons/delete.png',addButtonText:i18n("Add Item"),addButtonIcon:'resources/silkicons/add.png',enableTopToolbar:true,buttonTextMode:'hide',automaticPageSize:false,automaticPageSizeRowHeight:21,enableEditing:true,initComponent:function(){this.addEvents("itemSelect","itemDeselect","itemEdit","itemDelete","itemAdd");this.getSelectionModel().on("select",this._onItemSelect,this);this.getSelectionModel().on("deselect",this._onItemDeselect,this);this.on("itemclick",this._onItemEdit,this);this.deleteButton=Ext.create("Ext.button.Button",{text:(this.buttonTextMode!=="hide")?this.deleteButtonText:'',tooltip:this.deleteButtonText,icon:this.deleteButtonIcon,handler:Ext.bind(function(){this.fireEvent("itemDelete");},this),disabled:true});this.addButton=Ext.create("Ext.button.Button",{text:(this.buttonTextMode!=="hide")?this.addButtonText:'',tooltip:this.addButtonText,icon:this.addButtonIcon,handler:Ext.bind(function(){this.fireEvent("itemAdd");},this)});this.searchField=Ext.create("Ext.ux.form.SearchField",{store:this.store});var topToolbarItems=[];if(this.enableEditing){topToolbarItems.push(this.addButton);topToolbarItems.push(this.deleteButton);}
topToolbarItems.push({xtype:'tbfill'});topToolbarItems.push(this.searchField);this.topToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:'top',enableOverflow:true,items:topToolbarItems});this.bottomToolbar=Ext.create("Ext.toolbar.Paging",{store:this.store,enableOverflow:true,dock:'bottom',displayInfo:false});this.dockedItems=new Array();this.dockedItems.push(this.bottomToolbar);if(this.enableTopToolbar){this.dockedItems.push(this.topToolbar);}
if(!Ext.isArray(this.plugins)){this.plugins=[];}
this.plugins.push('gridmenu');this.callParent();if(this.automaticPageSize){this.on("resize",this.reassignPageSize,this);}},reassignPageSize:function(){if(this.store.isLoading()){return;}
if(this.getView().getHeight()===0){return;}
var numRecords=Math.floor(this.getView().getHeight()/this.automaticPageSizeRowHeight);if(numRecords<1){numRecords=1;}
var oldStartIndex=this.store.pageSize*this.store.currentPage;this.store.pageSize=numRecords;var newStartPage=Math.floor(oldStartIndex/numRecords);if(newStartPage<1){newStartPage=1;}
this.store.loadPage(newStartPage);},syncChanges:function(record){this.store.load();},_updateDeleteButton:function(selectionModel,record){if(this.getSelectionModel().getCount()==1){this.deleteButton.enable();}else{this.deleteButton.disable();}},_onItemEdit:function(view,record){this.fireEvent("itemEdit",record.get("id"));},_onItemSelect:function(selectionModel,record){this._updateDeleteButton(selectionModel,record);this.fireEvent("itemSelect",record);},_onItemDeselect:function(selectionModel,record){this._updateDeleteButton(selectionModel,record);this.fireEvent("itemDeselect",record);}});
Ext.define('PartKeepr.PartsGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.PartsGrid',buttonTextMode:'show',addButtonText:i18n("Add Part"),addButtonIcon:'resources/silkicons/brick_add.png',deleteButtonText:i18n("Delete Part"),deleteButtonIcon:'resources/silkicons/brick_delete.png',expandRowButtonIcon:'resources/icons/group-expand.png',collapseRowButtonIcon:'resources/icons/group-collapse.png',viewConfig:{plugins:{ddGroup:'CategoryTree',ptype:'gridviewdragdrop',enableDrop:false}},enableDragDrop:true,stripeRows:true,multiSelect:true,autoScroll:false,invalidateScrollerOnRefresh:true,initComponent:function(){this.groupingFeature=Ext.create('Ext.grid.feature.Grouping',{groupHeaderTpl:'{name} ({rows.length} '+i18n("Part(s)")+")"});this.defineColumns();this.features=[this.groupingFeature];this.on("itemdblclick",this.onDoubleClick,this);this.addEvents("editPart");this.on('scrollershow',function(scroller){if(scroller&&scroller.scrollEl){scroller.clearManagedListeners();scroller.mon(scroller.scrollEl,'scroll',scroller.onElScroll,scroller);}});if(this.enableEditing){this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.editing.on("edit",this.onEdit,this);this.plugins=[this.editing];}
this.callParent();this.bottomToolbar.add({xtype:'button',tooltip:i18n("Expand all Groups"),icon:this.expandRowButtonIcon,listeners:{scope:this.groupingFeature,click:this.groupingFeature.expandAll}});this.bottomToolbar.add({xtype:'button',tooltip:i18n("Collapse all Groups"),icon:this.collapseRowButtonIcon,listeners:{scope:this.groupingFeature,click:this.groupingFeature.collapseAll}});var duplicateBasicData=i18n("Duplicates the selected part with the data found in the \"basic\" tab and opens the editor. Doesn't immediately saves the duplicate, in order to allow editing.");var duplicateAllData=i18n("Duplicates the selected part with all data including attachments, distributors etc. Doesn't immediately saves the duplicate, in order to allow editing.");this.addFromTemplateButton=Ext.create("Ext.button.Split",{disabled:true,handler:Ext.bind(function(){this.fireEvent("duplicateItemWithBasicData");},this),tooltip:duplicateBasicData,text:i18n("Duplicate"),icon:'resources/silkicons/brick_link.png',menu:new Ext.menu.Menu({items:[{text:i18n("Duplicate with all data"),tooltip:duplicateAllData,handler:function(){this.fireEvent("duplicateItemWithAllData");},scope:this},{text:i18n("Duplicate basic data only"),tooltip:duplicateBasicData,handler:function(){this.fireEvent("duplicateItemWithBasicData");},scope:this}]})});if(this.enableEditing){this.topToolbar.insert(2,this.addFromTemplateButton);}
this.mapSearchHotkey();},mapSearchHotkey:function(){this.searchKey=new Ext.util.KeyMap(Ext.get(document),{key:'x',ctrl:false,alt:true,fn:function(e){var searchBox=this.searchField;if(Ext.get(document).activeElement!=searchBox){searchBox.focus('',10);}
searchBox.setValue('');},scope:this,stopEvent:true});},_updateAddTemplateButton:function(selectionModel,record){if(this.getSelectionModel().getCount()==1){this.addFromTemplateButton.enable();}else{this.addFromTemplateButton.disable();}},_onItemSelect:function(selectionModel,record){this._updateAddTemplateButton(selectionModel,record);this.callParent(arguments);},_onItemDeselect:function(selectionModel,record){this._updateAddTemplateButton(selectionModel,record);this.callParent(arguments);},onDoubleClick:function(view,record){if(record){this.fireEvent("editPart",record.get("id"));}},defineColumns:function(){this.columns=[{header:"",dataIndex:"",width:30,renderer:this.iconRenderer},{header:i18n("Name"),dataIndex:'name',flex:1,minWidth:150,renderer:Ext.util.Format.htmlEncode},{header:i18n("Description"),dataIndex:'description',flex:2,minWidth:150,renderer:Ext.util.Format.htmlEncode},{header:i18n("Storage Location"),dataIndex:'storageLocationName',renderer:Ext.util.Format.htmlEncode},{header:i18n("Status"),dataIndex:"status",renderer:Ext.util.Format.htmlEncode},{header:i18n("Stock"),dataIndex:'stockLevel',editor:{xtype:'numberfield',allowBlank:false},renderer:this.stockLevelRenderer},{header:i18n("Min. Stock"),dataIndex:'minStockLevel',renderer:this.stockLevelRenderer},{header:i18n("Avg. Price"),dataIndex:'averagePrice',align:'right',renderer:this.averagePriceRenderer},{header:i18n("Footprint"),dataIndex:'footprintName',renderer:Ext.util.Format.htmlEncode},{header:i18n("Category"),dataIndex:'categoryPath',renderer:Ext.util.Format.htmlEncode,hidden:true},{header:i18n("Create Date"),dataIndex:'createDate',hidden:true}];},stockLevelRenderer:function(val,q,rec)
{if(rec.get("partUnitDefault")!==true){return val+" "+rec.get("partUnitName");}else{return val;}},iconRenderer:function(val,q,rec)
{var ret="";if(rec.get("attachmentCount")>0){ret+='<img src="resources/diagona-icons/icons/10/190.png" style="margin-top: 2px;" alt="'+i18n("Has attachments")+'" title="'+i18n("Has attachments")+'"/>';}
return ret;},setCategory:function(category){this.currentCategory=category;var proxy=this.store.getProxy();proxy.extraParams.category=category;this.store.currentPage=1;this.store.load({start:0});},onEdit:function(editor,e){switch(e.field){case"stockLevel":this.handleStockFieldEdit(e);break;default:break;}},handleStockFieldEdit:function(e){if(PartKeepr.getApplication().getUserPreference("partkeepr.inline-stock-change.confirm")===false){this.handleStockChange(e);}else{this.confirmStockChange(e);}},confirmStockChange:function(e){var confirmText="";var headerText="";if(e.value<0){confirmText=sprintf(i18n("You wish to remove <b>%s %s</b> of the part <b>%s</b>. Is this correct?"),abs(e.value),e.record.get("partUnitName"),e.record.get("name"));e.record.set("stockLevel",(e.originalValue-abs(e.value)));headerText=i18n("Remove Part(s)");}else{confirmText=sprintf(i18n("You wish to set the stock level to <b>%s %s</b> of part <b>%s</b>. Is this correct?"),abs(e.value),e.record.get("partUnitName"),e.record.get("name"));headerText=i18n("Set Stock Level for Part(s)");}
var j=new PartKeepr.RememberChoiceMessageBox({escButtonAction:"cancel",dontAskAgainProperty:"partkeepr.inlinestockremoval.ask",dontAskAgainValue:false});j.show({title:headerText,msg:confirmText,buttons:Ext.Msg.OKCANCEL,fn:this.afterConfirmStockChange,scope:this,originalOnEdit:e,dialog:j});},afterConfirmStockChange:function(buttonId,text,opts){if(buttonId=="cancel"){opts.originalOnEdit.record.set("stockLevel",opts.originalOnEdit.originalValue);}
if(buttonId=="ok"){if(opts.dialog.rememberChoiceCheckbox.getValue()===true){PartKeepr.getApplication().setUserPreference("partkeepr.inline-stock-change.confirm",false);}
this.handleStockChange(opts.originalOnEdit);}},handleStockChange:function(e){var mode,quantity=0;if(e.value<0){mode="deleteStock";quantity=abs(e.value);}else{if(e.originalValue<=e.value){mode="deleteStock";quantity=e.originalValue-e.value;}else{mode="addStock";quantity=e.value-e.originalValue;}}
var call=new PartKeepr.ServiceCall("Part",mode);call.setParameter("stock",quantity);call.setParameter("part",e.record.get("id"));call.setHandler(Ext.bind(this.reloadPart,this,[e]));call.doCall();},reloadPart:function(opts){this.loadPart(opts.record.get("id"),opts);},loadPart:function(id,opts){PartKeepr.Part.load(id,{scope:this,success:this.onPartLoaded});},onPartLoaded:function(record,opts){var rec=this.store.findRecord("id",record.get("id"));if(rec){rec.set("stockLevel",record.get("stockLevel"));}}});
Ext.define('PartKeepr.UserGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.UserGrid',columns:[{header:i18n("User"),dataIndex:'username',flex:1}],addButtonText:i18n("Add User"),addButtonIcon:'resources/silkicons/user_add.png',deleteButtonText:i18n("Delete User"),deleteButtonIcon:'resources/silkicons/user_delete.png',automaticPageSize:true});
Ext.define('PartKeepr.StorageLocationGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.StorageLocationGrid',automaticPageSize:true,columns:[{header:i18n("Storage Location"),dataIndex:'name',flex:1}],addButtonText:i18n("Add Storage Location"),addButtonIcon:'resources/fugue-icons/icons/wooden-box--plus.png',deleteButtonText:i18n("Delete Storage Location"),deleteButtonIcon:'resources/fugue-icons/icons/wooden-box--minus.png',initComponent:function(){this.callParent();this.multiCreateButton=Ext.create("Ext.button.Button",{icon:'resources/icons/storagelocation_multiadd.png',tooltip:i18n("Multi-create storage locations"),handler:this.onMultiCreateClick,scope:this});this.topToolbar.insert(2,{xtype:'tbseparator'});this.topToolbar.insert(3,this.multiCreateButton);},onMultiCreateClick:function(){var j=Ext.create("PartKeepr.StorageLocationMultiCreateWindow",{listeners:{destroy:{fn:this.onMultiCreateWindowDestroy,scope:this}}});j.show();},onMultiCreateWindowDestroy:function(){this.store.load();}});
Ext.define('PartKeepr.SystemNoticeGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.SystemNoticeGrid',columns:[{header:i18n("Name"),dataIndex:'title',flex:1}],enableTopToolbar:false});
Ext.define('PartKeepr.ProjectGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.ProjectGrid',columns:[{header:i18n("Project"),dataIndex:'name',flex:1}],addButtonText:i18n("Add Project"),addButtonIcon:'resources/fugue-icons/icons/drill--plus.png',deleteButtonText:i18n("Delete Project"),deleteButtonIcon:'resources/fugue-icons/icons/drill--minus.png',automaticPageSize:true});
Ext.define('PartKeepr.DistributorGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.DistributorGrid',columns:[{header:i18n("Distributor"),dataIndex:'name',flex:1}],addButtonText:i18n("Add Distributor"),addButtonIcon:'resources/silkicons/lorry_add.png',deleteButtonText:i18n("Delete Distributor"),deleteButtonIcon:'resources/silkicons/lorry_delete.png',automaticPageSize:true});
Ext.define('PartKeepr.PartUnitGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.PartUnitGrid',columns:[{header:i18n("Part Measurement Unit"),dataIndex:'name',flex:1},{header:i18n("Default"),dataIndex:'default',width:60,renderer:function(val){if(val===true){return"✓";}else{return"";}}}],addButtonText:i18n("Add Part Measurement Unit"),addButtonIcon:"resources/fugue-icons/icons/ruler--plus.png",deleteButtonText:i18n("Delete Part Measurement Unit"),deleteButtonIcon:"resources/fugue-icons/icons/ruler--minus.png",defaultButtonIcon:"resources/fugue-icons/icons/ruler--pencil.png",automaticPageSize:true,initComponent:function(){this.callParent();this.defaultButton=Ext.create("Ext.button.Button",{icon:this.defaultButtonIcon,tooltip:i18n('Mark Part Measurement Unit as Default'),disabled:true,handler:this.onDefaultClick,scope:this});this.getSelectionModel().on("deselect",Ext.bind(function(rsm,r,i){this.defaultButton.disable();},this));this.getSelectionModel().on("select",Ext.bind(function(rsm,r,i){this.defaultButton.enable();},this));this.topToolbar.insert(2,{xtype:'tbseparator'});this.topToolbar.insert(3,this.defaultButton);},onDefaultClick:function(){var r=this.getSelectionModel().getLastSelected();var call=new PartKeepr.ServiceCall("PartUnit","setDefault");call.setParameter("id",r.get("id"));call.setHandler(Ext.bind(this.onDefaultHandler,this));call.doCall();},onDefaultHandler:function(){this.store.load();}});
Ext.define('PartKeepr.UnitGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.UnitGrid',columns:[{header:i18n("Unit"),dataIndex:'name',flex:1},{header:i18n("Symbol"),dataIndex:'symbol',width:60}],addButtonText:i18n("Add Unit"),addButtonIcon:'resources/icons/unit_add.png',deleteButtonText:i18n("Delete Unit"),deleteButtonIcon:'resources/icons/unit_delete.png',automaticPageSize:true,initComponent:function(){this.callParent();}});
Ext.define('PartKeepr.ManufacturerGrid',{extend:'PartKeepr.EditorGrid',alias:'widget.ManufacturerGrid',columns:[{header:i18n("Manufacturer"),dataIndex:'name',flex:1}],addButtonText:i18n("Add Manufacturer"),addButtonIcon:'resources/silkicons/building_add.png',deleteButtonText:i18n("Delete Manufacturer"),deleteButtonIcon:'resources/silkicons/building_delete.png',automaticPageSize:true});
Ext.define('PartKeepr.EditorComponent',{extend:'Ext.panel.Panel',alias:'widget.EditorComponent',layout:'border',padding:5,border:false,navigationClass:null,editorClass:null,store:null,model:null,deleteMessage:i18n("Do you really wish to delete the item %s?"),deleteTitle:i18n("Delete Item"),newItemText:i18n("New Item"),initComponent:function(){this.navigation=Ext.create(this.navigationClass,{region:'west',width:265,split:true,store:this.store});this.navigation.on("itemAdd",this.newRecord,this);this.navigation.on("itemDelete",this.confirmDelete,this);this.navigation.on("itemEdit",this.startEdit,this);this.editorTabPanel=Ext.create("Ext.tab.Panel",{region:"center",layout:'fit',plugins:Ext.create('Ext.ux.TabCloseMenu')});this.items=[this.navigation,this.editorTabPanel];this.callParent();},newRecord:function(defaults){Ext.apply(defaults,{});var editor=this.createEditor(this.newItemText);editor.newItem(defaults);this.editorTabPanel.add(editor).show();},startEdit:function(id){var editor=this.findEditor(id);if(editor!==null){editor.show();return;}
var model=Ext.ModelManager.getModel(this.model);model.load(id,{scope:this,success:function(record,operation){editor=this.createEditor(record.getRecordName());editor.editItem(record);this.editorTabPanel.add(editor).show();}});},findEditor:function(id){for(var i=0;i<this.editorTabPanel.items.getCount();i++){if(this.editorTabPanel.items.getAt(i).getRecordId()==id){return this.editorTabPanel.items.getAt(i);}}
return null;},createEditor:function(title){var editor=Ext.create(this.editorClass,{store:this.store,title:title,model:this.model,closable:true,listeners:{editorClose:Ext.bind(function(m){this.editorTabPanel.remove(m);},this)}});editor.on("itemSaved",this.onItemSaved,this);return editor;},confirmDelete:function(){var r=this.navigation.getSelectionModel().getLastSelected();var recordName;if(r.getRecordName){recordName=r.getRecordName();}else{recordName=r.get("name");}
Ext.Msg.confirm(this.deleteTitle,sprintf(this.deleteMessage,recordName),function(but){if(but=="yes"){this.deleteRecord(r);}},this);},deleteRecord:function(r){var editor=this.findEditor(r.get("id"));if(editor!==null){this.editorTabPanel.remove(editor);}
r.destroy();this.store.load();},createStore:function(config){Ext.Object.merge(config,{autoLoad:true,model:this.model,autoSync:false,remoteFilter:true,remoteSort:true,pageSize:15});this.store=Ext.create('Ext.data.Store',config);this.store.on('write',function(store,operation){var success=operation.wasSuccessful();if(success){Ext.each(operation.records,function(record){if(record.dirty){record.commit();}});}});},getStore:function(){return this.store;},onItemSaved:function(record){this.navigation.syncChanges(record);}});
Ext.define('PartKeepr.UserEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.UserEditorComponent',navigationClass:'PartKeepr.UserGrid',editorClass:'PartKeepr.UserEditor',newItemText:i18n("New User"),deleteMessage:i18n("Do you really wish to delete the user '%s'?"),deleteTitle:i18n("Delete User"),model:'PartKeepr.User',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("User"),property:'username',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.StorageLocationEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.StorageLocationEditorComponent',navigationClass:'PartKeepr.StorageLocationGrid',editorClass:'PartKeepr.StorageLocationEditor',newItemText:i18n("New Storage Location"),model:'PartKeepr.StorageLocation',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("StorageLocation"),property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.SystemNoticeEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.SystemNoticeEditorComponent',navigationClass:'PartKeepr.SystemNoticeGrid',editorClass:'PartKeepr.SystemNoticeEditor',newItemText:i18n("New System Notice"),model:'PartKeepr.SystemNotice',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("SystemNotice"),property:'date',direction:'DESC'}]});this.callParent();}});
Ext.define('PartKeepr.ProjectEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.ProjectEditorComponent',navigationClass:'PartKeepr.ProjectGrid',editorClass:'PartKeepr.ProjectEditor',newItemText:i18n("New Project"),model:'PartKeepr.Project',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("Project"),property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.DistributorEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.DistributorEditorComponent',navigationClass:'PartKeepr.DistributorGrid',editorClass:'PartKeepr.DistributorEditor',newItemText:i18n("New Distributor"),model:'PartKeepr.Distributor',initComponent:function(){this.createStore({proxy:PartKeepr.getRESTProxy("Distributor"),sorters:[{property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.PartUnitEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.PartUnitEditorComponent',navigationClass:'PartKeepr.PartUnitGrid',editorClass:'PartKeepr.PartUnitEditor',newItemText:i18n("New Part Measurement Unit"),deleteMessage:i18n("Do you really wish to delete the part measurement unit'%s'?"),deleteTitle:i18n("Delete Part Measurement Unit"),model:'PartKeepr.PartUnit',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("PartUnit"),property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.UnitEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.UnitEditorComponent',navigationClass:'PartKeepr.UnitGrid',editorClass:'PartKeepr.UnitEditor',newItemText:i18n("New Unit"),deleteMessage:i18n("Do you really wish to delete the unit'%s'?"),deleteTitle:i18n("Delete Unit"),model:'PartKeepr.Unit',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("Unit"),property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.FootprintEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.FootprintEditorComponent',navigationClass:'PartKeepr.FootprintTree',editorClass:'PartKeepr.FootprintEditor',newItemText:i18n("New Footprint"),model:'PartKeepr.Footprint',initComponent:function(){this.createStore({proxy:PartKeepr.getRESTProxy("Footprint"),sorters:[{property:'name',direction:'ASC'}]});this.callParent();},deleteRecord:function(r){var editor=this.findEditor(r.get("footprintId"));if(editor!==null){this.editorTabPanel.remove(editor);}
var call=new PartKeepr.ServiceCall("Footprint","destroy");call.setParameter("id",r.get("footprintId"));call.setHandler(Ext.bind(function(){var oldRecordIndex=PartKeepr.getApplication().getFootprintStore().find("id",r.get("footprintId"));PartKeepr.getApplication().getFootprintStore().removeAt(oldRecordIndex);this.navigation.loadCategories();},this));call.doCall();}});
Ext.define('PartKeepr.ManufacturerEditorComponent',{extend:'PartKeepr.EditorComponent',alias:'widget.ManufacturerEditorComponent',navigationClass:'PartKeepr.ManufacturerGrid',editorClass:'PartKeepr.ManufacturerEditor',newItemText:i18n("New Manufacturer"),model:'PartKeepr.Manufacturer',initComponent:function(){this.createStore({sorters:[{proxy:PartKeepr.getRESTProxy("Manufacurer"),property:'name',direction:'ASC'}]});this.callParent();}});
Ext.define('PartKeepr.Editor',{extend:'Ext.form.Panel',alias:'widget.Editor',trackResetOnLoad:true,bodyStyle:'background:#DBDBDB;padding: 10px;',record:null,saveText:i18n("Save"),cancelText:i18n("Cancel"),model:null,layout:'anchor',change:false,autoScroll:true,defaults:{anchor:'100%',labelWidth:150},enableButtons:true,syncDirect:false,onFieldChange:function(){return;},initComponent:function(){if(this.enableButtons){this.saveButton=Ext.create("Ext.button.Button",{text:this.saveText,icon:'resources/fugue-icons/icons/disk.png',handler:Ext.bind(this._onItemSave,this)});this.cancelButton=Ext.create("Ext.button.Button",{text:this.cancelText,icon:'resources/silkicons/cancel.png',handler:Ext.bind(this.onCancelEdit,this)});this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,margin:'10px',defaults:{minWidth:100},dock:'bottom',ui:'footer',items:[this.saveButton,this.cancelButton]});Ext.apply(this,{dockedItems:[this.bottomToolbar]});}
this.on("dirtychange",function(form,dirty){});this.addEvents("editorClose","startEdit","itemSaved","itemSave");this.defaults.listeners={"change":Ext.bind(this.onFieldChange,this)};this.callParent();},onCancelEdit:function(){this.fireEvent("editorClose",this);},newItem:function(defaults){Ext.apply(defaults,{});var j=Ext.create(this.model,defaults);this.editItem(j);},editItem:function(record){this.record=record;this.getForm().loadRecord(this.record);this.show();if(this.record.getRecordName()!==""){this._setTitle(this.record.getRecordName());}
this.change=false;this.fireEvent("startEdit",this);},getRecordId:function(){if(this.record){return this.record.get("id");}else{return null;}},_onItemSave:function(){if(this.enableButtons){this.saveButton.disable();Ext.defer(function(){this.saveButton.enable();},30000,this);}
this.getForm().updateRecord(this.record);this.fireEvent("itemSave",this.record);this.record.save({callback:this._onSave,scope:this});},_onSave:function(record,response){if(this.enableButtons){this.saveButton.enable();}
if(response.success===true){this.record=record;this.fireEvent("itemSaved",this.record);}},_setTitle:function(title){}});
Ext.define('PartKeepr.PartEditor',{extend:'PartKeepr.Editor',model:'PartKeepr.Part',border:false,layout:'fit',bodyStyle:'background:#DBDBDB;',initComponent:function(){var overallHeight=(this.partMode=="create")?'-280':'-215';this.nameField=Ext.create("Ext.form.field.Text",{name:'name',fieldLabel:i18n("Name"),allowBlank:false,labelWidth:150});this.storageLocationComboBox=Ext.create("PartKeepr.StorageLocationComboBox",{fieldLabel:i18n("Storage Location"),name:'storageLocation',allowBlank:false,labelWidth:150});this.storageLocationComboBox.store.on("load",function(){this.getForm().isValid();},this);this.footprintNone=Ext.create("Ext.form.field.Radio",{boxLabel:i18n("None"),name:'footprint_mode',margin:{right:5},value:"unset",listeners:{scope:this,change:function(field,newValue){if(newValue===true){this.footprintComboBox.clearValue();}}}});this.footprintSet=Ext.create("Ext.form.field.Radio",{name:'footprint_mode',margin:{right:5},value:"set"});this.footprintComboBox=Ext.create("PartKeepr.FootprintComboBox",{name:'footprint',flex:1,listeners:{scope:this,change:function(field,newValue){if(newValue!==0){this.footprintSet.setValue(true);}}}});var basicEditorFields=[this.nameField,{xtype:'textfield',fieldLabel:i18n("Description"),name:'description'},{layout:'column',bodyStyle:'background:#DBDBDB',border:false,items:[{xtype:'numberfield',fieldLabel:i18n('Minimum Stock'),allowDecimals:false,allowBlank:false,labelWidth:150,name:'minStockLevel',value:0,columnWidth:0.5,minValue:0},{xtype:'PartUnitComboBox',fieldLabel:i18n("Part Unit"),columnWidth:0.5,margin:"0 0 0 5",name:'partUnit',value:PartKeepr.getApplication().getDefaultPartUnit().get("id")}]},{xtype:'CategoryComboBox',fieldLabel:i18n("Category"),name:'category'},this.storageLocationComboBox,{xtype:'fieldcontainer',layout:'hbox',fieldLabel:i18n("Footprint"),defaults:{hideLabel:true},items:[this.footprintNone,this.footprintSet,this.footprintComboBox]},{xtype:'textarea',fieldLabel:i18n("Comment"),name:'comment',anchor:'100% '+overallHeight},{xtype:'fieldcontainer',layout:'hbox',fieldLabel:i18n("Status"),defaults:{hideLabel:true},items:[{xtype:'textfield',fieldLabel:i18n("Status"),flex:1,name:'status'},{xtype:'checkbox',hideEmptyLabel:false,fieldLabel:'',margins:{left:5},boxLabel:i18n("Needs Review"),name:'needsReview'}]},{xtype:'textfield',fieldLabel:i18n("Internal Part Number"),name:'internalPartNumber'}];this.partDistributorGrid=Ext.create("PartKeepr.PartDistributorGrid",{title:i18n("Distributors"),iconCls:'icon-lorry',layout:'fit'});this.partManufacturerGrid=Ext.create("PartKeepr.PartManufacturerGrid",{title:i18n("Manufacturers"),iconCls:'icon-building',layout:'fit'});this.partParameterGrid=Ext.create("PartKeepr.PartParameterGrid",{title:i18n("Parameters"),iconCls:'icon-table',layout:'fit'});this.partAttachmentGrid=Ext.create("PartKeepr.PartAttachmentGrid",{title:i18n("Attachments"),iconCls:'icon-attach',layout:'fit'});if(this.partMode&&this.partMode=="create"){this.initialStockLevel=Ext.create("Ext.form.field.Number",{fieldLabel:i18n("Initial Stock Level"),name:"initialStockLevel",labelWidth:150,columnWidth:0.5});this.initialStockLevelUser=Ext.create("PartKeepr.UserComboBox",{fieldLabel:i18n("Stock User"),name:'initialStockLevelUser',columnWidth:0.5,margin:"0 0 0 5"});basicEditorFields.push({layout:'column',bodyStyle:'background:#DBDBDB',border:false,items:[this.initialStockLevel,this.initialStockLevelUser]});this.initialStockLevelPrice=Ext.create("PartKeepr.CurrencyField",{fieldLabel:i18n('Price'),labelWidth:150,columnWidth:0.5,name:'initialStockLevelPrice'});this.initialStockLevelPricePerItem=Ext.create("Ext.form.field.Checkbox",{boxLabel:i18n("Per Item"),columnWidth:0.5,margin:"0 0 0 5",name:'initialStockLevelPricePerItem'});basicEditorFields.push({layout:'column',bodyStyle:'background:#DBDBDB',border:false,items:[this.initialStockLevelPrice,this.initialStockLevelPricePerItem]});}
this.items={xtype:'tabpanel',border:false,plain:true,items:[{iconCls:'icon-brick',xtype:'panel',border:false,autoScroll:false,layout:'anchor',defaults:{anchor:'100%',labelWidth:150},bodyStyle:'background:#DBDBDB;padding: 10px;',title:i18n("Basic Data"),items:basicEditorFields},this.partDistributorGrid,this.partManufacturerGrid,this.partParameterGrid,this.partAttachmentGrid]};this.on("startEdit",this.onEditStart,this,{delay:200});this.on("itemSaved",this._onItemSaved,this);this.addEvents("partSaved","titleChange");this.callParent();this.on("itemSave",this.onItemSave,this);},onItemSave:function(){var removeRecords=[],j;for(j=0;j<this.record.distributors().getCount();j++){if(this.record.distributors().getAt(j).get("distributor_id")===0){removeRecords.push(this.record.distributors().getAt(j));}}
if(removeRecords.length>0){this.record.distributors().remove(removeRecords);}
removeRecords=[];for(j=0;j<this.record.parameters().getCount();j++){if(this.record.parameters().getAt(j).get("unit_id")===0){removeRecords.push(this.record.parameters().getAt(j));}}
if(removeRecords.length>0){this.record.parameters().remove(removeRecords);}
removeRecords=[];for(j=0;j<this.record.manufacturers().getCount();j++){if(this.record.manufacturers().getAt(j).get("manufacturer_id")===0){removeRecords.push(this.record.manufacturers().getAt(j));}}
if(removeRecords.length>0){this.record.manufacturers().remove(removeRecords);}
if(isNaN(this.record.get("storageLocation"))){var storageLocationRecord=this.storageLocationComboBox.getStore().findRecord("name",this.storageLocationComboBox.getValue(),0,false,false,true);this.record.set("storageLocation",storageLocationRecord.get("id"));}
if(this.footprintNone.getValue()===true){this.record.set("footprint",0);}},onEditStart:function(){this.bindChildStores();this.nameField.focus();this.getForm().isValid();if(this.record.get("footprint")===0){this.footprintNone.setValue(true);}else{this.footprintSet.setValue(true);}},_onItemSaved:function(){this.fireEvent("partSaved",this.record);if(this.keepOpenCheckbox.getValue()!==true&&this.createCopyCheckbox.getValue()!==true){this.fireEvent("editorClose",this);}else{var newItem;if(this.partMode=="create"){if(this.copyPartDataCheckbox.getValue()===true){data=this.record.getData(true);data.id=null;newItem=Ext.create("PartKeepr.Part");newItem.setDataWithAssociations(data);this.editItem(newItem);}else{newItem=Ext.create("PartKeepr.Part",this.partDefaults);this.editItem(newItem);}}else{var data=this.record.getData(true);data.id=null;newItem=Ext.create("PartKeepr.Part");newItem.setDataWithAssociations(data);this.editItem(newItem);}}},bindChildStores:function(){this.partDistributorGrid.bindStore(this.record.distributors());this.partManufacturerGrid.bindStore(this.record.manufacturers());this.partParameterGrid.bindStore(this.record.parameters());this.partAttachmentGrid.bindStore(this.record.attachments());},_setTitle:function(title){var tmpTitle;if(this.record.phantom){tmpTitle=i18n("Add Part");}else{tmpTitle=i18n("Edit Part");}
if(title!==""){tmpTitle=tmpTitle+": "+title;}
this.fireEvent("titleChange",tmpTitle);}});
Ext.define('PartKeepr.UserEditor',{extend:'PartKeepr.Editor',alias:'widget.UserEditor',saveText:i18n("Save User"),model:'PartKeepr.User',initComponent:function(){this.gridPanel=Ext.create("PartKeepr.UserPreferenceGrid");var container=Ext.create("Ext.form.FieldContainer",{fieldLabel:i18n("User Preferences"),labelWidth:150,layout:'fit',height:200,items:this.gridPanel});this.items=[{xtype:'textfield',name:'username',fieldLabel:i18n("User")},{xtype:'textfield',inputType:"password",name:'password',fieldLabel:i18n("Password")},container];this.on("startEdit",this.onStartEdit,this);this.callParent();},onStartEdit:function(){this.gridPanel.store.getProxy().extraParams.user_id=this.record.get("id");this.gridPanel.store.load();},onItemSave:function(){this.gridPanel.syncPreferences();this.callParent();}});
Ext.define('PartKeepr.StorageLocationEditor',{extend:'PartKeepr.Editor',alias:'widget.StorageLocationEditor',saveText:i18n("Save Storage Location"),layout:'column',initComponent:function(){var config={};Ext.Object.merge(config,{autoLoad:false,model:"PartKeepr.Part",autoSync:false,remoteFilter:true,remoteSort:true,proxy:PartKeepr.getRESTProxy("Part"),pageSize:15});this.store=Ext.create('Ext.data.Store',config);this.gridPanel=Ext.create("PartKeepr.BaseGrid",{store:this.store,columnLines:true,columns:[{header:i18n("Name"),dataIndex:'name',flex:1,minWidth:200,renderer:Ext.util.Format.htmlEncode},{header:i18n("Qty"),width:50,dataIndex:'stockLevel'}]});var container=Ext.create("Ext.form.FieldContainer",{fieldLabel:i18n("Contained Parts"),labelWidth:110,layout:'fit',height:246,items:this.gridPanel});this.items=[{columnWidth:1,minWidth:500,layout:'anchor',xtype:'container',margin:'0 5 0 0',items:[{xtype:'textfield',name:'name',anchor:'100%',labelWidth:110,fieldLabel:i18n("Storage Location")},container]},{width:370,height:250,xtype:'remoteimagefield',name:'image_id',imageType:'storagelocation',imageWidth:256,imageHeight:256,labelWidth:110,fieldLabel:i18n("Image")}];this.on("startEdit",this.onStartEdit,this);this.callParent();},onStartEdit:function(){this.store.getProxy().extraParams.storageLocation=this.record.get("name");this.store.load();}});
Ext.define('PartKeepr.SystemNoticeEditor',{extend:'PartKeepr.Editor',alias:'widget.SystemNoticeEditor',saveText:i18n("Save System Notice"),defaults:{anchor:'100%',labelWidth:110},layout:{type:'vbox',align:'stretch',pack:'start'},enableButtons:false,initComponent:function(){this.acknowledgeButton=Ext.create("Ext.button.Button",{text:i18n("Acknowledge Notice"),icon:'resources/silkicons/accept.png'});this.acknowledgeButton.on("click",this.onAcknowledgeClick,this);this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{enableOverflow:true,margin:'10px',defaults:{minWidth:100},dock:'bottom',ui:'footer',items:[this.acknowledgeButton]});this.dockedItems=new Array(this.bottomToolbar);this.items=[{xtype:'textfield',readOnly:true,name:'title',fieldLabel:i18n("Title")},{xtype:'textarea',readOnly:true,flex:1,name:'description',fieldLabel:i18n("Description")},{xtype:'datefield',readOnly:true,hideTrigger:true,name:'date',fieldLabel:i18n("Date")}];this.callParent();},onAcknowledgeClick:function(){var call=new PartKeepr.ServiceCall("SystemNotice","acknowledge");call.setParameter("id",this.record.get("id"));call.setHandler(Ext.bind(this.onAcknowledged,this));call.doCall();},onAcknowledged:function(){this.fireEvent("editorClose",this);this.store.load();}});
Ext.define('PartKeepr.ProjectEditor',{extend:'PartKeepr.Editor',alias:'widget.ProjectEditor',saveText:i18n("Save Project"),defaults:{anchor:'100%',labelWidth:110},layout:{type:'vbox',align:'stretch',pack:'start'},initComponent:function(){this.on("startEdit",this.onEditStart,this,{delay:200});this.on("itemSaved",this._onItemSaved,this);var config={};Ext.Object.merge(config,{autoLoad:false,model:"PartKeepr.ProjectPart",autoSync:false,remoteFilter:false,remoteSort:false});this.store=Ext.create('Ext.data.Store',config);this.partGrid=Ext.create("PartKeepr.ProjectPartGrid",{store:this.store,listeners:{edit:this.onProjectGridEdit}});var container=Ext.create("Ext.form.FieldContainer",{fieldLabel:i18n("Project Parts"),labelWidth:110,layout:'fit',flex:1,items:this.partGrid});this.attachmentGrid=Ext.create("PartKeepr.ProjectAttachmentGrid",{border:true});var container2=Ext.create("Ext.form.FieldContainer",{fieldLabel:i18n("Attachments"),labelWidth:110,layout:'fit',flex:1,items:this.attachmentGrid});this.items=[{xtype:'textfield',name:'name',height:20,fieldLabel:i18n("Project Name")},{xtype:'textarea',name:'description',fieldLabel:i18n("Project Description"),height:70},container,container2];this.callParent();},onProjectGridEdit:function(editor,e){if(e.field=="part_id"){if(e.value===null){e.record.set("part_id",e.originalValue);}
var rec=e.column.getEditor().store.getById(e.value);if(rec){e.record.set("part_name",rec.get("name"));}}},_onItemSaved:function(record){this.partGrid.bindStore(record.parts());this.attachmentGrid.bindStore(record.attachments());},onEditStart:function(){var store=this.record.parts();this.partGrid.bindStore(store);var store2=this.record.attachments();this.attachmentGrid.bindStore(store2);}});
Ext.define('PartKeepr.DistributorEditor',{extend:'PartKeepr.Editor',alias:'widget.DistributorEditor',items:[{xtype:'textfield',name:'name',fieldLabel:i18n("Distributor")},{xtype:'textarea',name:'address',fieldLabel:i18n("Address")},{xtype:'textfield',name:'url',fieldLabel:i18n("Website")},{xtype:'textfield',name:'email',fieldLabel:i18n("Email")},{xtype:'textfield',name:'phone',fieldLabel:i18n("Phone")},{xtype:'textfield',name:'fax',fieldLabel:i18n("Fax")},{xtype:'textarea',name:'comment',fieldLabel:i18n("Comment")}],saveText:i18n("Save Distributor")});
Ext.define('PartKeepr.PartUnitEditor',{extend:'PartKeepr.Editor',alias:'widget.PartUnitEditor',items:[{xtype:'textfield',name:'name',fieldLabel:i18n("Measurement Unit Name")},{xtype:'textfield',name:'shortName',fieldLabel:i18n("Short Name")}],saveText:i18n("Save Part Measurement Unit")});
Ext.define('PartKeepr.UnitEditor',{extend:'PartKeepr.Editor',alias:'widget.UnitEditor',saveText:i18n("Save Unit"),initComponent:function(){var sm=Ext.create('Ext.selection.CheckboxModel',{checkOnly:true});this.gridPanel=Ext.create("PartKeepr.BaseGrid",{store:PartKeepr.getApplication().getSiPrefixStore(),selModel:sm,columnLines:true,columns:[{text:i18n("Prefix"),dataIndex:"prefix",width:60},{text:i18n("Symbol"),dataIndex:"symbol",width:60},{text:i18n("Power"),dataIndex:"power",flex:1,renderer:function(val){return"10<sup>"+val+"</sup>";}}]});var container=Ext.create("Ext.form.FieldContainer",{fieldLabel:i18n("Allowed SI-Prefixes"),labelWidth:150,items:this.gridPanel});this.items=[{xtype:'textfield',name:'name',fieldLabel:i18n("Unit Name")},{xtype:'textfield',name:'symbol',fieldLabel:i18n("Symbol")},container];this.callParent();this.on("startEdit",this.onStartEdit,this);},onStartEdit:function(){var records=this.record.prefixes().getRange();var toSelect=[];var pfxStore=PartKeepr.getApplication().getSiPrefixStore();for(var i=0;i<records.length;i++){toSelect.push(pfxStore.getAt(pfxStore.find("id",records[i].get("id"))));}
Ext.defer(function(){this.gridPanel.getSelectionModel().select(toSelect);},100,this);},onItemSave:function(){var selection=this.gridPanel.getSelectionModel().getSelection();this.record.prefixes().removeAll(true);for(var i=0;i<selection.length;i++){this.record.prefixes().add({id:selection[i].get("id")});}
this.callParent();}});
Ext.define('PartKeepr.FootprintEditor',{extend:'PartKeepr.Editor',alias:'widget.FootprintEditor',saveText:i18n("Save Footprint"),layout:'column',syncDirect:true,labelWidth:75,initComponent:function(){this.on("startEdit",this.onEditStart,this,{delay:50});this.attachmentGrid=Ext.create("PartKeepr.FootprintAttachmentGrid",{height:200,width:'100%',border:true});this.items=[{columnWidth:1,minWidth:500,layout:'anchor',xtype:'container',margin:'0 5 0 0',items:[{xtype:'textfield',name:'name',labelWidth:75,anchor:'100%',fieldLabel:i18n("Name")},{labelWidth:75,xtype:'textarea',name:'description',anchor:'100%',fieldLabel:i18n("Description")},{labelWidth:75,xtype:'fieldcontainer',anchor:'100%',fieldLabel:i18n("Attachments"),items:this.attachmentGrid}]},{width:370,height:250,xtype:'remoteimagefield',name:'image_id',imageType:'footprint',imageWidth:256,imageHeight:256,labelWidth:75,fieldLabel:i18n("Image")}];this.on("itemSaved",this._onItemSaved,this);this.callParent();},_onItemSaved:function(record){this.attachmentGrid.bindStore(record.attachments());},onEditStart:function(){var store=this.record.attachments();this.attachmentGrid.bindStore(store);}});
Ext.define('PartKeepr.ManufacturerEditor',{extend:'PartKeepr.Editor',alias:'widget.ManufacturerEditor',saveText:i18n("Save Manufacturer"),labelWidth:150,initComponent:function(){this.on("startEdit",Ext.bind(this.onEditStart,this));this.tpl=['<tpl for=".">','<div class="thumb-wrap" id="{id}">','<div class="thumb"><img src="image.php?type=iclogo&id={id}&w=64&h=64&tmpId={tmp_id}"></div>','</div>','</tpl>','</tpl>','<div class="x-clear"></div>'];this.addLogoButton=Ext.create("Ext.button.Button",{icon:"resources/silkicons/add.png",text:i18n("Add Logo"),handler:Ext.bind(this.uploadImage,this)});this.deleteLogoButton=Ext.create("Ext.button.Button",{icon:"resources/silkicons/delete.png",text:i18n("Delete Logo"),disabled:true,handler:Ext.bind(this.deleteImage,this)});this.iclogoGrid=Ext.create("Ext.view.View",{store:null,border:true,frame:true,style:'background-color: white',emptyText:'No images to display',height:200,fieldLabel:i18n("Logos"),overItemCls:'x-view-over',componentCls:'manufacturer-ic-logos',itemSelector:'div.thumb-wrap',singleSelect:true,anchor:'100%',tpl:this.tpl,listeners:{selectionchange:Ext.bind(function(view,selections){if(selections.length>0){this.deleteLogoButton.enable();}else{this.deleteLogoButton.disable();}},this)}});this.items=[{xtype:'textfield',name:'name',fieldLabel:i18n("Manufacturer Name")},{xtype:'textarea',name:'address',fieldLabel:i18n("Address")},{xtype:'textfield',name:'url',fieldLabel:i18n("Website")},{xtype:'textfield',name:'email',fieldLabel:i18n("Email")},{xtype:'textfield',name:'phone',fieldLabel:i18n("Phone")},{xtype:'textfield',name:'fax',fieldLabel:i18n("Fax")},{xtype:'textarea',name:'comment',fieldLabel:i18n("Comment")},{xtype:'fieldcontainer',fieldLabel:i18n("Manufacturer Logos"),items:[{xtype:'panel',dockedItems:[{xtype:'toolbar',dock:'bottom',items:[this.addLogoButton,this.deleteLogoButton]}],items:this.iclogoGrid}]}];this.on("itemSaved",this._onItemSaved,this);this.callParent();},_onItemSaved:function(record){this.iclogoGrid.bindStore(record.iclogos());},onFileUploaded:function(response){this.iclogoGrid.getStore().add({id:"TMP:"+response.id,manufacturer_id:this.record.get("id")});},uploadImage:function(){var j=Ext.create("PartKeepr.FileUploadDialog",{imageUpload:true});j.on("fileUploaded",Ext.bind(this.onFileUploaded,this));j.show();},deleteImage:function(){this.iclogoGrid.store.remove(this.iclogoGrid.getSelectionModel().getLastSelected());},onEditStart:function(){var store=this.record.iclogos();this.iclogoGrid.bindStore(store);}});
Ext.define('PartKeepr.ServiceCall',{extend:'Ext.util.Observable',service:null,call:null,sHandler:null,parameters:{},loadMessage:null,anonymous:false,constructor:function(service,call){this.setService(service);this.setCall(call);this.parameters={};},enableAnonymous:function(){this.anonymous=true;},disableAnonymous:function(){this.anonymous=false;},setService:function(service){this.service=service;},setCall:function(call){this.call=call;},setParameter:function(parameter,value){this.parameters[parameter]=value;},setParameters:function(obj){Ext.apply(this.parameters,obj);},setLoadMessage:function(message){this.loadMessage=message;},setHandler:function(handler){this.sHandler=handler;},doCall:function(){PartKeepr.getApplication().getStatusbar().startLoad(this.loadMessage);var callDefinition=Ext.encode(this.parameters);var headers={"call":this.call,"lang":Ext.getLocale()};if(!this.anonymous){headers.session=PartKeepr.getApplication().getSessionManager().getSession();}
Ext.Ajax.request({url:PartKeepr.getBasePath()+'/'+this.service+"/"+this.call,success:Ext.bind(this.onSuccess,this),failure:Ext.bind(this.onError,this),method:"POST",params:callDefinition,headers:headers});},onSuccess:function(responseObj,options){PartKeepr.getApplication().getStatusbar().endLoad();try{var response=Ext.decode(responseObj.responseText);}catch(ex){var exception={message:i18n("Critical Error"),detail:i18n("The server returned a response which we were not able to interpret.")};var request={response:responseObj.responseText,request:Ext.encode(options)};PartKeepr.ExceptionWindow.showException(exception,request);return;}
if(response.status=="error"){this.displayError(response.exception);PartKeepr.getApplication().getStatusbar().setStatus({text:this.getErrorMessage(response.exception),iconCls:'x-status-error',clear:{useDefaults:true,anim:false}});return;}
if(response.status=="systemerror"){this.displaySystemError(response);PartKeepr.getApplication().getStatusbar().setStatus({text:this.getErrorMessage(response),iconCls:'x-status-error',clear:{useDefaults:true,anim:false}});return;}
if(this.sHandler){this.sHandler(response.response);}},onError:function(response,options){var request;try{var data=Ext.decode(response.responseText);request={response:response.responseText,request:Ext.encode(options)};PartKeepr.ExceptionWindow.showException(data.exception,request);}catch(ex){var exception={message:i18n("Critical Error"),detail:i18n("The server returned a response which we were not able to interpret."),backtrace:response.responseText};request={response:response.responseText,request:Ext.encode(options)};PartKeepr.ExceptionWindow.showException(exception,request);}
PartKeepr.getApplication().getStatusbar().endLoad();},displayError:function(obj){Ext.Msg.show({title:i18n("Error"),msg:this.getErrorMessage(obj),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});},getErrorMessage:function(obj){var errorMsg;if(obj.message===""){errorMsg=obj.exception;}else{errorMsg=obj.message;}
return errorMsg;},displaySystemError:function(obj){var errorMsg;errorMsg="Error Message: "+obj.message+"<br>";errorMsg+="Exception:"+obj.exception+"<br>";errorMsg+="Backtrace:<br>"+str_replace("\n","<br>",obj.backtrace);Ext.Msg.maxWidth=800;Ext.Msg.show({title:i18n("System Error"),msg:errorMsg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}});
window.webcam={version:'1.0.9',ie:!!navigator.userAgent.match(/MSIE/),protocol:location.protocol.match(/https/i)?'https':'http',callback:null,swf_url:'webcam.swf',shutter_url:'shutter.mp3',api_url:'',loaded:false,quality:90,shutter_sound:true,stealth:false,hooks:{onLoad:null,onComplete:null,onError:null},set_hook:function(name,callback){if(typeof(this.hooks[name])=='undefined'){alert("Hook type not supported: "+name);}else{this.hooks[name]=callback;}},fire_hook:function(name,value){if(this.hooks[name]){if(typeof(this.hooks[name])=='function'){this.hooks[name](value);}
else if(typeof(this.hooks[name])=='array'){this.hooks[name][0][this.hooks[name][1]](value);}
else if(window[this.hooks[name]]){window[this.hooks[name]](value);}
return true;}
return false;},set_api_url:function(url){this.api_url=url;},set_swf_url:function(url){this.swf_url=url;},get_html:function(width,height,server_width,server_height){if(!server_width)server_width=width;if(!server_height)server_height=height;var html='';var flashvars='shutter_enabled='+(this.shutter_sound?1:0)+'&shutter_url='+escape(this.shutter_url)+'&width='+width+'&height='+height+'&server_width='+server_width+'&server_height='+server_height;if(this.ie){html+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+width+'" height="'+height+'" id="webcam_movie" align="middle"><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+this.swf_url+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+flashvars+'"/></object>';}
else{html+='<embed id="webcam_movie" src="'+this.swf_url+'" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+width+'" height="'+height+'" name="webcam_movie" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+flashvars+'" />';}
this.loaded=false;return html;},get_movie:function(){if(!this.loaded)return alert("ERROR: Movie is not loaded yet");var movie=document.getElementById('webcam_movie');if(!movie)alert("ERROR: Cannot locate movie 'webcam_movie' in DOM");return movie;},set_stealth:function(stealth){this.stealth=stealth;},snap:function(url,callback,stealth){if(callback)this.set_hook('onComplete',callback);if(url)this.set_api_url(url);if(typeof(stealth)!='undefined')this.set_stealth(stealth);this.get_movie()._snap(this.api_url,this.quality,this.shutter_sound?1:0,this.stealth?1:0);},freeze:function(){this.get_movie()._snap('',this.quality,this.shutter_sound?1:0,0);},upload:function(url,callback){if(callback)this.set_hook('onComplete',callback);if(url)this.set_api_url(url);this.get_movie()._upload(this.api_url);},reset:function(){this.get_movie()._reset();},configure:function(panel){if(!panel)panel="camera";this.get_movie()._configure(panel);},set_quality:function(new_quality){this.quality=new_quality;},set_shutter_sound:function(enabled,url){this.shutter_sound=enabled;this.shutter_url=url?url:'shutter.mp3';},flash_notify:function(type,msg){switch(type){case'flashLoadComplete':this.loaded=true;this.fire_hook('onLoad');break;case'error':if(!this.fire_hook('onError',msg)){alert("JPEGCam Flash Error: "+msg);}
break;case'success':this.fire_hook('onComplete',msg.toString());break;default:alert("jpegcam flash_notify: "+type+": "+msg);break;}}};
Ext.override(Ext.form.field.Text,{initComponent:function(){this.callOverridden(arguments);this.charSelector=Ext.create("PartKeepr.ContextMenu.CharPicker",{listeners:{select:function(a,chr){this.setValue(this.getValue()+chr);},scope:this}});this.menu=Ext.create('widget.menu',{items:[{text:i18n("Insert special character"),menu:this.charSelector}]});},onRender:function(){this.callOverridden(arguments);this.inputEl.on("contextmenu",this.onItemContextMenu,this);},onItemContextMenu:function(event,el){event.stopEvent();this.menu.showAt(event.getXY());}});
Ext.override(Ext.tree.View,{ensureVisible:function(record){if(!record){return;}
if(record.parentNode){record.parentNode.expand();this.ensureVisible(record.parentNode);}},scrollIntoView:function(record){var node=this.getNode(record);if(node){node.scrollIntoView(this.getEl());}}});
Ext.override(Ext.grid.feature.Grouping,{collapseAll:function(){var self=this,view=self.view;view.el.query('.x-grid-group-hd').forEach(function(group){var group_body=Ext.fly(group.nextSibling,'_grouping');self.collapse(group_body);});},expandAll:function(){var self=this,view=self.view;view.el.query('.x-grid-group-hd').forEach(function(group){var group_body=Ext.fly(group.nextSibling,'_grouping');self.expand(group_body);});}});
Ext.override(Ext.grid.column.Column,{defaultRenderer:Ext.util.Format.htmlEncode});
Ext.override(Ext.data.Model,{setDataWithAssociations:function(data){for(var i in data){if(this.fields.containsKey(i)){this.set(i,data[i]);}
if(this.associations.containsKey(i)){var store=this[i]();store.add(data[i]);}}}});
Ext.override(Ext.data.reader.Json,{getResponseData:function(response){var data;try{data=Ext.decode(response.responseText);return this.readRecords(data);}
catch(ex){error=new Ext.data.ResultSet({total:0,count:0,records:[],success:false,message:ex.message});this.fireEvent('exception',this,response,error);var exception={message:i18n("Critical Error"),detail:i18n("The server returned a response which we were not able to interpret.")};var request={response:response.responseText};PartKeepr.ExceptionWindow.showException(exception,request);return error;}}});
Ext.override(Ext.data.Connection,{setupHeaders:function(xhr,options,data,params){var session;if(!options.headers){options.headers={};}
if(PartKeepr.getApplication()!==null){session=PartKeepr.getApplication().getSession();if(session!==null){options.headers.session=session;}}
var headers=this.callOverridden(arguments);return headers;}});
Ext.override(Ext.layout.component.field.Trigger,{sizeBodyContents:function(width,height){var me=this,owner=me.owner,inputEl=owner.inputEl,triggerWrap=owner.triggerWrap,triggerWidth=owner.getTriggerWidth();if(owner.hideTrigger||owner.readOnly||triggerWidth>0){me.setElementSize(inputEl,Ext.isNumber(width)?width:width);inputEl.dom.style.paddingRight=(triggerWidth+2)+"px";triggerWrap.setWidth(triggerWidth);}}});
Ext.override(Ext.panel.Table,{scrollDelta:100});
Ext.override(Ext.selection.RowModel,{onLastFocusChanged:function(oldFocused,newFocused,supressFocus){if(this.views&&this.views.length){this.callOverridden(arguments);}},onSelectChange:function(record,isSelected,suppressEvent,commitFn){if(this.views&&this.views.length){this.callOverridden(arguments);}}});
Ext.locales={de_DE:{"flag":"de","name":"Deutsch (Deutschland)","dateformat":"d.m.Y H:i:s T"},en_US:{"flag":"us","name":"English (USA)","dateformat":"n/j/Y H:i:s T"}};Ext.setLocale=function(locale){Ext.jm_locale=locale;};Ext.getLocale=function(){return Ext.jm_locale;};Ext.getLocaleFlag=function(){return Ext.locales[Ext.jm_locale].flag;};Ext.getDateFormat=function(){return Ext.locales[Ext.jm_locale].dateformat;};
Ext.define("PartKeepr.StatisticSample",{extend:"Ext.data.Model",fields:[{name:'start',type:'date',dateFormat:'Y-m-d H:i:s'},{name:'parts',type:'int',useNull:true},{name:'categories',type:'int',useNull:true}]});
Ext.define("PartKeepr.TipOfTheDay",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'url',type:'string'},{name:'read',type:'boolean'}],proxy:PartKeepr.getRESTProxy("TipOfTheDay")});
Ext.define("PartKeepr.AbstractCategory",{extend:"Ext.data.Model",isCategory:true});
Ext.define("PartKeepr.FootprintCategory",{extend:"PartKeepr.AbstractCategory",fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'text',type:'string'},{name:'description',type:'string'},{name:'parent',type:'int'}],proxy:PartKeepr.getRESTProxy("FootprintCategory"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.PartCategory",{extend:"PartKeepr.AbstractCategory",fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'text',type:'string'},{name:'description',type:'string'},{name:'parent',type:'int'}],proxy:PartKeepr.getRESTProxy("PartCategory"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.ProjectReport",{extend:"Ext.data.Model",fields:[{name:'quantity',type:'int'},{name:'storageLocation_name',type:'string'},{name:'available',type:'int'},{name:'missing',type:'int'},{name:'distributor_order_number',type:'string'},{name:'sum_order',type:'float'},{name:'sum',type:'float'},{name:'projects',type:'string'},{name:'remarks',type:'string'}],hasMany:[{model:'PartKeepr.Part',name:'part'}],proxy:PartKeepr.getRESTProxy("ProjectReport")});
Ext.define("PartKeepr.ManufacturerICLogo",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'string'},{name:'originalFilename',type:'string'},{name:'footprint_id',type:'int'},{name:'mimetype',type:'string'},{name:'extension',type:'string'},{name:'description',type:'string'},{name:'size',type:'string'}],belongsTo:{type:'belongsTo',model:'PartKeepr.Manufacturer',primaryKey:'id',foreignKey:'manufacturer_id'},proxy:PartKeepr.getRESTProxy("ManufacturerICLogo")});
Ext.define("PartKeepr.ProjectAttachment",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'string'},{name:'originalFilename',type:'string'},{name:'project_id',type:'int'},{name:'mimetype',type:'string'},{name:'extension',type:'string'},{name:'description',type:'string'},{name:'size',type:'string'}],belongsTo:{type:'belongsTo',model:'PartKeepr.Project',primaryKey:'id',foreignKey:'project_id'},proxy:PartKeepr.getRESTProxy("ProjectAttachment")});
Ext.define("PartKeepr.Footprint",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'text',type:'string'},{name:'description',type:'string'},{name:'image_id',type:'string'},{name:'category',type:'int'}],hasMany:{model:'PartKeepr.FootprintAttachment',name:'attachments'},proxy:PartKeepr.getRESTProxy("Footprint"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.ProjectReportList",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'description',type:'string'},{name:'user_id',type:'int'},{name:'amount',type:'int',defaultValue:1}],hasMany:[{model:'PartKeepr.ProjectPart',name:'parts'},{model:'PartKeepr.ProjectAttachment',name:'attachments'}],proxy:PartKeepr.getRESTProxy("Project"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.PartManufacturer",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'part_id',type:'int'},{name:'part_name',type:'string'},{name:'manufacturer_id',type:'int'},{name:'manufacturer_name',type:'string'},{name:'partNumber',type:'string'}],belongsTo:[{type:'belongsTo',model:'PartKeepr.Part',primaryKey:'id',foreignKey:'part_id'},{type:'belongsTo',model:'PartKeepr.Manufacturer',primaryKey:'id',foreignKey:'manufacturer_id'}],proxy:PartKeepr.getRESTProxy("PartManufacturer")});
Ext.define("PartKeepr.Unit",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'symbol',type:'string'}],hasMany:{model:'PartKeepr.SiPrefix',name:'prefixes'},proxy:PartKeepr.getRESTProxy("Unit"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.StorageLocation",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'image_id',type:'string'}],proxy:PartKeepr.getRESTProxy("StorageLocation"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.Distributor",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'url',type:'string'},{name:'comment',type:'string'},{name:'address',type:'string'},{name:'phone',type:'string'},{name:'fax',type:'string'},{name:'email',type:'string'}],proxy:PartKeepr.getRESTProxy("Distributor"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.Manufacturer",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'url',type:'string'},{name:'comment',type:'string'},{name:'address',type:'string'},{name:'phone',type:'string'},{name:'fax',type:'string'},{name:'email',type:'string'}],hasMany:{model:'PartKeepr.ManufacturerICLogo',name:'iclogos'},proxy:PartKeepr.getRESTProxy("Manufacturer"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.PartUnit",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'shortName',type:'string'},{name:'default',type:'bool'}],proxy:PartKeepr.getRESTProxy("PartUnit"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.User",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'username',type:'string'},{name:'password',type:'string'}],proxy:PartKeepr.getRESTProxy("User"),getRecordName:function(){return this.get("username");}});
Ext.define("PartKeepr.ProjectPart",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'project_id',type:'int'},{name:'part_id',type:'int'},{name:'part_name',type:'string'},{name:'quantity',type:'int'},{name:'remarks',type:'string'}],belongsTo:{type:'belongsTo',model:'PartKeepr.Project',primaryKey:'id',foreignKey:'project_id'},belongsTo:{type:'belongsTo',model:'PartKeepr.Part',primaryKey:'id',foreignKey:'part_id'},proxy:PartKeepr.getRESTProxy("ProjectPart")});
Ext.define("PartKeepr.UserPreference",{extend:"Ext.data.Model",fields:[{name:'key',type:'string'},{name:'value'},{name:'user_id',type:'int'}],proxy:PartKeepr.getRESTProxy("UserPreference")});
Ext.define("PartKeepr.Message",{extend:"Ext.data.Model",fields:[{name:'message',type:'string'},{name:'severity',type:'string'},{name:'date',type:'date'}]});
Ext.define("PartKeepr.FootprintAttachment",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'string'},{name:'originalFilename',type:'string'},{name:'footprint_id',type:'int'},{name:'mimetype',type:'string'},{name:'extension',type:'string'},{name:'description',type:'string'},{name:'size',type:'string'}],belongsTo:{type:'belongsTo',model:'PartKeepr.Footprint',primaryKey:'id',foreignKey:'footprint_id'},proxy:PartKeepr.getRESTProxy("FootprintAttachment")});
Ext.define("PartKeepr.SiPrefix",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'prefix',type:'string'},{name:'symbol',type:'string'},{name:'power',type:'int'}],proxy:PartKeepr.getRESTProxy("SiPrefix")});
Ext.define("PartKeepr.SystemNotice",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'date',type:'date',dateFormat:'Y-m-d H:i:s'},{name:'title',type:'string'},{name:'description',type:'string'}],proxy:PartKeepr.getRESTProxy("SystemNotice"),getRecordName:function(){return this.get("title");}});
Ext.define("PartKeepr.Project",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'name',type:'string'},{name:'description',type:'string'},{name:'user_id',type:'int'}],hasMany:[{model:'PartKeepr.ProjectPart',name:'parts'},{model:'PartKeepr.ProjectAttachment',name:'attachments'}],proxy:PartKeepr.getRESTProxy("Project"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.StockEntry",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'username',type:'string'},{name:'user_id',type:'int'},{name:'dateTime',type:'datetime'},{name:'stockLevel',type:'int'},{name:'storageLocation_name',type:'string'},{name:'direction',type:'string'},{name:'part_name',type:'string'},{name:'price',type:'float'},{name:'comment',type:'string'}]});
Ext.define("PartKeepr.Part",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'category',type:'int'},{name:'footprint',type:'int'},{name:'storageLocation',type:'int'},{name:'partUnit',type:'int'},{name:'averagePrice',type:'float'},{name:'name',type:'string'},{name:'description',type:'string'},{name:'comment',type:'string'},{name:'status',type:'string'},{name:'stockLevel',type:'int'},{name:'minStockLevel',type:'int'},{name:'createDate',type:'datetime'},{name:'needsReview',type:'boolean'},{name:'initialStockLevel',type:'int'},{name:'initialStockLevelUser',type:'int'},{name:'initialStockLevelPrice',type:'float'},{name:'initialStockLevelPricePerItem',type:'boolean'},{name:'partUnitName',type:'string'},{name:'footprintName',type:'string'},{name:'storageLocationName',type:'string'},{name:'categoryName',type:'string'},{name:'categoryPath',type:'string'},{name:'projects',type:'string'},{name:'internalPartNumber',type:'string'},{name:'attachmentCount',type:'int'},{name:'partUnitDefault',type:'boolean',convert:function(val){if(val==="true"||val==="1"||val===true)
{return true;}
else{return false;}}}],belongsTo:[{model:'PartKeepr.StorageLocation',primaryKey:'id',foreignKey:'storageLocation'},{model:'PartKeepr.Footprint',primaryKey:'id',foreignKey:'footprint'},{model:'PartKeepr.PartCategory',primaryKey:'id',foreignKey:'category'}],hasMany:[{model:'PartKeepr.PartDistributor',name:'distributors'},{model:'PartKeepr.PartManufacturer',name:'manufacturers'},{model:'PartKeepr.PartParameter',name:'parameters'},{model:'PartKeepr.PartAttachment',name:'attachments'}],proxy:PartKeepr.getRESTProxy("Part"),getRecordName:function(){return this.get("name");}});
Ext.define("PartKeepr.PartDistributor",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'part_id',type:'int'},{name:'part_name',type:'string'},{name:'distributor_id',type:'int'},{name:'distributor_name',type:'string'},{name:'price',type:'float'},{name:'orderNumber',type:'string'},{name:'packagingUnit',type:'int'},{name:'sku',type:'string'},{name:'packagePrice',type:'float'}],belongsTo:[{type:'belongsTo',model:'PartKeepr.Part',primaryKey:'id',foreignKey:'part_id'},{type:'belongsTo',model:'PartKeepr.Distributor',primaryKey:'id',foreignKey:'distributor_id'}],proxy:PartKeepr.getRESTProxy("PartDistributor")});
Ext.define("PartKeepr.PartParameter",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'int'},{name:'part_id',type:'int'},{name:'name',type:'string'},{name:'description',type:'string'},{name:'unit_id',type:'int'},{name:'siprefix_id',type:'int'},{name:'value',type:'float'},{name:'prefixedValue'}],proxy:PartKeepr.getRESTProxy("PartParameter")});
Ext.define("PartKeepr.PartAttachment",{extend:"Ext.data.Model",fields:[{id:'id',name:'id',type:'string'},{name:'originalFilename',type:'string'},{name:'footprint_id',type:'int'},{name:'mimetype',type:'string'},{name:'image',type:'boolean'},{name:'extension',type:'string'},{name:'description',type:'string'},{name:'size',type:'string'}],belongsTo:{type:'belongsTo',model:'PartKeepr.Part',primaryKey:'id',foreignKey:'part_id'},proxy:PartKeepr.getRESTProxy("PartAttachment")});
Ext.define("PartKeepr.SystemInformationRecord",{extend:"Ext.data.Model",fields:[{name:'name',type:'string'},{name:'value',type:'string'},{name:'category',type:'string'}]});
Ext.define('Ext.ux.form.SearchField',{extend:'Ext.form.field.Trigger',alias:'widget.searchfield',trigger1Cls:Ext.baseCSSPrefix+'form-clear-trigger',trigger2Cls:Ext.baseCSSPrefix+'form-search-trigger',hasSearch:false,paramName:'query',initComponent:function(){this.callParent(arguments);this.on('specialkey',function(f,e){if(e.getKey()==e.ENTER){this.startSearch();}},this);},afterRender:function(){this.callParent();this.triggerCell.item(0).setDisplayed('none');this.doComponentLayout();},onTrigger1Click:function(){this.resetSearch();},onTrigger2Click:function(){this.startSearch();},resetSearch:function(){var me=this,store=me.store,proxy=store.getProxy(),val;if(me.hasSearch){me.setValue('');proxy.extraParams[me.paramName]='';store.currentPage=1;store.load({start:0});me.hasSearch=false;me.triggerCell.item(0).setDisplayed('none');me.doComponentLayout();}},startSearch:function(){var me=this,store=me.store,proxy=store.getProxy(),value=me.getValue();if(value.length<1){me.resetSearch();return;}
proxy.extraParams[me.paramName]=value;store.currentPage=1;store.load({start:0});me.hasSearch=true;me.triggerCell.item(0).setDisplayed('block');me.doComponentLayout();}});
Ext.define('Ext.ux.NumericField',{extend:'Ext.form.field.Number',alias:['widget.currencyField'],config:{thousandSeparator:' ',currencyAtEnd:true,currencySign:'€'},listeners:{focus:function(me,eOpts){me.inputEl.dom.value=this.getValue();}},valueToCurrency:function(value){var format=Ext.util.Format;format.currencyPrecision=this.decimalPrecision;format.thousandSeparator=this.thousandSeparator;format.currencySign=this.currencySign;format.currencyAtEnd=this.currencyAtEnd;return format.currency(value);},valueToRaw:function(value){return this.valueToCurrency(value);},processRawValue:function(value){value=this.callParent(arguments);if(isNaN(value)||value===null||value===""){return value;}
return this.parseValue(value);},getErrors:function(value){var me=this,errors=[],format=Ext.String.format,num;value=Ext.isDefined(value)?value:this.processRawValue(this.getRawValue());if(value.length<1){return errors;}
value=this.parseValue(value);if(isNaN(value)){errors.push(format(me.nanText,value));}
if(me.minValue===0&&value<0){errors.push(this.negativeText);}
else if(value<me.minValue){errors.push(format(me.minText,me.minValue));}
if(value>me.maxValue){errors.push(format(me.maxText,me.maxValue));}
return errors;},parseValue:function(value){value=String(value).replace(this.thousandSeparator,"");value=String(value).replace(this.currencySign,"");value=parseFloat(String(value).replace(this.decimalSeparator,'.'));return isNaN(value)?null:value;}});
Ext.define("PartKeepr.CurrencyField",{extend:"Ext.ux.NumericField",alias:'widget.CurrencyField',initComponent:function(){this.decimalPrecision=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.numdecimals",2);this.currencySign=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.symbol","€");this.currencyAtEnd=PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.currencySymbolAtEnd",true);if(PartKeepr.getApplication().getUserPreference("partkeepr.formatting.currency.thousandsSeparator",true)===true){this.thousandSeparator=",";}else{this.thousandSeparator="";}
this.callParent();}});
Ext.define('Ext.ux.ClearableComboBox',{extend:"Ext.form.ComboBox",alias:"widget.clearcombo",initComponent:function(){this.triggerConfig={tag:'span',cls:'x-form-twin-triggers',cn:[{tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger x-form-clear-trigger"},{tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger"}]};this.callParent();},onTrigger1Click:function()
{this.collapse();this.setValue('');this.fireEvent('cleared');},setValue:function(v){Ext.form.ClearableComboBox.superclass.setValue.call(this,v);if(this.rendered){this.triggers[0][!Ext.isEmpty(v)?'show':'hide']();}},onDestroy:function(){Ext.destroy(this.triggers);Ext.form.ClearableComboBox.superclass.onDestroy.apply(this,arguments);}});
Ext.require(['Ext.panel.*']);Ext.define('Ext.ux.SimpleIFrame',{extend:'Ext.Panel',alias:'widget.simpleiframe',src:'about:blank',loadingText:'Loading ...',initComponent:function(){this.updateHTML();this.callParent(arguments);},updateHTML:function(){this.html='<iframe id="iframe-'+this.id+'"'+' style="overflow:auto;width:100%;height:100%;"'+' frameborder="0" '+' src="'+this.src+'"'+'></iframe>';},reload:function(){this.setSrc(this.src);},reset:function(){var iframe=this.getDOM();var iframeParent=iframe.parentNode;if(iframe&&iframeParent){iframe.src='about:blank';iframe.parentNode.removeChild(iframe);}
iframe=document.createElement('iframe');iframe.frameBorder=0;iframe.src=this.src;iframe.id='iframe-'+this.id;iframe.style.overflow='auto';iframe.style.width='100%';iframe.style.height='100%';iframeParent.appendChild(iframe);},setSrc:function(src,loadingText){this.src=src;var iframe=this.getDOM();if(iframe){iframe.src=src;}},getSrc:function(){return this.src;},getDOM:function(){return document.getElementById('iframe-'+this.id);},getDocument:function(){var iframe=this.getDOM();iframe=(iframe.contentWindow)?iframe.contentWindow:(iframe.contentDocument.document)?iframe.contentDocument.document:iframe.contentDocument;return iframe.document;},destroy:function(){var iframe=this.getDOM();if(iframe&&iframe.parentNode){iframe.src='about:blank';iframe.parentNode.removeChild(iframe);}
this.callParent(arguments);},update:function(content){var doc;this.setSrc('about:blank');try{doc=this.getDocument();doc.open();doc.write(content);doc.close();}catch(err){this.reset();doc=this.getDocument();doc.open();doc.write(content);doc.close();}}});
Ext.define('Ext.ux.wizard.Header',{extend:'Ext.Component',alias:'widget.wizardheader',height:55,region:'north',title:'Wizard',steps:0,stepText:'<div class="ext-ux-wiz-Header">'+'    <div class="ext-ux-wiz-Header-title"></div>'+'    <div> '+'       <div class="ext-ux-wiz-Header-step">Step {0} of {1}: {2} </div>'+'       <div class="ext-ux-wiz-Header-stepIndicator-container"> '+'{stepIndicator}'+'       </div>'+'    </div> '+'</div>',autoEl:{tag:'div',cls:'ext-ux-wiz-Header',children:[{tag:'div',cls:'ext-ux-wiz-Header-title'},{tag:'div',children:[{tag:'div',cls:'ext-ux-wiz-Header-step'},{tag:'div',cls:'ext-ux-wiz-Header-stepIndicator-container'}]}]},titleEl:null,stepEl:null,imageContainer:null,indicators:null,stepTemplate:null,lastActiveStep:-1,updateStep:function(currentStep,title){var html=this.stepTemplate.apply({0:currentStep+1,1:this.steps,2:title,step:currentStep,steps:this.steps,title:title});this.update(html);this.lastActiveStep=currentStep;},initComponent:function(){this.autoEl.cls=this.autoEl.cls+" "+this.cls;this.callParent(arguments);},onRender:function(ct,position){var image=null;var steptxt=this.stepText.split("{stepIndicator}");var stepboxs="\n";if(steptxt.length>1){for(var i=0,len=this.steps;i<len;i++){stepboxs+='<div class=\'ext-ux-wiz-Header-stepIndicator <tpl if="step == '+i+'" >ext-ux-wiz-Header-stepIndicator-active</tpl>\'>&#160;</div>\n';}
stepboxs=('<tpl for=".">'+steptxt[0]+stepboxs+steptxt[1]+'</tpl>');if(this.region=="west"||this.region=="east"){this.stepText=stepboxs.replace(/Header/gi,"Side");}else{this.stepText=stepboxs;}}
this.stepTemplate=new Ext.XTemplate(this.stepText);this.stepTemplate.compile();this.callParent(arguments);}});
Ext.define('Ext.ux.wizard.Card',{extend:'Ext.form.Panel',cardTitle:'',cls:'ux-wiz-card',header:false,hideMode:'display',initComponent:function(){this.addEvents('beforecardhide');this.cardTitle=this.title;this.title=(this.showTitle?'<span style="'+this.titleStyle+'" class="'+this.titleCls+'" >'+this.title+'</span>':'');this.dockedItems=[{xtype:'container',xtype:'toolbar',dock:'bottom',ui:'footer',layout:{type:'hbox',align:'middle'},padding:'10 10 5',items:[{xtype:'component',errorpanel:true,baseCls:'form-error-state',flex:1,validText:this.validText,invalidText:this.invalidText||'Error/s detected. Please modify...',tipTpl:Ext.create('Ext.XTemplate','<ul><tpl for="."><li><span class="field-name">{name}</span>: <span class="error">{error}</span></li></tpl></ul>'),getTip:function(){var tip=this.tip;if(!tip){tip=this.tip=Ext.widget('tooltip',{target:this.el,title:'Error Details:',autoHide:true,anchor:'top',mouseOffset:[-11,-2],closable:true,constrainPosition:false,cls:'errors-tip'});tip.show();}
return tip;},setErrors:function(errors){var me=this,baseCls=me.baseCls,tip=me.getTip();errors=Ext.Array.from(errors);if(errors.length){me.addCls(baseCls+'-invalid');me.removeCls(baseCls+'-valid');me.update(me.invalidText);tip.setDisabled(false);tip.update(me.tipTpl.apply(errors));tip.show();}else{me.addCls(baseCls+'-valid');me.removeCls(baseCls+'-invalid');me.update(me.validText);tip.setDisabled(true);tip.hide();}}}]}];this.callParent();},isValid:function(){return!this.getForm().isDirty();},bindHandler:function(){Ext.each(this.form.items,function(f){if(!f.isValid){f.isValid=Ext.emptyFn;}});},listeners:{fieldvaliditychange:function(){this.updateErrorState();},fielderrorchange:function(){this.updateErrorState();}},updateErrorState:function(){var me=this,errorCmp,fields,errors;if(me.hasBeenDirty||me.getForm().isDirty()){errorCmp=me.down('component[errorpanel]');fields=me.getForm().getFields();errors=[];fields.each(function(field){Ext.Array.forEach(field.getErrors(),function(error){errors.push({name:field.getFieldLabel(),error:error});});});errorCmp.setErrors(errors);me.hasBeenDirty=true;}},initEvents:function(){var old=this.monitorValid;this.monitorValid=false;this.callParent();this.monitorValid=old;this.on('beforehide',this.bubbleBeforeHideEvent,this);this.on('beforecardhide',this.isValid,this);this.on('show',this.onCardShow,this);this.on('hide',this.onCardHide,this);},bubbleBeforeHideEvent:function(){var ly=this.ownerCt.layout;var activeItem=ly.activeItem;if(activeItem&&activeItem.id===this.id){return this.fireEvent('beforecardhide',this);}
return true;},onCardHide:function(){if(this.monitorValid){this.stopMonitoring();}},onCardShow:function(){if(this.monitorValid){this.startMonitoring();}},startMonitoring:function(){this.startPolling();},stopMonitoring:function(){this.stopPolling();}});
Ext.define('Ext.ux.Wizard',{extend:'Ext.window.Window',layout:'fit',loadMaskConfig:{'default':'','saving':'Saving...','checking':'Checking...'},autoRender:true,height:650,width:800,closable:true,resizable:false,modal:true,cards:[],previousButtonText:'&lt; Previous',nextButtonText:'Next &gt;',cancelButtonText:'Cancel',finishButtonText:'Finish',headConfig:null,sideConfig:null,cardPanelConfig:{},previousButton:null,nextButton:null,cancelButton:null,cardPanel:null,currentCard:0,headPanel:null,cardCount:0,initComponent:function(){var c=this.initialConfig,sregion,hregion;if(!this.sideConfig)this.sideConfig={};if(!this.headConfig)this.headConfig={};if(c.sideConfig&&c.sideConfig.position=='right'){sregion='east';}else{sregion='west';}
if(c.headConfig&&c.headConfig.position=='bottom'){hregion='south';}else{hregion='north';}
Ext.applyIf(this.cardPanelConfig,{region:'center',items:(this.cards||[{}]),layout:new Ext.ux.wizard.CardLayout(),border:false,activeItem:0,baseCls:'ux-wizard-cardpanel'});Ext.applyIf(this.sideConfig,{region:sregion,width:150,layout:'fit',xtype:'wizardheader',headerPosition:'side',steps:this.cards.length,hidden:!(c.sideConfig)});Ext.applyIf(this.headConfig,{region:hregion,height:150,layout:'fit',xtype:'wizardheader',headerPosition:'top',steps:this.cards.length,hidden:!(c.headConfig)});this.initButtons();this.initPanels();var title=this.title||this.headConfig.title;title=title||"";var items=[];items.push(this.sidePanel);items.push(this.headPanel);items.push(this.cardPanel);Ext.apply(this,{title:title,layout:'border',cardCount:this.cards.length,dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',defaults:{minWidth:60},items:[{xtype:'component',flex:1},this.previousButton,this.nextButton,this.cancelButton]}],items:items});this.addEvents('cancel','finish');this.callParent();},getWizardData:function(){var formValues={};var cards=this.cards;for(var i=0,len=cards.length;i<len;i++){if(cards[i].form){formValues[cards[i].id]=cards[i].form.getValues(false);}else{formValues[cards[i].id]={};}}
return formValues;},switchDialogState:function(enabled,type){this.showLoadMask(!enabled,type);this.previousButton.setDisabled(!enabled);this.nextButton.setDisabled(!enabled);this.cancelButton.setDisabled(!enabled);var ct=this.tools['close'];if(ct){switch(enabled){case true:this.tools['close'].unmask();break;default:this.tools['close'].mask();break;}}
this.closable=enabled;},showLoadMask:function(show,type){if(!type){type='default';}
if(show){if(this.loadMask==null){this.loadMask=new Ext.LoadMask(this.body);}
this.loadMask.msg=this.loadMaskConfig[type];this.loadMask.show();}else{if(this.loadMask){this.loadMask.hide();}}},showSidePanel:function(){this.sidePanel.show();},showHeadPanel:function(){this.headPanel.show();},showSidePanel:function(){this.sidePanel.hide();},hideHeadPanel:function(){this.headPanel.hide();},initEvents:function(){this.callParent();this.on('beforeclose',this.onBeforeClose,this);},initPanels:function(){var cards=this.cards;var cardPanelConfig=this.cardPanelConfig;Ext.apply(this.headConfig,{steps:this.cards.length});this.headPanel=Ext.create('Ext.ux.wizard.Header',this.headConfig);this.sidePanel=Ext.create('Ext.ux.wizard.Header',this.sideConfig);Ext.apply(cardPanelConfig,{layout:'card',items:cards});Ext.applyIf(cardPanelConfig,{region:'center',border:false,activeItem:0});for(var i=0,len=cards.length;i<len;i++){cards[i].on('show',this.onCardShow,this);cards[i].on('hide',this.onCardHide,this);cards[i].on('clientvalidation',this.onClientValidation,this);}
this.cardPanel=Ext.create('Ext.panel.Panel',cardPanelConfig);},initButtons:function(){this.previousButton=new Ext.Button({text:this.previousButtonText,id:'wizard-move-prev',disabled:true,minWidth:75,handler:this.onPreviousClick,scope:this});this.nextButton=new Ext.Button({text:this.nextButtonText,id:'wizard-move-next',minWidth:75,handler:this.onNextClick,scope:this});this.cancelButton=new Ext.Button({text:this.cancelButtonText,handler:this.onCancelClick,scope:this,minWidth:75});},onBeforeClose:function(panel){return this.closable;},onClientValidation:function(card,isValid){if(!isValid){this.nextButton.setDisabled(true);}else{this.nextButton.setDisabled(false);}},onCardHide:function(card){if(this.cardPanel.layout.activeItem.id===card.id){this.nextButton.setDisabled(true);}},onCardShow:function(card){var parent=card.ownerCt;var items=parent.items;for(var i=0,len=items.length;i<len;i++){if(items.get(i).id==card.id){break;}}
this.currentCard=i;this.headPanel.updateStep(i,card.carTitle);this.sidePanel.updateStep(i,card.carTitle);if(i==len-1){this.nextButton.setText(this.finishButtonText);}else{this.nextButton.setText(this.nextButtonText);}
if(card.isValid()){this.nextButton.setDisabled(false);}
if(i==0){this.previousButton.setDisabled(true);}else{this.previousButton.setDisabled(false);}},onCancelClick:function(){if(this.fireEvent('cancel',this,this.getWizardData())!==false){this.closable=true;this.close();}},onFinish:function(){if(this.fireEvent('finish',this,this.getWizardData())!==false){this.closable=true;this.close();}},onPreviousClick:function(btn){if(this.currentCard>0){var mywiz=btn.up('panel').cardPanel;this.navigate(mywiz,'prev');}},onNextClick:function(btn){if(this.currentCard==this.cardCount-1){this.onFinish();}else{var p=this.cardPanel.items.items[this.currentCard];if(p){f=p.getForm();if(f.isValid()){this.navigate(btn.up('panel').cardPanel,"next");}else{p.items.items[0].el.frame("#ff0000");}}}},navigate:function(panel,direction){var layout=panel.getLayout();layout[direction]();Ext.getCmp('wizard-move-prev').setDisabled(!layout.getPrev());},afterRender:function(){this.callParent();var ly=this.cardPanel.getLayout();}});
Ext.define('Ext.ux.wizard.CardLayout',{extend:'Ext.layout.container.Card',setActiveItem:function(item){item=this.container.getComponent(item);if(this.activeItem!=item){if(this.activeItem){this.activeItem.hide();}
if(this.activeItem&&!this.activeItem.hidden){return;}
var layout=item.doLayout&&(this.layoutOnCardChange||!item.rendered);this.activeItem=item;item.show();this.layout();if(layout){item.doLayout();}}}});
(function(){Downloadify=window.Downloadify={queue:{},uid:new Date().getTime(),getTextForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getData();return""},getFileNameForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getFilename();return""},getDataTypeForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getDataType();return""},saveComplete:function(a){var b=Downloadify.queue[a];if(b)b.complete();return true},saveCancel:function(a){var b=Downloadify.queue[a];if(b)b.cancel();return true},saveError:function(a){var b=Downloadify.queue[a];if(b)b.error();return true},addToQueue:function(a){Downloadify.queue[a.queue_name]=a},getUID:function(a){if(a.id=="")a.id='downloadify_'+Downloadify.uid++;return a.id}};Downloadify.create=function(a,b){var c=(typeof(a)=="string"?document.getElementById(a):a);return new Downloadify.Container(c,b)};Downloadify.Container=function(d,e){var f=this;f.el=d;f.enabled=true;f.dataCallback=null;f.filenameCallback=null;f.data=null;f.filename=null;var g=function(){f.options=e;if(!f.options.append)f.el.innerHTML="";f.flashContainer=document.createElement('span');f.el.appendChild(f.flashContainer);f.queue_name=Downloadify.getUID(f.flashContainer);if(typeof(f.options.filename)==="function")f.filenameCallback=f.options.filename;else if(f.options.filename)f.filename=f.options.filename;if(typeof(f.options.data)==="function")f.dataCallback=f.options.data;else if(f.options.data)f.data=f.options.data;var a={queue_name:f.queue_name,width:f.options.width,height:f.options.height};var b={allowScriptAccess:'always'};var c={id:f.flashContainer.id,name:f.flashContainer.id};if(f.options.enabled===false)f.enabled=false;if(f.options.transparent===true)b.wmode="transparent";if(f.options.downloadImage)a.downloadImage=f.options.downloadImage;swfobject.embedSWF(f.options.swf,f.flashContainer.id,f.options.width,f.options.height,"10",null,a,b,c);Downloadify.addToQueue(f)};f.enable=function(){var a=document.getElementById(f.flashContainer.id);a.setEnabled(true);f.enabled=true};f.disable=function(){var a=document.getElementById(f.flashContainer.id);a.setEnabled(false);f.enabled=false};f.getData=function(){if(!f.enabled)return"";if(f.dataCallback)return f.dataCallback();else if(f.data)return f.data;else return""};f.getFilename=function(){if(f.filenameCallback)return f.filenameCallback();else if(f.filename)return f.filename;else return""};f.getDataType=function(){if(f.options.dataType)return f.options.dataType;return"string"};f.complete=function(){if(typeof(f.options.onComplete)==="function")f.options.onComplete()};f.cancel=function(){if(typeof(f.options.onCancel)==="function")f.options.onCancel()};f.error=function(){if(typeof(f.options.onError)==="function")f.options.onError()};g()};Downloadify.defaultOptions={swf:'media/downloadify.swf',downloadImage:'images/download.png',width:100,height:30,transparent:true,append:false,dataType:"string"}})();if(typeof(jQuery)!="undefined"){(function($){$.fn.downloadify=function(b){return this.each(function(){b=$.extend({},Downloadify.defaultOptions,b);var a=Downloadify.create(this,b);$(this).data('Downloadify',a)})}})(jQuery)};if(typeof(MooTools)!='undefined'){Element.implement({downloadify:function(a){a=$merge(Downloadify.defaultOptions,a);return this.store('Downloadify',Downloadify.create(this,a))}})};
(function(){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function utf8Encode(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c);}
else if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128);}
else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128);}}
return utftext;}
Ext.define("Ext.ux.exporter.Base64",{statics:{encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=utf8Encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
keyStr.charAt(enc1)+keyStr.charAt(enc2)+
keyStr.charAt(enc3)+keyStr.charAt(enc4);}
return output;}}});})();
Ext.define("Ext.ux.exporter.Exporter",{uses:["Ext.ux.exporter.Base64","Ext.ux.exporter.Button","Ext.ux.exporter.csvFormatter.CsvFormatter","Ext.ux.exporter.wikiFormatter.WikiFormatter","Ext.ux.exporter.excelFormatter.ExcelFormatter"],statics:{exportAny:function(component,formatter,config){var func="export";if(!component.is){func=func+"Store";}else if(component.is("gridpanel")){func=func+"Grid";}else if(component.is("treepanel")){func=func+"Tree";}else{func=func+"Store";component=component.getStore();}
return this[func](component,this.getFormatterByName(formatter),config);},exportGrid:function(grid,formatter,config){config=config||{};formatter=this.getFormatterByName(formatter);var columns=Ext.Array.filter(grid.columns,function(col){return!col.hidden;});Ext.applyIf(config,{title:grid.title,columns:columns});return formatter.format(grid.store,config);},exportStore:function(store,formatter,config){config=config||{};formatter=this.getFormatterByName(formatter);Ext.applyIf(config,{columns:store.fields?store.fields.items:store.model.prototype.fields.items});return formatter.format(store,config);},exportTree:function(tree,formatter,config){config=config||{};formatter=this.getFormatterByName(formatter);var store=tree.store||config.store;Ext.applyIf(config,{title:tree.title});return formatter.format(store,config);},getFormatterByName:function(formatter){formatter=formatter?formatter:"excel";formatter=!Ext.isString(formatter)?formatter:Ext.create("Ext.ux.exporter."+formatter+"Formatter."+Ext.String.capitalize(formatter)+"Formatter");return formatter;}}});
Ext.define("Ext.ux.exporter.Button",{extend:"Ext.Component",alias:"widget.exporterbutton",html:'<p></p>',config:{swfPath:'/flash/downloadify.swf',downloadImage:'/images/ext_reports/download.png',width:62,height:22,downloadName:"download"},constructor:function(config){config=config||{};this.initConfig();Ext.ux.exporter.Button.superclass.constructor.call(this,config);var self=this;this.on("afterrender",function(){self.setComponent(self.store||self.component||self.up("gridpanel")||self.up("treepanel"),config);});},setComponent:function(component,config){this.component=component;this.store=!component.is?component:component.getStore();this.setDownloadify(config);},setDownloadify:function(config){var self=this;Downloadify.create(this.el.down('p').id,{filename:function(){return self.getDownloadName()+"."+Ext.ux.exporter.Exporter.getFormatterByName(self.formatter).extension;},data:function(){return Ext.ux.exporter.Exporter.exportAny(self.component,self.formatter,config);},transparent:false,swf:this.getSwfPath(),downloadImage:this.getDownloadImage(),width:this.getWidth(),height:this.getHeight(),transparent:true,append:false});}});
Ext.define("Ext.ux.exporter.excelFormatter.Cell",{constructor:function(config){Ext.applyIf(config,{type:"String"});Ext.apply(this,config);Ext.ux.exporter.excelFormatter.Cell.superclass.constructor.apply(this,arguments);},render:function(){return this.tpl.apply(this);},tpl:new Ext.XTemplate('<ss:Cell ss:StyleID="{style}">','<ss:Data ss:Type="{type}"><![CDATA[{value}]]></ss:Data>','</ss:Cell>')});
Ext.define("Ext.ux.exporter.excelFormatter.Style",{constructor:function(config){config=config||{};Ext.apply(this,config,{parentStyle:'',attributes:[]});Ext.ux.exporter.excelFormatter.Style.superclass.constructor.apply(this,arguments);if(this.id==undefined)throw new Error("An ID must be provided to Style");this.preparePropertyStrings();},preparePropertyStrings:function(){Ext.each(this.attributes,function(attr,index){this.attributes[index].propertiesString=this.buildPropertyString(attr);this.attributes[index].children=attr.children||[];Ext.each(attr.children,function(child,childIndex){this.attributes[index].children[childIndex].propertiesString=this.buildPropertyString(child);},this);},this);},buildPropertyString:function(attribute){var propertiesString="";Ext.each(attribute.properties||[],function(property){propertiesString+=Ext.String.format('ss:{0}="{1}" ',property.name,property.value);},this);return propertiesString;},render:function(){return this.tpl.apply(this);},tpl:new Ext.XTemplate('<tpl if="parentStyle.length == 0">','<ss:Style ss:ID="{id}">','</tpl>','<tpl if="parentStyle.length != 0">','<ss:Style ss:ID="{id}" ss:Parent="{parentStyle}">','</tpl>','<tpl for="attributes">','<tpl if="children.length == 0">','<ss:{name} {propertiesString} />','</tpl>','<tpl if="children.length > 0">','<ss:{name} {propertiesString}>','<tpl for="children">','<ss:{name} {propertiesString} />','</tpl>','</ss:{name}>','</tpl>','</tpl>','</ss:Style>')});
Ext.define("Ext.ux.exporter.excelFormatter.Workbook",{constructor:function(config){config=config||{};Ext.apply(this,config,{title:"Workbook",worksheets:[],compiledWorksheets:[],cellBorderColor:"#e4e4e4",styles:[],compiledStyles:[],hasDefaultStyle:true,hasStripeStyles:true,windowHeight:9000,windowWidth:50000,protectStructure:false,protectWindows:false});if(this.hasDefaultStyle)this.addDefaultStyle();if(this.hasStripeStyles)this.addStripedStyles();this.addTitleStyle();this.addHeaderStyle();},render:function(){this.compileStyles();this.joinedCompiledStyles=this.compiledStyles.join("");this.compileWorksheets();this.joinedWorksheets=this.compiledWorksheets.join("");return this.tpl.apply(this);},addWorksheet:function(store,config){var worksheet=new Ext.ux.exporter.excelFormatter.Worksheet(store,config);this.worksheets.push(worksheet);return worksheet;},addStyle:function(config){var style=new Ext.ux.exporter.excelFormatter.Style(config||{});this.styles.push(style);return style;},compileStyles:function(){this.compiledStyles=[];Ext.each(this.styles,function(style){this.compiledStyles.push(style.render());},this);return this.compiledStyles;},compileWorksheets:function(){this.compiledWorksheets=[];Ext.each(this.worksheets,function(worksheet){this.compiledWorksheets.push(worksheet.render());},this);return this.compiledWorksheets;},tpl:new Ext.XTemplate('<?xml version="1.0" encoding="utf-8"?>','<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:o="urn:schemas-microsoft-com:office:office">','<o:DocumentProperties>','<o:Title>{title}</o:Title>','</o:DocumentProperties>','<ss:ExcelWorkbook>','<ss:WindowHeight>{windowHeight}</ss:WindowHeight>','<ss:WindowWidth>{windowWidth}</ss:WindowWidth>','<ss:ProtectStructure>{protectStructure}</ss:ProtectStructure>','<ss:ProtectWindows>{protectWindows}</ss:ProtectWindows>','</ss:ExcelWorkbook>','<ss:Styles>','{joinedCompiledStyles}','</ss:Styles>','{joinedWorksheets}','</ss:Workbook>'),addDefaultStyle:function(){var borderProperties=[{name:"Color",value:this.cellBorderColor},{name:"Weight",value:"1"},{name:"LineStyle",value:"Continuous"}];this.addStyle({id:'Default',attributes:[{name:"Alignment",properties:[{name:"Vertical",value:"Top"},{name:"WrapText",value:"1"}]},{name:"Font",properties:[{name:"FontName",value:"arial"},{name:"Size",value:"10"}]},{name:"Interior"},{name:"NumberFormat"},{name:"Protection"},{name:"Borders",children:[{name:"Border",properties:[{name:"Position",value:"Top"}].concat(borderProperties)},{name:"Border",properties:[{name:"Position",value:"Bottom"}].concat(borderProperties)},{name:"Border",properties:[{name:"Position",value:"Left"}].concat(borderProperties)},{name:"Border",properties:[{name:"Position",value:"Right"}].concat(borderProperties)}]}]});},addTitleStyle:function(){this.addStyle({id:"title",attributes:[{name:"Borders"},{name:"Font"},{name:"NumberFormat",properties:[{name:"Format",value:"@"}]},{name:"Alignment",properties:[{name:"WrapText",value:"1"},{name:"Horizontal",value:"Center"},{name:"Vertical",value:"Center"}]}]});},addHeaderStyle:function(){this.addStyle({id:"headercell",attributes:[{name:"Font",properties:[{name:"Bold",value:"1"},{name:"Size",value:"10"}]},{name:"Interior",properties:[{name:"Pattern",value:"Solid"},{name:"Color",value:"#A3C9F1"}]},{name:"Alignment",properties:[{name:"WrapText",value:"1"},{name:"Horizontal",value:"Center"}]}]});},addStripedStyles:function(){this.addStyle({id:"even",attributes:[{name:"Interior",properties:[{name:"Pattern",value:"Solid"},{name:"Color",value:"#CCFFFF"}]}]});this.addStyle({id:"odd",attributes:[{name:"Interior",properties:[{name:"Pattern",value:"Solid"},{name:"Color",value:"#CCCCFF"}]}]});Ext.each(['even','odd'],function(parentStyle){this.addChildNumberFormatStyle(parentStyle,parentStyle+'date',"[ENG][$-409]dd\-mmm\-yyyy;@");this.addChildNumberFormatStyle(parentStyle,parentStyle+'int',"0");this.addChildNumberFormatStyle(parentStyle,parentStyle+'float',"0.00");},this);},addChildNumberFormatStyle:function(parentStyle,id,value){this.addStyle({id:id,parentStyle:"even",attributes:[{name:"NumberFormat",properties:[{name:"Format",value:value}]}]});}});
Ext.define("Ext.ux.exporter.excelFormatter.Worksheet",{constructor:function(store,config){config=config||{};this.store=store;Ext.applyIf(config,{hasTitle:true,hasHeadings:true,stripeRows:true,title:"Workbook",columns:store.fields==undefined?{}:store.fields.items});Ext.apply(this,config);Ext.ux.exporter.excelFormatter.Worksheet.superclass.constructor.apply(this,arguments);},dateFormatString:"Y-m-d",worksheetTpl:new Ext.XTemplate('<ss:Worksheet ss:Name="{title}">','<ss:Names>','<ss:NamedRange ss:Name="Print_Titles" ss:RefersTo="=\'{title}\'!R1:R2" />','</ss:Names>','<ss:Table x:FullRows="1" x:FullColumns="1" ss:ExpandedColumnCount="{colCount}" ss:ExpandedRowCount="{rowCount}">','{columns}','<ss:Row ss:Height="38">','<ss:Cell ss:StyleID="title" ss:MergeAcross="{colCount - 1}">','<ss:Data xmlns:html="http://www.w3.org/TR/REC-html40" ss:Type="String">','<html:B><html:U><html:Font html:Size="15">{title}','</html:Font></html:U></html:B></ss:Data><ss:NamedCell ss:Name="Print_Titles" />','</ss:Cell>','</ss:Row>','<ss:Row ss:AutoFitHeight="1">','{header}','</ss:Row>','{rows}','</ss:Table>','<x:WorksheetOptions>','<x:PageSetup>','<x:Layout x:CenterHorizontal="1" x:Orientation="Landscape" />','<x:Footer x:Data="Page &amp;P of &amp;N" x:Margin="0.5" />','<x:PageMargins x:Top="0.5" x:Right="0.5" x:Left="0.5" x:Bottom="0.8" />','</x:PageSetup>','<x:FitToPage />','<x:Print>','<x:PrintErrors>Blank</x:PrintErrors>','<x:FitWidth>1</x:FitWidth>','<x:FitHeight>32767</x:FitHeight>','<x:ValidPrinterInfo />','<x:VerticalResolution>600</x:VerticalResolution>','</x:Print>','<x:Selected />','<x:DoNotDisplayGridlines />','<x:ProtectObjects>False</x:ProtectObjects>','<x:ProtectScenarios>False</x:ProtectScenarios>','</x:WorksheetOptions>','</ss:Worksheet>'),render:function(store){return this.worksheetTpl.apply({header:this.buildHeader(),columns:this.buildColumns().join(""),rows:this.buildRows().join(""),colCount:this.columns.length,rowCount:this.store.getCount()+2,title:this.title});},buildColumns:function(){var cols=[];Ext.each(this.columns,function(column){cols.push(this.buildColumn());},this);return cols;},buildColumn:function(width){return Ext.String.format('<ss:Column ss:AutoFitWidth="1" ss:Width="{0}" />',width||164);},buildRows:function(){var rows=[];this.store.each(function(record,index){rows.push(this.buildRow(record,index));},this);return rows;},buildHeader:function(){var cells=[];Ext.each(this.columns,function(col){var title;if(col.text!=undefined){title=col.text;}else if(col.name){title=col.name.replace(/_/g," ");title=Ext.String.capitalize(title);}
cells.push(Ext.String.format('<ss:Cell ss:StyleID="headercell"><ss:Data ss:Type="String">{0}</ss:Data><ss:NamedCell ss:Name="Print_Titles" /></ss:Cell>',title));},this);return cells.join("");},buildRow:function(record,index){var style,cells=[];if(this.stripeRows===true)style=index%2==0?'even':'odd';Ext.each(this.columns,function(col){var name=col.name||col.dataIndex;if(typeof name!=='undefined'){if(Ext.isFunction(col.renderer)){var value=col.renderer(record.get(name),null,record),type="String";}else{var value=record.get(name),type=this.typeMappings[col.type||record.fields.get(name).type.type];}
cells.push(this.buildCell(value,type,style).render());}},this);return Ext.String.format("<ss:Row>{0}</ss:Row>",cells.join(""));},buildCell:function(value,type,style){if(type=="DateTime"&&Ext.isFunction(value.format))value=value.format(this.dateFormatString);return new Ext.ux.exporter.excelFormatter.Cell({value:value,type:type,style:style});},typeMappings:{'int':"Number",'string':"String",'float':"Number",'date':"DateTime"}});
Ext.define("Ext.ux.exporter.Formatter",{format:Ext.emptyFn,constructor:function(config){config=config||{};Ext.applyIf(config,{});}});
Ext.define("Ext.ux.exporter.csvFormatter.CsvFormatter",{extend:"Ext.ux.exporter.Formatter",contentType:'data:text/csv;base64,',separator:";",extension:"csv",lineSeparator:"\n",capitalizeHeaders:false,format:function(store,config){this.columns=config.columns||(store.fields?store.fields.items:store.model.prototype.fields.items);return this.getHeaders()+this.lineSeparator+this.getRows(store);},getHeaders:function(store){var columns=[];Ext.each(this.columns,function(col){var title;if(col.text!=undefined){title=col.text;}else if(col.name){title=col.name.replace(/_/g," ");}else{title="";}
if(this.capitalizeHeaders){title=Ext.String.capitalize(title);}
columns.push(title);},this);return columns.join(this.separator);},getRows:function(store){var rows=[];store.each(function(record){rows.push(this.getCells(record));},this);return rows.join(this.lineSeparator);},getCells:function(record){var cells=[];Ext.each(this.columns,function(col){var name=col.name||col.dataIndex;var value="";if(typeof name!=='undefined'){if(Ext.isFunction(col.renderer)){value=col.renderer(record.get(name),null,record);}else{value=record.get(name);}
value='"'+value+'"';cells.push(value);}});return cells.join(this.separator);}});
Ext.define("Ext.ux.exporter.excelFormatter.ExcelFormatter",{extend:"Ext.ux.exporter.Formatter",uses:["Ext.ux.exporter.excelFormatter.Cell","Ext.ux.exporter.excelFormatter.Style","Ext.ux.exporter.excelFormatter.Worksheet","Ext.ux.exporter.excelFormatter.Workbook"],contentType:'data:application/vnd.ms-excel;base64,',extension:"xls",format:function(store,config){var workbook=new Ext.ux.exporter.excelFormatter.Workbook(config);workbook.addWorksheet(store,config||{});return workbook.render();}});
Ext.define("Ext.ux.exporter.wikiFormatter.WikiFormatter",{extend:"Ext.ux.exporter.Formatter",contentType:'data:text/plain;base64,',cls:"wikitable",extension:"txt",lineSeparator:"\n",capitalizeHeaders:false,format:function(store,config){this.columns=config.columns||(store.fields?store.fields.items:store.model.prototype.fields.items);return"{|"+this.getHeaders()+this.lineSeparator+
this.getRows(store)+this.lineSeparator+"|}";},getHeaders:function(store){var columns=[];Ext.each(this.columns,function(col){var title;if(col.text!=undefined){title=col.text;}else if(col.name){title=col.name.replace(/_/g," ");}else{title="";}
if(this.capitalizeHeaders){title=Ext.String.capitalize(title);}
columns.push("! "+title);},this);var retVal=' class="'+this.cls+'" valign="top"'+this.lineSeparator;retVal+=columns.join(this.lineSeparator);return retVal;},getRows:function(store){var rows=[];store.each(function(record){rows.push("|-"+this.lineSeparator+this.getCells(record));},this);return rows.join(this.lineSeparator);},getCells:function(record){var cells=[];Ext.each(this.columns,function(col){var name=col.name||col.dataIndex;var value="";if(typeof name!=='undefined'){if(Ext.isFunction(col.renderer)){value=col.renderer(record.get(name),null,record);}else{value=record.get(name);}
cells.push("| "+value);}});return cells.join(this.lineSeparator);}});
Ext.define('Ext.ux.statusbar.ValidationStatus',{extend:'Ext.Component',requires:['Ext.util.MixedCollection'],errorIconCls:'x-status-error',errorListCls:'x-status-error-list',validIconCls:'x-status-valid',showText:'The form has errors (click for details...)',hideText:'Click again to hide the error list',submitText:'Saving...',init:function(sb){sb.on('render',function(){this.statusBar=sb;this.monitor=true;this.errors=Ext.create('Ext.util.MixedCollection');this.listAlign=(sb.statusAlign==='right'?'br-tr?':'bl-tl?');if(this.form){this.formPanel=Ext.getCmp(this.form);this.basicForm=this.formPanel.getForm();this.startMonitoring();this.basicForm.on('beforeaction',function(f,action){if(action.type==='submit'){this.monitor=false;}},this);var startMonitor=function(){this.monitor=true;};this.basicForm.on('actioncomplete',startMonitor,this);this.basicForm.on('actionfailed',startMonitor,this);}},this,{single:true});sb.on({scope:this,afterlayout:{single:true,fn:function(){sb.statusEl.getEl().on('click',this.onStatusClick,this,{buffer:200});}},beforedestroy:{single:true,fn:this.onDestroy}});},startMonitoring:function(){this.basicForm.getFields().each(function(f){f.on('validitychange',this.onFieldValidation,this);},this);},stopMonitoring:function(){this.basicForm.getFields().each(function(f){f.un('validitychange',this.onFieldValidation,this);},this);},onDestroy:function(){this.stopMonitoring();this.statusBar.statusEl.un('click',this.onStatusClick,this);this.callParent(arguments);},onFieldValidation:function(f,isValid){if(!this.monitor){return false;}
var msg=f.getErrors()[0];if(msg){this.errors.add(f.id,{field:f,msg:msg});}else{this.errors.removeAtKey(f.id);}
this.updateErrorList();if(this.errors.getCount()>0){if(this.statusBar.getText()!==this.showText){this.statusBar.setStatus({text:this.showText,iconCls:this.errorIconCls});}}else{this.statusBar.clearStatus().setIcon(this.validIconCls);}},updateErrorList:function(){if(this.errors.getCount()>0){var msg='<ul>';this.errors.each(function(err){msg+=('<li id="x-err-'+err.field.id+'"><a href="#">'+err.msg+'</a></li>');},this);this.getMsgEl().update(msg+'</ul>');}else{this.getMsgEl().update('');}
this.getMsgEl().setSize('auto','auto');},getMsgEl:function(){if(!this.msgEl){this.msgEl=Ext.DomHelper.append(Ext.getBody(),{cls:this.errorListCls},true);this.msgEl.hide();this.msgEl.on('click',function(e){var t=e.getTarget('li',10,true);if(t){Ext.getCmp(t.id.split('x-err-')[1]).focus();this.hideErrors();}},this,{stopEvent:true});}
return this.msgEl;},showErrors:function(){this.updateErrorList();this.getMsgEl().alignTo(this.statusBar.getEl(),this.listAlign).slideIn('b',{duration:300,easing:'easeOut'});this.statusBar.setText(this.hideText);this.formPanel.el.on('click',this.hideErrors,this,{single:true});},hideErrors:function(){var el=this.getMsgEl();if(el.isVisible()){el.slideOut('b',{duration:300,easing:'easeIn'});this.statusBar.setText(this.showText);}
this.formPanel.el.un('click',this.hideErrors,this);},onStatusClick:function(){if(this.getMsgEl().isVisible()){this.hideErrors();}else if(this.errors.getCount()>0){this.showErrors();}}});
Ext.define('Ext.ux.statusbar.StatusBar',{extend:'Ext.toolbar.Toolbar',alternateClassName:'Ext.ux.StatusBar',alias:'widget.statusbar',requires:['Ext.toolbar.TextItem'],cls:'x-statusbar',busyIconCls:'x-status-busy',busyText:'Loading...',autoClear:5000,emptyText:'&#160;',activeThreadId:0,initComponent:function(){var right=this.statusAlign==='right';this.callParent(arguments);this.currIconCls=this.iconCls||this.defaultIconCls;this.statusEl=Ext.create('Ext.toolbar.TextItem',{cls:'x-status-text '+(this.currIconCls||''),text:this.text||this.defaultText||''});if(right){this.cls+=' x-status-right';this.add('->');this.add(this.statusEl);}else{this.insert(0,this.statusEl);this.insert(1,'->');}},setStatus:function(o){var me=this;o=o||{};Ext.suspendLayouts();if(Ext.isString(o)){o={text:o};}
if(o.text!==undefined){me.setText(o.text);}
if(o.iconCls!==undefined){me.setIcon(o.iconCls);}
if(o.clear){var c=o.clear,wait=me.autoClear,defaults={useDefaults:true,anim:true};if(Ext.isObject(c)){c=Ext.applyIf(c,defaults);if(c.wait){wait=c.wait;}}else if(Ext.isNumber(c)){wait=c;c=defaults;}else if(Ext.isBoolean(c)){c=defaults;}
c.threadId=this.activeThreadId;Ext.defer(me.clearStatus,wait,me,[c]);}
Ext.resumeLayouts(true);return me;},clearStatus:function(o){o=o||{};var me=this,statusEl=me.statusEl;if(o.threadId&&o.threadId!==me.activeThreadId){return me;}
var text=o.useDefaults?me.defaultText:me.emptyText,iconCls=o.useDefaults?(me.defaultIconCls?me.defaultIconCls:''):'';if(o.anim){statusEl.el.puff({remove:false,useDisplay:true,callback:function(){statusEl.el.show();me.setStatus({text:text,iconCls:iconCls});}});}else{me.setStatus({text:text,iconCls:iconCls});}
return me;},setText:function(text){var me=this;me.activeThreadId++;me.text=text||'';if(me.rendered){me.statusEl.setText(me.text);}
return me;},getText:function(){return this.text;},setIcon:function(cls){var me=this;me.activeThreadId++;cls=cls||'';if(me.rendered){if(me.currIconCls){me.statusEl.removeCls(me.currIconCls);me.currIconCls=null;}
if(cls.length>0){me.statusEl.addCls(cls);me.currIconCls=cls;}}else{me.currIconCls=cls;}
return me;},showBusy:function(o){if(Ext.isString(o)){o={text:o};}
o=Ext.applyIf(o||{},{text:this.busyText,iconCls:this.busyIconCls});return this.setStatus(o);}});
Ext.define('PartKeepr.Statusbar',{extend:'Ext.ux.statusbar.StatusBar',defaultText:i18n("Ready."),defaultIconCls:'x-status-valid',iconCls:'x-status-valid',autoClear:3000,initComponent:function(){this.connectionButton=new PartKeepr.ConnectionButton();this.connectionButton.on("click",this.onConnectionButtonClick,this);this.timeDisplay=Ext.create("PartKeepr.TimeDisplay");this.currentUserDisplay=Ext.create("Ext.toolbar.TextItem");this.currentUserDisplay.setText(i18n("Not logged in"));this.showMessageLog=Ext.create("Ext.Button",{icon:'resources/silkicons/application_osx_terminal.png',cls:'x-btn-icon',handler:function(){PartKeepr.getApplication().toggleMessageLog();}});this.systemNoticeButton=Ext.create("PartKeepr.SystemNoticeButton",{hidden:true});Ext.apply(this,{items:[this.currentUserDisplay,{xtype:'tbseparator'},this.timeDisplay,{xtype:'tbseparator'},this.showMessageLog,{xtype:'tbseparator'},this.connectionButton,this.systemNoticeButton]});this.callParent();},getConnectionButton:function(){return this.connectionButton;},setCurrentUser:function(username){this.currentUserDisplay.setText(i18n("Logged in as")+": "+username);},startLoad:function(message){if(message!==null){this.showBusy({text:message,iconCls:"x-status-busy"});}else{this.showBusy();}},endLoad:function(){this.clearStatus({useDefaults:true});},onConnectionButtonClick:function(){if(PartKeepr.getApplication().getSession()){PartKeepr.getApplication().logout();}else{PartKeepr.getApplication().getSessionManager().login();}}});